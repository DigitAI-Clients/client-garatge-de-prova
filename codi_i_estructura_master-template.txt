ESTRUCTURA DEL PROJECTE (./src)

‚îú‚îÄ‚îÄ app
‚îÇ   ‚îú‚îÄ‚îÄ api
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ chat
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ route.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ webhooks
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ stripe
‚îÇ   ‚îÇ           ‚îî‚îÄ‚îÄ route.ts
‚îÇ   ‚îú‚îÄ‚îÄ favicon.ico
‚îÇ   ‚îú‚îÄ‚îÄ globals.css
‚îÇ   ‚îú‚îÄ‚îÄ sitemap.ts
‚îÇ   ‚îî‚îÄ‚îÄ [locale]
‚îÇ       ‚îú‚îÄ‚îÄ (app)
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ blog-manager
‚îÇ       ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ new
‚îÇ       ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx
‚îÇ       ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ booking
‚îÇ       ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ dashboard
‚îÇ       ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ layout.tsx
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ my-account
‚îÇ       ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ orders
‚îÇ       ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ products
‚îÇ       ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ new
‚îÇ       ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx
‚îÇ       ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ services
‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ new
‚îÇ       ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx
‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ page.tsx
‚îÇ       ‚îú‚îÄ‚îÄ (public)
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ auth
‚îÇ       ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ login
‚îÇ       ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx
‚îÇ       ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ register
‚îÇ       ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ page.tsx
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ blog
‚îÇ       ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ page.tsx
‚îÇ       ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ [slug]
‚îÇ       ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ page.tsx
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ book
‚îÇ       ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ checkout
‚îÇ       ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ success
‚îÇ       ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ page.tsx
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ inventory
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ layout.tsx
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ page.tsx
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ shop
‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ page.tsx
‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ [slug]
‚îÇ       ‚îÇ           ‚îî‚îÄ‚îÄ page.tsx
‚îÇ       ‚îî‚îÄ‚îÄ layout.tsx
‚îú‚îÄ‚îÄ components
‚îÇ   ‚îú‚îÄ‚îÄ icons
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ flags.tsx
‚îÇ   ‚îú‚îÄ‚îÄ layout
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ app-mobile-bar.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ footer.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ navbar.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ public-mobil-bar.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ SiteLogo.tsx
‚îÇ   ‚îú‚îÄ‚îÄ modules
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ai
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ chat-widget.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ __tests__
‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ ChatWidget.test.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ blog
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ post-form.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ booking
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ BookingWidget.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ServiceFormBuilder.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ steps
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ BookingForm.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ DateTimeSelector.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ServiceList.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ __tests__
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ BookingForm.test.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ DateTimeSelector.test.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ ServiceList.test.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ __tests__
‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ BookingWidgeet.test.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ dashboard
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ admin-sidebar.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ user-sidebar.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ecommerce
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ cart-drawer.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ product-actions.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ product-card.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ product-gallery.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ product-grid.tsx
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ __tests__
‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ CardDrawer.test.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ inventory
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ landing
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ service-card.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ marketing
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ about-section.tsx
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ contact-section.tsx
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ cta-section.tsx
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ faq-section.tsx
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ featured-products-section.tsx
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ hero-section.tsx
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ map-section.tsx
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ services-section.tsx
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ stats-section.tsx
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ testimonials-section.tsx
‚îÇ   ‚îú‚îÄ‚îÄ providers
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ theme-injector.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ theme-provider.tsx
‚îÇ   ‚îî‚îÄ‚îÄ ui
‚îÇ       ‚îú‚îÄ‚îÄ button.tsx
‚îÇ       ‚îú‚îÄ‚îÄ lang-switcher.tsx
‚îÇ       ‚îî‚îÄ‚îÄ theme-toggle.tsx
‚îú‚îÄ‚îÄ config
‚îÇ   ‚îî‚îÄ‚îÄ digitai.config.ts
‚îú‚îÄ‚îÄ features
‚îÇ   ‚îú‚îÄ‚îÄ auth
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ actions.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ __tests__
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ actions.test.ts
‚îÇ   ‚îú‚îÄ‚îÄ blog
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ actions.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ __tests__
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ actions.test.ts
‚îÇ   ‚îú‚îÄ‚îÄ booking
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ actions.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ __tests__
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ actions.test.ts
‚îÇ   ‚îú‚îÄ‚îÄ contact
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ actions.ts
‚îÇ   ‚îú‚îÄ‚îÄ ecommerce
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ actions.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ __tests__
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ actions.test.ts
‚îÇ   ‚îî‚îÄ‚îÄ marketing
‚îú‚îÄ‚îÄ i18n
‚îÇ   ‚îî‚îÄ‚îÄ request.ts
‚îú‚îÄ‚îÄ lib
‚îÇ   ‚îú‚îÄ‚îÄ auth
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ guards.ts
‚îÇ   ‚îú‚îÄ‚îÄ email
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ adapters
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ResendAdapter.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ email-service.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ EmailAdapter.ts
‚îÇ   ‚îú‚îÄ‚îÄ payment
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ stripe-gateway.ts
‚îÇ   ‚îú‚îÄ‚îÄ store
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ cart-store.ts
‚îÇ   ‚îú‚îÄ‚îÄ supabase
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ client.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ server.ts
‚îÇ   ‚îú‚îÄ‚îÄ theme-utils.ts
‚îÇ   ‚îî‚îÄ‚îÄ utils.ts
‚îú‚îÄ‚îÄ messages
‚îÇ   ‚îú‚îÄ‚îÄ ca.json
‚îÇ   ‚îú‚îÄ‚îÄ en.json
‚îÇ   ‚îî‚îÄ‚îÄ es.json
‚îú‚îÄ‚îÄ proxy.ts
‚îú‚îÄ‚îÄ repositories
‚îÇ   ‚îú‚îÄ‚îÄ interfaces
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ IAuthRepository.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ IBookingRepository.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ IContentRepository.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ IPaymentGateway.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ IPostRepository.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ IProductRepository.ts
‚îÇ   ‚îú‚îÄ‚îÄ static
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ StaticContentRepository.ts
‚îÇ   ‚îî‚îÄ‚îÄ supabase
‚îÇ       ‚îú‚îÄ‚îÄ SupabaseAuthRepository.ts
‚îÇ       ‚îú‚îÄ‚îÄ SupabaseBookingRepository.ts
‚îÇ       ‚îú‚îÄ‚îÄ SupabaseEcommerceRepository.ts
‚îÇ       ‚îî‚îÄ‚îÄ SupabasePostRepository.ts
‚îú‚îÄ‚îÄ services
‚îÇ   ‚îú‚îÄ‚îÄ AIService.ts
‚îÇ   ‚îú‚îÄ‚îÄ AuthService.ts
‚îÇ   ‚îú‚îÄ‚îÄ BookingService.ts
‚îÇ   ‚îú‚îÄ‚îÄ container.ts
‚îÇ   ‚îú‚îÄ‚îÄ EcommerceService.ts
‚îÇ   ‚îú‚îÄ‚îÄ MarketingService.ts
‚îÇ   ‚îú‚îÄ‚îÄ PostService.ts
‚îÇ   ‚îî‚îÄ‚îÄ __tests__
‚îÇ       ‚îú‚îÄ‚îÄ ai.service.test.ts
‚îÇ       ‚îú‚îÄ‚îÄ booking.service.test.ts
‚îÇ       ‚îî‚îÄ‚îÄ cart.service.test.ts
‚îú‚îÄ‚îÄ test
‚îÇ   ‚îú‚îÄ‚îÄ mocks
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ supabase.ts
‚îÇ   ‚îî‚îÄ‚îÄ setup.ts
‚îî‚îÄ‚îÄ types
    ‚îú‚îÄ‚îÄ ActionResult.ts
    ‚îú‚îÄ‚îÄ config.ts
    ‚îú‚îÄ‚îÄ database.types.ts
    ‚îî‚îÄ‚îÄ models.ts


CONTINGUT DELS FITXERS


// =================== FILE: src/app/api/chat/route.ts ===================

import { aiService } from "@/services/container";
import { NextResponse } from "next/server";

export async function POST(req: Request) {
  try {
    const { messages } = await req.json();

    // Validaci√≥ b√†sica
    if (!messages || !Array.isArray(messages) || messages.length === 0) {
      return NextResponse.json({ error: "Format de missatges incorrecte" }, { status: 400 });
    }

    // Separem l'√∫ltim missatge de l'hist√≤ric
    const lastMessage = messages[messages.length - 1].content;
    const history = messages.slice(0, -1); // Tot menys l'√∫ltim

    // Cridem al servei
    const responseContent = await aiService.generateChatResponse(history, lastMessage);

    return NextResponse.json({ role: 'assistant', content: responseContent });

  } catch (error) {
    console.error("API Route Error:", error);
    return NextResponse.json({ error: "Error intern del servidor" }, { status: 500 });
  }
}

// =================== FILE: src/app/api/webhooks/stripe/route.ts ===================

import { headers } from 'next/headers';
import { NextResponse } from 'next/server';
import { StripeGateway } from '@/lib/payment/stripe-gateway';
import { createAdminClient } from '@/lib/supabase/server';
import { EmailService } from '@/lib/email/email-service';
import Stripe from 'stripe';

const gateway = new StripeGateway();

export async function POST(req: Request) {
  const body = await req.text();
  const signature = (await headers()).get('Stripe-Signature');

  if (!signature) {
    return NextResponse.json({ error: "Missing Stripe Signature" }, { status: 400 });
  }

  let event: Stripe.Event;

  try {
    event = await gateway.verifyWebhook(signature, body);
  } catch (err: unknown) {
    let errorMessage = "Webhook verification failed";
    if (err instanceof Error) errorMessage = err.message;
    console.error(`‚ö†Ô∏è Webhook Error: ${errorMessage}`);
    return NextResponse.json({ error: errorMessage }, { status: 400 });
  }

  // LOGICA DE NEGOCI
  if (event.type === 'checkout.session.completed') {
    const session = event.data.object as Stripe.Checkout.Session;
    const orderId = session.metadata?.orderId;
    const paymentIntentId = typeof session.payment_intent === 'string'
      ? session.payment_intent
      : session.payment_intent?.id;

    if (orderId && paymentIntentId) {
      console.log(`üí∞ Pagament rebut per comanda: ${orderId}`);

      const supabaseAdmin = createAdminClient();

      // 1. Marcar comanda com PAGADA
      const { error: updateError } = await supabaseAdmin
        .from('orders')
        .update({
          status: 'paid',
          payment_id: paymentIntentId
        })
        .eq('id', orderId);

      if (updateError) {
        console.error('‚ùå Error actualitzant comanda:', updateError);
        return NextResponse.json({ error: "DB Error" }, { status: 500 });
      }

      // 2. üëá NOVA L√íGICA: RESTAR ESTOC
      // Primer recuperem els items de la comanda
      const { data: items } = await supabaseAdmin
        .from('order_items')
        .select('product_id, quantity')
        .eq('order_id', orderId);

      if (items) {
        for (const item of items) {
          // Cridem a una funci√≥ RPC (Stored Procedure) per restar de forma at√≤mica
          // O, per ara (MVP), fem una resta directa (menys segur en concurr√®ncia per√≤ funciona)
          if (item.product_id) {
            await supabaseAdmin.rpc('decrement_stock', {
              p_product_id: item.product_id,
              p_quantity: item.quantity
            });
          }
        }
        console.log("üì¶ Estoc actualitzat correctament.");
      }
      // 1. Recuperem detalls de la comanda
      const { data: orderDetails } = await supabaseAdmin
        .from('orders')
        .select('*, order_items(*)')
        .eq('id', orderId)
        .single();

      if (session.customer_details?.email && orderDetails) {

        // üëá DEFINIM EL TIPUS ESPERAT DE LA BASE DE DADES
        interface DbOrderItem {
          quantity: number;
          product_name: string;
          unit_price: number;
        }

        // üëá FEM EL CASTING SEGUR (unknown -> Tipus Correcte)
        // Li diem a TS: "Confia que aix√≤ √©s un array de DbOrderItem"
        const rawItems = orderDetails.order_items as unknown as DbOrderItem[];

        const emailItems = rawItems.map((item) => ({
          quantity: item.quantity,
          name: item.product_name,
          price: item.unit_price
        }));

        await EmailService.sendOrderConfirmation(
          session.customer_details.email,
          orderId,
          session.amount_total ? session.amount_total / 100 : 0,
          emailItems
        );
        console.log("üìß Email de confirmaci√≥ enviat.");
      }
    }
  }

  return NextResponse.json({ received: true });
}

// =================== FILE: src/app/globals.css ===================

@import "tailwindcss";

/* 1. CONNEXI√ì TAILWIND <-> VARIABLES CSS */
@theme inline {
  /* Colors Base Sem√†ntics */
  --color-background: hsl(var(--background));
  --color-foreground: hsl(var(--foreground));
  
  --color-card: hsl(var(--card));
  --color-card-foreground: hsl(var(--card-foreground));
  
  --color-popover: hsl(var(--popover));
  --color-popover-foreground: hsl(var(--popover-foreground));
  
  --color-muted: hsl(var(--muted));
  --color-muted-foreground: hsl(var(--muted-foreground));
  
  --color-accent: hsl(var(--accent));
  --color-accent-foreground: hsl(var(--accent-foreground));
  
  --color-destructive: hsl(var(--destructive));
  --color-destructive-foreground: hsl(var(--destructive-foreground));
  
  --color-border: hsl(var(--border));
  --color-input: hsl(var(--input));
  --color-ring: hsl(var(--ring));

  /* Colors de Marca */
  --color-primary: hsl(var(--primary));
  --color-primary-foreground: hsl(var(--primary-foreground));
  
  --color-secondary: hsl(var(--secondary));
  --color-secondary-foreground: hsl(var(--secondary-foreground));

  /* Paleta Num√®rica (Generada pel ThemeUtils) */
  --color-primary-50: hsl(var(--primary-50));
  --color-primary-100: hsl(var(--primary-100));
  --color-primary-200: hsl(var(--primary-200));
  --color-primary-300: hsl(var(--primary-300));
  --color-primary-400: hsl(var(--primary-400));
  --color-primary-500: hsl(var(--primary-500));
  --color-primary-600: hsl(var(--primary-600));
  --color-primary-700: hsl(var(--primary-700));
  --color-primary-800: hsl(var(--primary-800));
  --color-primary-900: hsl(var(--primary-900));
  --color-primary-950: hsl(var(--primary-950));

  /* Radis */
  --radius-lg: var(--radius);
  --radius-md: calc(var(--radius) - 2px);
  --radius-sm: calc(var(--radius) - 4px);
}

/* 2. ESTILS BASE */
@layer base {
  * {
    @apply border-border; /* Totes les vores usen el color 'border' autom√†ticament */
  }
  body {
    @apply bg-background text-foreground antialiased transition-colors duration-300;
  }
  /* Estilitzaci√≥ autom√†tica de t√≠tols (opcional per√≤ recomanable) */
  h1, h2, h3, h4, h5, h6 {
    @apply text-foreground tracking-tight font-bold;
  }
}

// =================== FILE: src/app/sitemap.ts ===================

import { MetadataRoute } from 'next';
import { getProductsAction } from '@/features/ecommerce/actions';

// üõ†Ô∏è SOLUCI√ì MESTRA: Forcem mode din√†mic
// Aix√≤ evita que el build exploti per culpa de les cookies de Supabase
export const dynamic = 'force-dynamic';

const BASE_URL = process.env.NEXT_PUBLIC_APP_URL || 'https://la-teva-web.com';

export default async function sitemap(): Promise<MetadataRoute.Sitemap> {
  // 1. P√†gines Est√†tiques (Hardcoded o del Config)
  const staticRoutes = [
    '',
    '/services',
    '/shop',
    '/book',
    '/auth/login'
  ].map(route => ({
    url: `${BASE_URL}${route}`,
    lastModified: new Date(),
    changeFrequency: 'daily' as const,
    priority: 1,
  }));

  try {
    // 2. Productes Din√†mics
    // Ara podem cridar l'acci√≥ tranquil¬∑lament
    const products = await getProductsAction();
    
    // Si l'acci√≥ retorna null o falla, gestionem l'error per no trencar el sitemap
    const productList = Array.isArray(products) ? products : [];

    const productRoutes = productList.map(product => ({
      url: `${BASE_URL}/shop/${product.slug}`,
      lastModified: new Date(), // O product.created_at si ho tens
      changeFrequency: 'weekly' as const,
      priority: 0.8,
    }));

    return [...staticRoutes, ...productRoutes];

  } catch (error) {
    console.error("‚ö†Ô∏è Error generant sitemap de productes:", error);
    // En cas d'error (ex: DB caiguda), retornem almenys les est√†tiques
    return staticRoutes;
  }
}

// =================== FILE: src/app/[locale]/(app)/blog-manager/new/page.tsx ===================

import { CreatePostForm } from '@/components/modules/blog/post-form';
import { ArrowLeft } from 'lucide-react';
import Link from 'next/link';

export default async function NewPostPage({ params }: { params: Promise<{ locale: string }> }) {
  const { locale } = await params;

  return (
    <div className="max-w-3xl mx-auto">
      <Link href={`/${locale}/blog-manager`} className="flex items-center text-sm text-muted-foreground hover:text-foreground mb-6">
        <ArrowLeft className="w-4 h-4 mr-2" /> Tornar
      </Link>

      <div className="bg-background border border-border rounded-xl p-8 shadow-sm">
        <h1 className="text-2xl font-bold mb-6 text-foreground">Escriure nou article</h1>
        {/* Renderitzem el component client */}
        <CreatePostForm />
      </div>
    </div>
  );
}

// =================== FILE: src/app/[locale]/(app)/blog-manager/page.tsx ===================

import Link from 'next/link';
import { getPostsAction, deletePostAction } from '@/features/blog/actions';
import { Plus, Trash2, Eye } from 'lucide-react';

export default async function BlogDashboard({ params }: { params: Promise<{ locale: string }> }) {
  const { locale } = await params;
  const posts = await getPostsAction();

  return (
    <div className="space-y-6">
      <div className="flex justify-between items-center">
        <h1 className="text-3xl font-bold text-foreground">Gesti√≥ del Blog</h1>
        <Link href={`/${locale}/blog-manager/new`}>
          <button className="flex items-center gap-2 bg-primary text-primary-foreground px-4 py-2 rounded-lg font-medium hover:opacity-90">
            <Plus className="w-4 h-4" /> Nou Article
          </button>
        </Link>
      </div>

      <div className="bg-background border border-border rounded-xl overflow-hidden shadow-sm">
        <table className="w-full text-sm text-left">
          <thead className="bg-muted text-muted-foreground font-medium border-b border-border">
            <tr>
              <th className="px-6 py-3">T√≠tol</th>
              <th className="px-6 py-3">Estat</th>
              <th className="px-6 py-3">Data</th>
              <th className="px-6 py-3 text-right">Accions</th>
            </tr>
          </thead>
          <tbody className="divide-y divide-border">
            {posts.map((post) => (
              <tr key={post.id} className="hover:bg-muted/50">
                <td className="px-6 py-4 font-medium text-foreground">
                  {post.title}
                  <div className="text-xs text-muted-foreground">/{post.slug}</div>
                </td>
                <td className="px-6 py-4">
                  <span className={`px-2 py-1 rounded-full text-xs font-bold ${
                    post.status === 'published' ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'
                  }`}>
                    {post.status}
                  </span>
                </td>
                <td className="px-6 py-4 text-muted-foreground">
                  {new Date(post.created_at).toLocaleDateString()}
                </td>
                <td className="px-6 py-4 text-right flex justify-end gap-2">
                  <Link href={`/${locale}/blog/${post.slug}`} target="_blank">
                    <button className="p-2 text-slate-400 hover:text-blue-500"><Eye className="w-4 h-4" /></button>
                  </Link>
                  <form action={deletePostAction}>
                    <input type="hidden" name="id" value={post.id} />
                    <button className="p-2 text-slate-400 hover:text-red-500"><Trash2 className="w-4 h-4" /></button>
                  </form>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  );
}

// =================== FILE: src/app/[locale]/(app)/booking/page.tsx ===================

import { getDashboardBookings } from '@/features/booking/actions';
import { CONFIG } from '@/config/digitai.config';
// üëá 1. Importem el model per tipar
import { Booking } from '@/types/models';

export default async function BookingDashboardPage() {
  // 1. Verifiquem si el m√≤dul est√† actiu
  if (!CONFIG.modules.booking) {
    return <div>M√≤dul no contractat.</div>;
  }

  // 2. Obtenim dades (Ara TypeScript sap que aix√≤ √©s Booking[])
  const bookings = await getDashboardBookings();

  return (
    <div>
      <div className="flex justify-between items-center mb-6">
        <h1 className="text-2xl font-bold text-foreground">Gesti√≥ de Cites</h1>
        <button className="bg-primary text-primary-foreground px-4 py-2 rounded-md text-sm font-medium hover:opacity-90">
          + Nova Cita Manual
        </button>
      </div>

      <div className="bg-background border border-border rounded-xl overflow-hidden shadow-sm">
        <table className="w-full text-sm text-left">
          <thead className="bg-muted text-muted-foreground font-medium border-b border-border">
            <tr>
              <th className="px-6 py-3">Client</th>
              <th className="px-6 py-3">Servei</th>
              <th className="px-6 py-3">Data i Hora</th>
              <th className="px-6 py-3">Estat</th>
            </tr>
          </thead>
          <tbody className="divide-y divide-border">
            {/* üëá 2. Tipem expl√≠citament (opcional si l'acci√≥ est√† ben feta, per√≤ recomanat) */}
            {bookings.map((booking: Booking) => (
              <tr key={booking.id} className="hover:bg-muted/50 transition-colors">
                <td className="px-6 py-4 font-medium text-foreground">
                  {booking.customer_name}
                  <div className="text-xs text-muted-foreground">{booking.customer_email}</div>
                </td>
                <td className="px-6 py-4 text-muted-foreground">
                  {booking.services?.title || 'Servei Eliminat'}
                </td>
                <td className="px-6 py-4 text-muted-foreground">
                  {new Date(booking.start_time).toLocaleString()}
                </td>
                <td className="px-6 py-4">
                  <span className={`inline-flex items-center px-2 py-1 rounded-full text-xs font-medium 
                    ${booking.status === 'confirmed' ? 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400' : 
                      booking.status === 'cancelled' ? 'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400' : 
                      'bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-400'}`}>
                    {booking.status}
                  </span>
                </td>
              </tr>
            ))}
            {bookings.length === 0 && (
              <tr>
                <td colSpan={4} className="px-6 py-12 text-center text-muted-foreground">
                  Encara no hi ha reserves.
                </td>
              </tr>
            )}
          </tbody>
        </table>
      </div>
    </div>
  );
}

// =================== FILE: src/app/[locale]/(app)/dashboard/page.tsx ===================



export default function DashboardPage() {
  // En un futur afegirem traduccions "Dashboard" al json
  return (
    <div>
      <header className="mb-8">
        <h1 className="text-3xl font-bold text-foreground">Panell de Control</h1>
        <p className="text-muted-foreground">Benvingut al teu sistema de gesti√≥.</p>
      </header>

      {/* Grid d'exemple */}
      <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div className="bg-background p-6 rounded-xl border border-border shadow-sm">
          <h3 className="text-sm font-medium text-muted-foreground uppercase">Usuaris Totals</h3>
          <p className="text-3xl font-bold text-foreground mt-2">1,234</p>
        </div>
        {/* M√©s widgets aqu√≠... */}
      </div>
    </div>
  );
}

// =================== FILE: src/app/[locale]/(app)/layout.tsx ===================

import { AdminSidebar } from '@/components/modules/dashboard/admin-sidebar';
import { UserSidebar } from '@/components/modules/dashboard/user-sidebar';
import { AppMobileBar } from '@/components/layout/app-mobile-bar';
import { createClient } from '@/lib/supabase/server';
import { authService } from '@/services/container';
import { redirect } from 'next/navigation';

function getOrgId() {
  const orgId = process.env.NEXT_PUBLIC_ORG_ID;
  if (!orgId) throw new Error("Missing ORG_ID");
  return orgId;
}

export default async function DashboardLayout({
  children,
  params
}: {
  children: React.ReactNode;
  params: Promise<{ locale: string }>;
}) {
  const { locale } = await params;
  const supabase = await createClient();
  const orgId = getOrgId();

  const { data: { user } } = await supabase.auth.getUser();

  if (!user) {
    redirect(`/${locale}/auth/login`);
  }

  const profile = await authService.getProfile(user.id, orgId);

  const userData = {
    email: user.email!,
    full_name: profile?.full_name,
    role: profile?.role
  };
  const isAdmin = userData.role === 'admin';
  return (
    <div className="min-h-screen bg-slate-50 flex flex-col md:flex-row">

      {/* Sidebar Intel¬∑ligent */}
      <div className="hidden md:block w-64 shrink-0 fixed h-full">
        {isAdmin ? <AdminSidebar user={userData} /> : <UserSidebar user={userData} />}
      </div>

      {/* Bottom Bar Intel¬∑ligent */}
      <AppMobileBar user={userData} />

      <main className="flex-1 lg:pl-64 transition-all duration-300 pb-20 md:pb-8">
        <div className="p-4 lg:p-8 max-w-7xl mx-auto">
          {children}
        </div>
      </main>
    </div>
  );
}

// =================== FILE: src/app/[locale]/(app)/my-account/page.tsx ===================

import { createClient } from '@/lib/supabase/server';
import { ecommerceService, bookingService } from '@/services/container';
import { Package, Calendar, Clock, } from 'lucide-react';
import { redirect } from 'next/navigation';
import { format } from 'date-fns';
import { ca } from 'date-fns/locale';
import Link from 'next/link';

export default async function MyAccountPage() {
  const supabase = await createClient();
  const { data: { user } } = await supabase.auth.getUser();

  if (!user) redirect('/auth/login');


  // Executem les dues consultes en paral¬∑lel per velocitat
  const [orders, bookings] = await Promise.all([
    ecommerceService.getOrdersByUser(user.id),
    bookingService.getBookingsByUser(user.id)
  ]);

  return (
    <div className="space-y-8 pb-20"> {/* Padding bottom per al MobileBar */}
      
      {/* Cap√ßalera Perfil */}
      <div className="bg-white p-8 rounded-3xl border border-slate-200 shadow-sm flex flex-col md:flex-row items-center gap-6 text-center md:text-left">
         <div className="w-20 h-20 bg-primary/10 rounded-full flex items-center justify-center text-primary shrink-0">
            <span className="text-3xl font-bold">{(user.user_metadata.full_name?.[0] || user.email?.[0] || 'U').toUpperCase()}</span>
         </div>
         <div>
            <h1 className="text-2xl font-bold text-slate-900">{user.user_metadata.full_name || 'Usuari'}</h1>
            <p className="text-slate-500">{user.email}</p>
            <div className="mt-2 inline-flex items-center px-3 py-1 rounded-full bg-slate-100 text-xs font-bold text-slate-600 border border-slate-200">
                Client
            </div>
         </div>
      </div>

      <div className="grid lg:grid-cols-2 gap-8">
         
         {/* üì¶ Historial de Comandes */}
         <div className="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm h-fit">
            <div className="flex items-center gap-3 mb-6 pb-4 border-b border-slate-100">
                <div className="p-2 bg-blue-50 text-blue-600 rounded-lg"><Package className="w-5 h-5" /></div>
                <h2 className="text-lg font-bold text-slate-900">Les meves comandes</h2>
            </div>
            
            {orders.length > 0 ? (
                <div className="space-y-4">
                    {orders.map((order) => (
                        <div key={order.id} className="flex justify-between items-center p-4 rounded-2xl bg-slate-50 border border-slate-100 hover:border-blue-200 transition-colors">
                            <div>
                                <p className="font-bold text-slate-900 text-sm">Comanda #{order.id.slice(0, 6)}</p>
                                <p className="text-xs text-slate-500">{format(new Date(order.created_at), 'PPP', { locale: ca })}</p>
                            </div>
                            <div className="text-right">
                                <p className="font-bold text-slate-900">{order.total_amount} ‚Ç¨</p>
                                <span className={`text-[10px] uppercase font-bold px-2 py-0.5 rounded-full ${
                                    order.status === 'paid' ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'
                                }`}>
                                    {order.status}
                                </span>
                            </div>
                        </div>
                    ))}
                </div>
            ) : (
                <div className="text-center py-10">
                    <Package className="w-12 h-12 text-slate-200 mx-auto mb-3" />
                    <p className="text-slate-400 text-sm mb-4">No has comprat res encara.</p>
                    <Link href="/shop" className="text-primary text-sm font-bold hover:underline">Anar a la Botiga</Link>
                </div>
            )}
         </div>

         {/* üìÖ Pr√≤ximes Cites */}
         <div className="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm h-fit">
            <div className="flex items-center gap-3 mb-6 pb-4 border-b border-slate-100">
                <div className="p-2 bg-purple-50 text-purple-600 rounded-lg"><Calendar className="w-5 h-5" /></div>
                <h2 className="text-lg font-bold text-slate-900">Les meves reserves</h2>
            </div>

            {bookings.length > 0 ? (
                <div className="space-y-4">
                    {bookings.map((booking) => (
                        <div key={booking.id} className="p-4 rounded-2xl bg-slate-50 border border-slate-100">
                            <h3 className="font-bold text-slate-900 mb-2">{booking.services?.title || 'Servei'}</h3>
                            <div className="flex items-center gap-4 text-xs text-slate-500">
                                <div className="flex items-center gap-1"><Calendar className="w-3 h-3"/> {format(new Date(booking.start_time), 'PPP', { locale: ca })}</div>
                                <div className="flex items-center gap-1"><Clock className="w-3 h-3"/> {format(new Date(booking.start_time), 'HH:mm')}</div>
                            </div>
                        </div>
                    ))}
                </div>
            ) : (
                <div className="text-center py-10">
                    <Calendar className="w-12 h-12 text-slate-200 mx-auto mb-3" />
                    <p className="text-slate-400 text-sm mb-4">No tens cites programades.</p>
                    <Link href="/book" className="text-primary text-sm font-bold hover:underline">Reservar ara</Link>
                </div>
            )}
         </div>

      </div>
    </div>
  );
}

// =================== FILE: src/app/[locale]/(app)/orders/page.tsx ===================

import { getAdminOrdersAction } from '@/features/ecommerce/actions';
import { requireAdmin } from '@/lib/auth/guards';
import { format } from 'date-fns';
import { BadgeEuro, Clock, CheckCircle, XCircle, Truck } from 'lucide-react';

// Helper per estats
const getStatusBadge = (status: string) => {
  switch (status) {
    case 'paid': return <span className="bg-green-100 text-green-700 px-2 py-1 rounded-full text-xs font-bold flex items-center gap-1"><CheckCircle size={12}/> Pagat</span>;
    case 'pending': return <span className="bg-yellow-100 text-yellow-700 px-2 py-1 rounded-full text-xs font-bold flex items-center gap-1"><Clock size={12}/> Pendent</span>;
    case 'shipped': return <span className="bg-blue-100 text-blue-700 px-2 py-1 rounded-full text-xs font-bold flex items-center gap-1"><Truck size={12}/> Enviat</span>;
    default: return <span className="bg-gray-100 text-gray-700 px-2 py-1 rounded-full text-xs font-bold flex items-center gap-1"><XCircle size={12}/> {status}</span>;
  }
};

export default async function OrdersPage() {
  await requireAdmin();
  const orders = await getAdminOrdersAction();

  return (
    <div className="space-y-6">
      <h1 className="text-3xl font-bold text-slate-900">Comandes</h1>
      
      <div className="bg-white border border-slate-200 rounded-xl overflow-hidden shadow-sm">
        <table className="w-full text-left text-sm">
          <thead className="bg-slate-50 text-slate-500 font-medium border-b border-slate-200">
            <tr>
              <th className="px-6 py-4">ID / Data</th>
              <th className="px-6 py-4">Client</th>
              <th className="px-6 py-4">Total</th>
              <th className="px-6 py-4">M√®tode</th>
              <th className="px-6 py-4">Estat</th>
            </tr>
          </thead>
          <tbody className="divide-y divide-slate-100">
            {orders.map((order) => (
              <tr key={order.id} className="hover:bg-slate-50 transition-colors">
                <td className="px-6 py-4">
                  <div className="font-mono text-xs text-slate-400">#{order.id.slice(0,8)}</div>
                  <div className="text-slate-700 font-medium">
                    {format(new Date(order.created_at), 'dd MMM yyyy HH:mm')}
                  </div>
                </td>
                <td className="px-6 py-4 font-medium text-slate-900">
                  {order.customer_email}
                </td>
                <td className="px-6 py-4 font-bold text-slate-900">
                  {new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' }).format(order.total_amount)}
                </td>
                <td className="px-6 py-4 capitalize text-slate-600">
                  <div className="flex items-center gap-2">
                    <BadgeEuro size={16} /> {order.payment_method}
                  </div>
                </td>
                <td className="px-6 py-4">
                  {getStatusBadge(order.status)}
                </td>
              </tr>
            ))}
            {orders.length === 0 && (
                <tr>
                    <td colSpan={5} className="px-6 py-12 text-center text-muted-foreground">
                        Encara no hi ha vendes.
                    </td>
                </tr>
            )}
          </tbody>
        </table>
      </div>
    </div>
  );
}

// =================== FILE: src/app/[locale]/(app)/products/new/page.tsx ===================

'use client';

import { useActionState } from 'react';
import { createProductAction , ActionState } from '@/features/ecommerce/actions';
import { Save, ArrowLeft } from 'lucide-react';
import Link from 'next/link';

// L'estat inicial ha de tenir EXACTAMENT la mateixa forma
const initialState: ActionState = {
    success: false,
    message: '',
    error: '' // Si error √©s opcional al tipus, aqu√≠ pot ser undefined o string buit
};

export default function NewProductPage() {
    
    const [state, formAction, isPending] = useActionState(createProductAction, initialState);

    return (
        <div className="max-w-3xl mx-auto p-6">
            <Link href="/products" className="flex items-center text-muted-foreground mb-6 hover:text-foreground">
                <ArrowLeft className="w-4 h-4 mr-2" /> Tornar al Dashboard
            </Link>

            <div className="bg-background border border-border rounded-xl p-8 shadow-sm">
                <h1 className="text-2xl font-bold mb-6">Nou Producte</h1>

                {state.error && (
                    <div className="bg-red-50 text-red-600 p-4 rounded-lg mb-6 text-sm font-medium">
                        {state.error}
                    </div>
                )}
                {state.success && (
                    <div className="bg-green-50 text-green-600 p-4 rounded-lg mb-6 text-sm font-medium">
                        Producte creat! Pots continuar afegint-ne.
                    </div>
                )}

                <form action={formAction} className="space-y-6">
                    <div className="grid md:grid-cols-2 gap-6">
                        <div className="col-span-2">
                            <label className="block text-sm font-medium mb-2">Nom del Producte</label>
                            <input name="name" required placeholder="Ex: Samarreta Vintage" className="w-full p-3 rounded-lg border border-border bg-muted/10" />
                        </div>

                        <div className="col-span-2">
                            <label className="block text-sm font-medium mb-2">Descripci√≥</label>
                            <textarea name="description" rows={3} className="w-full p-3 rounded-lg border border-border bg-muted/10" />
                        </div>

                        <div>
                            <label className="block text-sm font-medium mb-2">Preu (‚Ç¨)</label>
                            <input name="price" type="number" step="0.01" required className="w-full p-3 rounded-lg border border-border bg-muted/10" />
                        </div>

                        <div>
                            <label className="block text-sm font-medium mb-2">Estoc Inicial</label>
                            <input name="stock" type="number" required defaultValue="10" className="w-full p-3 rounded-lg border border-border bg-muted/10" />
                        </div>

                        <div className="col-span-2">
                            <label className="block text-sm font-medium mb-2">URL Imatge (Temporal)</label>
                            <input name="images" placeholder="https://..." className="w-full p-3 rounded-lg border border-border bg-muted/10" />
                            <p className="text-xs text-muted-foreground mt-1">Pots separar m√∫ltiples URLs amb comes.</p>
                        </div>
                    </div>

                    <button
                        type="submit"
                        disabled={isPending}
                        className="w-full bg-primary text-primary-foreground font-bold py-3 rounded-lg flex justify-center items-center gap-2 hover:opacity-90 disabled:opacity-50"
                    >
                        {isPending ? 'Guardant...' : <><Save size={18} /> Crear Producte</>}
                    </button>
                </form>
            </div>
        </div>
    );
}

// =================== FILE: src/app/[locale]/(app)/products/page.tsx ===================

import { getProductsAction } from '@/features/ecommerce/actions';
import { requireAdmin } from '@/lib/auth/guards';
import Link from 'next/link';
import { Plus, Edit, Eye, Package, AlertTriangle, CheckCircle, XCircle } from 'lucide-react';
import Image from 'next/image';

// Helper per formatar moneda (Professional touch)
const formatPrice = (amount: number) => {
  return new Intl.NumberFormat('es-ES', {
    style: 'currency',
    currency: 'EUR',
  }).format(amount);
};

export default async function ProductsManagementPage({ params }: { params: Promise<{ locale: string }> }) {
  const { locale } = await params;

  // üõ°Ô∏è 1. SEGURETAT: Firewall d'Admin
  // Si l'usuari no √©s admin, aquesta funci√≥ llan√ßa un error i atura la renderitzaci√≥.
  await requireAdmin();

  // üì• 2. DADES: Recuperem tots els productes de l'organitzaci√≥
  const products = await getProductsAction();

  return (
    <div className="space-y-6">
      {/* Cap√ßalera */}
      <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
        <div>
          <h1 className="text-3xl font-bold text-slate-900">Productes</h1>
          <p className="text-slate-500">Gestiona el cat√†leg, preus i inventari de la teva botiga.</p>
        </div>
        <Link href={`/${locale}/products/new`}>
          <button className="flex items-center gap-2 bg-primary text-white px-5 py-2.5 rounded-lg font-bold shadow-lg shadow-primary/20 hover:opacity-90 transition-all active:scale-95">
            <Plus className="w-5 h-5" />
            Nou Producte
          </button>
        </Link>
      </div>

      {/* Taula de Productes */}
      <div className="bg-white border border-slate-200 rounded-xl overflow-hidden shadow-sm">
        {products.length === 0 ? (
          // Estat Buit (Empty State)
          <div className="p-12 text-center flex flex-col items-center justify-center">
            <div className="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mb-4">
                <Package className="w-8 h-8 text-slate-400" />
            </div>
            <h3 className="text-lg font-bold text-slate-900">Encara no tens productes</h3>
            <p className="text-slate-500 max-w-sm mb-6">
              Comen√ßa a afegir productes per omplir la teva botiga online.
            </p>
            <Link href={`/${locale}/products/new`}>
               <span className="text-primary font-bold hover:underline">Crear el primer producte &rarr;</span>
            </Link>
          </div>
        ) : (
          // Taula de Dades
          <div className="overflow-x-auto">
            <table className="w-full text-left text-sm">
              <thead className="bg-slate-50 text-slate-500 font-medium border-b border-slate-200">
                <tr>
                  <th className="px-6 py-4 w-20">Imatge</th>
                  <th className="px-6 py-4">Nom del Producte</th>
                  <th className="px-6 py-4">Preu</th>
                  <th className="px-6 py-4">Estoc</th>
                  <th className="px-6 py-4">Estat</th>
                  <th className="px-6 py-4 text-right">Accions</th>
                </tr>
              </thead>
              <tbody className="divide-y divide-slate-100">
                {products.map((product) => (
                  <tr key={product.id} className="hover:bg-slate-50/50 transition-colors group">
                    
                    {/* Columna Imatge */}
                    <td className="px-6 py-4">
                      <div className="w-12 h-12 rounded-lg bg-slate-100 overflow-hidden border border-slate-200 relative">
                        {product.images[0] ? (
                          <Image
                            src={product.images[0]} 
                            alt={product.name}
                            className="w-full h-full object-cover"
                          />
                        ) : (
                          <div className="flex items-center justify-center h-full text-slate-400">
                            <Package className="w-5 h-5" />
                          </div>
                        )}
                      </div>
                    </td>

                    {/* Columna Nom */}
                    <td className="px-6 py-4">
                      <div className="font-bold text-slate-900">{product.name}</div>
                      <div className="text-xs text-slate-400 font-mono truncate max-w-[150px]">
                        /{product.slug}
                      </div>
                    </td>

                    {/* Columna Preu */}
                    <td className="px-6 py-4 font-medium text-slate-700">
                      {formatPrice(product.price)}
                    </td>

                    {/* Columna Estoc (amb l√≤gica visual) */}
                    <td className="px-6 py-4">
                      <div className="flex items-center gap-2">
                        <span>{product.stock} u.</span>
                        {product.stock === 0 ? (
                             <span className="px-2 py-0.5 rounded text-[10px] font-bold bg-red-100 text-red-700 uppercase">Esgotat</span>
                        ) : product.stock < 5 ? (
                             <AlertTriangle className="w-4 h-4 text-amber-500"  />
                        ) : null}
                      </div>
                    </td>

                    {/* Columna Estat */}
                    <td className="px-6 py-4">
                      {product.active ? (
                        <span className="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium bg-emerald-100 text-emerald-700">
                          <CheckCircle className="w-3 h-3" /> Actiu
                        </span>
                      ) : (
                        <span className="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium bg-slate-100 text-slate-500">
                          <XCircle className="w-3 h-3" /> Inactiu
                        </span>
                      )}
                    </td>

                    {/* Columna Accions */}
                    <td className="px-6 py-4 text-right">
                      <div className="flex justify-end gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                        {/* Veure a la botiga (P√∫blic) */}
                        <Link 
                            href={`/${locale}/shop/${product.slug}`} 
                            target="_blank"
                            className="p-2 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-colors"
                            title="Veure a la botiga"
                        >
                            <Eye className="w-4 h-4" />
                        </Link>
                        
                        {/* Editar (Admin) - Ruta que crearem despr√©s si cal */}
                        <Link 
                            href={`/${locale}/products/${product.id}/edit`}
                            className="p-2 text-slate-400 hover:text-amber-600 hover:bg-amber-50 rounded-lg transition-colors"
                            title="Editar"
                        >
                            <Edit className="w-4 h-4" />
                        </Link>
                      </div>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        )}
      </div>
    </div>
  );
}

// =================== FILE: src/app/[locale]/(app)/services/new/page.tsx ===================

'use client';

import { useState } from 'react';
import { useRouter } from 'next/navigation';
import { createServiceAction } from '@/features/booking/actions';
import { ServiceFormBuilder } from '@/components/modules/booking/ServiceFormBuilder'
import { FormField } from '@/types/models';
import { ArrowLeft, Save, Loader2 } from 'lucide-react';
import Link from 'next/link';
import { toast } from 'sonner'; // üëà IMPORTAR TOAST

export default function NewServicePage() {
  const router = useRouter();
  const [isPending, setIsPending] = useState(false);
  const [customFields, setCustomFields] = useState<FormField[]>([]);

  // Eliminem l'acci√≥ directa del <form> per tenir control total
  const handleSubmit = async (e: React.FormEvent<HTMLFormElement>) => {
    e.preventDefault(); // Evitem el reload natiu
    setIsPending(true);

    const formData = new FormData(e.currentTarget);
    formData.append('form_schema', JSON.stringify(customFields));

    // Cridem al Server Action
    // ‚úÖ CORRECCI√ì (Passa 'undefined' com a primer argument):
    const result = await createServiceAction(undefined, formData);

    if (result.success) {
      // ‚úÖ √àXIT: Toast Verd + Redirecci√≥
      toast.success(result.message);
      router.push('/services');
      router.refresh(); // Assegura que la llista es carrega de nou
    } else {
      // ‚ùå ERROR: Toast Vermell + Mantenim dades
      toast.error(result.message);
      setIsPending(false); // Parem de carregar perqu√® l'usuari corregeixi
    }
  };

  return (
    <div className="max-w-2xl mx-auto space-y-6">

      <div className="flex items-center gap-4">
        <Link href="/services" className="p-2 hover:bg-slate-100 rounded-full transition-colors">
          <ArrowLeft className="w-5 h-5 text-slate-500" />
        </Link>
        <h1 className="text-2xl font-bold text-slate-900">Nou Servei</h1>
      </div>

      {/* Usem onSubmit en lloc de action */}
      <form onSubmit={handleSubmit} className="space-y-8">

        <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 space-y-4">
          <div>
            <label className="block text-sm font-medium mb-1">Nom del Servei</label>
            <input name="title" required placeholder="Ex: Canvi d'Oli" className="w-full p-2 border rounded-lg" />
          </div>

          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-medium mb-1">Preu (‚Ç¨)</label>
              <input name="price" type="number" step="0.01" required className="w-full p-2 border rounded-lg" />
            </div>
            <div>
              <label className="block text-sm font-medium mb-1">Durada (min)</label>
              <input name="duration" type="number" required defaultValue={60} className="w-full p-2 border rounded-lg" />
            </div>
          </div>

          <div>
            <label className="block text-sm font-medium mb-1">Descripci√≥</label>
            <textarea name="description" rows={3} className="w-full p-2 border rounded-lg" />
          </div>
        </div>

        {/* Builder de Formulari */}
        <ServiceFormBuilder onChange={setCustomFields} />

        <div className="flex justify-end pt-4">
          <button
            type="submit"
            disabled={isPending}
            className="bg-primary text-white px-6 py-3 rounded-xl font-bold flex items-center gap-2 hover:opacity-90 disabled:opacity-50 transition-all shadow-lg shadow-primary/20"
          >
            {isPending ? <Loader2 className="animate-spin" /> : <Save size={18} />}
            {isPending ? 'Guardant...' : 'Crear Servei'}
          </button>
        </div>

      </form>
    </div>
  );
}

// =================== FILE: src/app/[locale]/(app)/services/page.tsx ===================

import Link from 'next/link';
import { getServices, deleteServiceAction } from '@/features/booking/actions';
import { CONFIG } from '@/config/digitai.config';
import { Plus, Trash2, Clock, Euro } from 'lucide-react';

export default async function ServicesPage({ params }: { params: Promise<{ locale: string }> }) {
  const { locale } = await params;

  // Protecci√≥ de M√≤dul
  if (!CONFIG.modules.booking) return <div>M√≤dul no actiu</div>;

  const services = await getServices();

  return (
    <div className="space-y-6">
      
      {/* Header */}
      <div className="flex justify-between items-center">
        <div>
          <h1 className="text-3xl font-bold text-foreground">Els meus Serveis</h1>
          <p className="text-muted-foreground">Defineix qu√® poden reservar els teus clients.</p>
        </div>
        <Link href={`/${locale}/services/new`}>
          <button className="flex items-center gap-2 bg-primary text-primary-foreground px-4 py-2 rounded-lg font-medium hover:opacity-90 transition-all">
            <Plus className="w-4 h-4" /> Nou Servei
          </button>
        </Link>
      </div>

      {/* Grid de Targetes */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {services?.map((service) => (
          <div key={service.id} className="bg-background border border-border rounded-xl p-6 shadow-sm hover:shadow-md transition-shadow relative group">
            
            <h3 className="text-xl font-bold text-foreground mb-2">{service.title}</h3>
            <p className="text-sm text-muted-foreground mb-4 line-clamp-2 h-10">
              {service.description || "Sense descripci√≥"}
            </p>

            <div className="flex items-center justify-between pt-4 border-t border-border">
              <div className="flex items-center gap-4 text-sm font-medium">
                <span className="flex items-center gap-1 text-slate-600">
                   <Clock className="w-4 h-4" /> {service.duration_minutes} min
                </span>
                <span className="flex items-center gap-1 text-primary">
                   <Euro className="w-4 h-4" /> {service.price}
                </span>
              </div>

              {/* Bot√≥ d'Esborrar (Server Action Inline) */}
              <form action={deleteServiceAction}>
                  <input type="hidden" name="id" value={service.id} />
                  <button type="submit" className="text-red-400 hover:text-red-600 p-2 rounded-full hover:bg-red-50 transition-colors">
                      <Trash2 className="w-4 h-4" />
                  </button>
              </form>
            </div>
          </div>
        ))}

        {services?.length === 0 && (
            <div className="col-span-full py-12 text-center border-2 border-dashed border-border rounded-xl bg-muted/20">
                <p className="text-muted-foreground">Encara no has creat cap servei.</p>
            </div>
        )}
      </div>
    </div>
  );
}

// =================== FILE: src/app/[locale]/(public)/auth/login/page.tsx ===================

'use client';

import { useActionState } from 'react';
import { loginAction } from '@/features/auth/actions';
import { CONFIG } from '@/config/digitai.config';
import { AlertCircle, CheckCircle } from 'lucide-react';
import Link from 'next/link';
import { useSearchParams } from 'next/navigation';

const ERROR_MESSAGES: Record<string, string> = {
  invalid_credentials: "El correu o la contrasenya no s√≥n correctes.",
  no_access: "No tens perm√≠s per accedir a aquesta organitzaci√≥.",
  generic: "Hi ha hagut un error inesperat. Torna-ho a provar.",
  no_profile: "L'usuari existeix per√≤ no t√© perfil actiu."
};

// Estat inicial per al hook
const initialState = { error: '', message: '' };

export default function LoginPage() {
  // 1. Hook per gestionar el formulari
  const [state, formAction, isPending] = useActionState(loginAction, initialState);
  
  // 2. Tamb√© mirem la URL per si venim d'un redirect extern
  const searchParams = useSearchParams();
  const urlError = searchParams.get('error');
  const urlMessage = searchParams.get('message');

  // Prioritzem l'error de l'estat actual, sin√≥ el de la URL
  const activeError = state?.error || urlError;
  const activeMessage = state?.message || urlMessage;

  return (
    <div className="flex min-h-screen items-center justify-center bg-secondary/5 px-4 py-12">
      <div className="w-full max-w-md space-y-8 bg-background p-8 rounded-2xl shadow-xl border border-border">
        
        <div className="text-center">
          <h2 className="text-3xl font-extrabold text-foreground tracking-tight">
            {CONFIG.identity.name}
          </h2>
          <p className="mt-2 text-sm text-muted-foreground">Inicia sessi√≥</p>
        </div>

        {/* üö® Error Display */}
        {activeError && (
          <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg flex items-start gap-3 animate-in slide-in-from-top-2">
            <AlertCircle className="w-5 h-5 shrink-0 mt-0.5" />
            <div className="text-sm font-medium">
              {ERROR_MESSAGES[activeError] || ERROR_MESSAGES.generic}
            </div>
          </div>
        )}

        {/* ‚úÖ Success Display */}
        {activeMessage === 'registered' && (
           <div className="bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded-lg flex items-start gap-3 animate-in slide-in-from-top-2">
            <CheckCircle className="w-5 h-5 shrink-0 mt-0.5" />
            <div className="text-sm font-medium">
              Compte creat! Inicia sessi√≥.
            </div>
          </div>
        )}

        <form action={formAction} className="mt-8 space-y-6">
          <div className="space-y-4">
            <div>
              <label htmlFor="email" className="block text-sm font-medium mb-1">Email</label>
              <input id="email" name="email" type="email" required className="w-full p-3 border border-border rounded-lg bg-muted/10" placeholder="nom@exemple.com" />
            </div>
            <div>
              <label htmlFor="password" className="block text-sm font-medium mb-1">Contrasenya</label>
              <input id="password" name="password" type="password" required className="w-full p-3 border border-border rounded-lg bg-muted/10" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
            </div>
          </div>

          <button
            type="submit"
            disabled={isPending}
            className="w-full bg-primary text-primary-foreground py-3 rounded-lg font-bold hover:opacity-90 disabled:opacity-50 transition-all"
          >
            {isPending ? 'Entrant...' : 'Entrar'}
          </button>
        </form>

        {CONFIG.modules.auth.allowPublicRegistration && (
            <div className="text-center text-sm pt-4 border-t border-border">
                <p className="text-muted-foreground">
                    No tens compte? <Link href="/auth/register" className="font-bold text-primary hover:underline">Registra't</Link>
                </p>
            </div>
        )}
      </div>
    </div>
  );
}

// =================== FILE: src/app/[locale]/(public)/auth/register/page.tsx ===================

'use client';

import { useActionState } from 'react';
import { registerAction } from '@/features/auth/actions'; // Importem l'acci√≥
import { CONFIG } from '@/config/digitai.config';
import { AlertCircle } from 'lucide-react';
import Link from 'next/link';
import { useSearchParams } from 'next/navigation';

// Missatges d'error tradu√Øbles
const ERROR_MESSAGES: Record<string, string> = {
  account_exists: "Aquest correu ja est√† registrat. Prova d'iniciar sessi√≥.",
  generic: "Hi ha hagut un error al crear el compte. Torna-ho a provar.",
  invalid_data: "Les dades introdu√Ødes no s√≥n v√†lides."
};

const initialState = { error: '', message: '' };

export default function RegisterPage() {
  // 1. Hook per connectar amb la Server Action
  const [state, formAction, isPending] = useActionState(registerAction, initialState);
  
  // Llegim errors externs tamb√© (per si de cas)
  const searchParams = useSearchParams();
  const urlError = searchParams.get('error');
  const activeError = state?.error || urlError;

  return (
    <div className="flex min-h-screen items-center justify-center bg-secondary/5 px-4 py-12">
      <div className="w-full max-w-md space-y-8 bg-background p-8 rounded-2xl shadow-xl border border-border">
        
        {/* Header */}
        <div className="text-center">
          <h2 className="text-3xl font-extrabold text-foreground tracking-tight">
            Crea el teu compte
          </h2>
          <p className="mt-2 text-sm text-muted-foreground">
            Uneix-te a {CONFIG.identity.name}
          </p>
        </div>

        {/* üö® Zona d'Errors */}
        {activeError && (
          <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg flex items-start gap-3 animate-in slide-in-from-top-2">
            <AlertCircle className="w-5 h-5 shrink-0 mt-0.5" />
            <div className="text-sm font-medium">
              {ERROR_MESSAGES[activeError] || ERROR_MESSAGES.generic}
            </div>
          </div>
        )}

        {/* Formulari */}
        <form action={formAction} className="mt-8 space-y-6">
          <div className="space-y-4">
            
            {/* Nom Complet */}
            <div>
              <label htmlFor="fullName" className="block text-sm font-medium mb-1">Nom Complet</label>
              <input
                id="fullName"
                name="fullName"
                type="text"
                required
                className="w-full p-3 border border-border rounded-lg bg-muted/10 focus:ring-2 focus:ring-primary outline-none transition-all"
                placeholder="Joan Garcia"
              />
            </div>

            {/* Email */}
            <div>
              <label htmlFor="email" className="block text-sm font-medium mb-1">Correu Electr√≤nic</label>
              <input
                id="email"
                name="email"
                type="email"
                autoComplete="email"
                required
                className="w-full p-3 border border-border rounded-lg bg-muted/10 focus:ring-2 focus:ring-primary outline-none transition-all"
                placeholder="nom@exemple.com"
              />
            </div>

            {/* Password */}
            <div>
              <label htmlFor="password" className="block text-sm font-medium mb-1">Contrasenya</label>
              <input
                id="password"
                name="password"
                type="password"
                autoComplete="new-password"
                required
                minLength={6}
                className="w-full p-3 border border-border rounded-lg bg-muted/10 focus:ring-2 focus:ring-primary outline-none transition-all"
                placeholder="M√≠nim 6 car√†cters"
              />
            </div>
          </div>

          <button
            type="submit"
            disabled={isPending}
            className="w-full bg-primary text-primary-foreground py-3 rounded-lg font-bold hover:opacity-90 disabled:opacity-50 transition-all shadow-lg hover:scale-[1.01] active:scale-[0.99]"
          >
            {isPending ? 'Creant compte...' : 'Registrar-se'}
          </button>
        </form>

        {/* Footer Link */}
        <div className="text-center text-sm pt-4 border-t border-border">
          <p className="text-muted-foreground">
            Ja tens compte?{' '}
            <Link href="/auth/login" className="font-bold text-primary hover:underline">
              Inicia sessi√≥
            </Link>
          </p>
        </div>

      </div>
    </div>
  );
}

// =================== FILE: src/app/[locale]/(public)/blog/page.tsx ===================

import Link from 'next/link';
import { getPublicPostsAction } from '@/features/blog/actions'; // Acci√≥ que vam crear
import { CONFIG } from '@/config/digitai.config';
import { format } from 'date-fns';

type Props = {
  params: Promise<{ locale: string }>;
};

export default async function BlogIndexPage({ params }: Props) {
  const { locale } = await params;

  // 1. Feature Flag Check
  if (!CONFIG.modules.blog) {
    return <div className="py-20 text-center">El blog no est√† habilitat.</div>;
  }

  // 2. Data Fetching (Server Side)
  const posts = await getPublicPostsAction();

  return (
    <div className="min-h-screen bg-background py-20 px-4">
      <div className="container mx-auto max-w-5xl">
        <div className="text-center mb-16">
          <h1 className="text-4xl md:text-5xl font-bold mb-4 text-foreground">Blog & Not√≠cies</h1>
          <p className="text-muted-foreground text-lg">√öltimes novetats de {CONFIG.identity.name}</p>
        </div>

        <div className="grid gap-8 md:grid-cols-2 lg:grid-cols-3">
          {posts.map((post) => (
            <Link key={post.id} href={`/${locale}/blog/${post.slug}`} className="group">
              <article className="h-full border border-border rounded-2xl overflow-hidden hover:shadow-lg transition-all bg-card">
                {/* Placeholder d'imatge si no en t√© */}
                <div className="h-48 bg-muted w-full relative">
                   {/* Aqu√≠ podries posar <Image /> si post.cover_image existeix */}
                   <div className="absolute inset-0 flex items-center justify-center text-muted-foreground/20 font-bold text-4xl">
                      IMG
                   </div>
                </div>
                
                <div className="p-6">
                  <div className="text-xs font-medium text-primary mb-2">
                    {post.published_at ? format(new Date(post.published_at), 'dd MMM yyyy') : 'Recent'}
                  </div>
                  <h2 className="text-xl font-bold mb-2 group-hover:text-primary transition-colors text-foreground line-clamp-2">
                    {post.title}
                  </h2>
                  <p className="text-muted-foreground text-sm line-clamp-3">
                    {post.description}
                  </p>
                </div>
              </article>
            </Link>
          ))}
        </div>

        {posts.length === 0 && (
            <div className="text-center py-12 bg-muted/20 rounded-xl">
                <p className="text-muted-foreground">Encara no hi ha publicacions.</p>
            </div>
        )}
      </div>
    </div>
  );
}

// =================== FILE: src/app/[locale]/(public)/blog/[slug]/page.tsx ===================

import { postService } from '@/services/container'; // Usem el servei directament (RSC)
import { notFound } from 'next/navigation';
import Link from 'next/link';
import { ArrowLeft } from 'lucide-react';

// Helper per obtenir ORG_ID en Server Components purs
function getOrgId() {
  return process.env.NEXT_PUBLIC_ORG_ID!;
}

type Props = {
  params: Promise<{ locale: string; slug: string }>;
};

export default async function BlogPostPage({ params }: Props) {
  const { locale, slug } = await params;
  const orgId = getOrgId();

  // Obtenim el post
  const post = await postService.getPostBySlug(slug, orgId);

  if (!post) notFound();

  return (
    <article className="min-h-screen bg-background py-20 px-4">
      <div className="container mx-auto max-w-3xl">
        
        <Link href={`/${locale}/blog`} className="inline-flex items-center text-sm text-muted-foreground hover:text-primary mb-8 transition-colors">
          <ArrowLeft className="w-4 h-4 mr-2" /> Tornar al Blog
        </Link>

        <header className="mb-10">
          <h1 className="text-4xl md:text-5xl font-extrabold text-foreground mb-6 leading-tight">
            {post.title}
          </h1>
          {post.description && (
            <p className="text-xl text-muted-foreground italic border-l-4 border-primary pl-4">
              {post.description}
            </p>
          )}
        </header>

        {/* CONTINGUT (MDX Placeholder) */}
        {/* En el futur aqu√≠ anir√† <MDXRemote source={post.content_mdx} /> */}
        <div className="prose prose-lg dark:prose-invert max-w-none">
            {/* Renderitzem el contingut com a text pla per ara, respectant salts de l√≠nia */}
            <div className="whitespace-pre-wrap text-foreground/90">
                {post.content_mdx}
            </div>
        </div>

      </div>
    </article>
  );
}

// =================== FILE: src/app/[locale]/(public)/book/page.tsx ===================

//src\app\[locale]\(public)\book\page.tsx
import { getServices } from '@/features/booking/actions';
import { BookingWidget } from '@/components/modules/booking/BookingWidget'; // Comprova maj√∫scules/min√∫scules
import { CONFIG } from '@/config/digitai.config';
import { getTranslations } from 'next-intl/server';

export default async function PublicBookingPage() {
  const t = await getTranslations('Booking');

  // Feature Flag Check
  if (!CONFIG.modules.booking) {
    return (
        <div className="min-h-[50vh] flex items-center justify-center text-muted-foreground">
            Aquest lloc no t√© les reserves activades.
        </div>
    );
  }

  // Fetch de dades al servidor (R√†pid i segur) 
  const services = await getServices();

  return (
    <div className="min-h-screen bg-slate-50/50 py-16 px-4">
      <div className="max-w-5xl mx-auto">
        <div className="text-center mb-12">
            <h1 className="text-4xl font-extrabold text-slate-900 mb-4 tracking-tight">
                {t('title', { defaultMessage: 'Reserva la teva cita' })}
            </h1>
            <p className="text-lg text-slate-500 max-w-2xl mx-auto">
                {t('subtitle', { defaultMessage: 'Selecciona el servei, tria el dia que millor et vagi i confirma la teva assist√®ncia en menys d\'un minut.' })}
            </p>
        </div>
        
        <BookingWidget services={services || []} />
      </div>
    </div>
  );
}

// =================== FILE: src/app/[locale]/(public)/checkout/success/page.tsx ===================

//src\app\[locale]\(public)\checkout\success\page.tsx
'use client';

import { useEffect } from 'react';
import { useCartStore } from '@/lib/store/cart-store';
import { CheckCircle, ArrowRight, ShoppingBag } from 'lucide-react';
import Link from 'next/link';
import { useSearchParams } from 'next/navigation';
import { motion } from 'framer-motion';

export default function CheckoutSuccessPage() {
  const clearCart = useCartStore((state) => state.clearCart);
  const searchParams = useSearchParams();
  const orderId = searchParams.get('orderId'); // Opcional, si el passem

  // üßπ Neteja autom√†tica del carret en carregar la p√†gina
  useEffect(() => {
    clearCart();
  }, [clearCart]);

  return (
    <div className="min-h-screen bg-slate-50 flex items-center justify-center p-4">
      <motion.div 
        initial={{ scale: 0.8, opacity: 0 }}
        animate={{ scale: 1, opacity: 1 }}
        className="bg-white max-w-md w-full p-8 rounded-3xl shadow-xl text-center border border-slate-100"
      >
        <div className="w-24 h-24 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-6">
            <CheckCircle className="w-12 h-12" />
        </div>
        
        <h1 className="text-3xl font-extrabold text-slate-900 mb-2">Pagament Acceptat!</h1>
        <p className="text-slate-500 mb-8">
            Gr√†cies per la teva compra. Hem enviat un correu electr√≤nic amb els detalls de la comanda.
        </p>

        {orderId && (
            <div className="bg-slate-50 p-4 rounded-xl mb-8 border border-slate-200">
                <span className="text-xs text-slate-400 uppercase tracking-widest font-bold">Refer√®ncia</span>
                <p className="font-mono text-slate-700 font-bold mt-1">#{orderId.slice(0, 8)}</p>
            </div>
        )}

        <div className="space-y-3">
            <Link href="/shop">
                <button className="w-full bg-primary text-primary-foreground py-3 rounded-xl font-bold hover:opacity-90 flex items-center justify-center gap-2">
                    <ShoppingBag size={18} /> Continuar Comprant
                </button>
            </Link>
            
            <Link href="/my-account">
                <button className="w-full bg-white text-slate-600 border border-slate-200 py-3 rounded-xl font-bold hover:bg-slate-50 flex items-center justify-center gap-2">
                    Veure les meves comandes <ArrowRight size={18} />
                </button>
            </Link>
        </div>
      </motion.div>
    </div>
  );
}

// =================== FILE: src/app/[locale]/(public)/layout.tsx ===================

import { Navbar } from '@/components/layout/navbar';
import { Footer } from '@/components/layout/footer';
import { CartDrawer } from '@/components/modules/ecommerce/cart-drawer';
import { ChatWidget } from '@/components/modules/ai/chat-widget';
import { createClient } from '@/lib/supabase/server';
import { PublicMobileBar } from '@/components/layout/public-mobil-bar';
import { authService } from '@/services/container'; // üëà Necessitem el servei per buscar el perfil/rol
import { CONFIG } from "@/config/digitai.config"; // üëà Importa la config
// Definim el tipus aqu√≠ o l'importem d'un lloc com√∫
type UserSummary = {
  email: string;
  full_name?: string | null;
  role?: string;
};

export default async function PublicLayout({ children }: { children: React.ReactNode }) {
  const supabase = await createClient();

  // 1. Obtenim l'usuari cru de Supabase
  const { data: { user } } = await supabase.auth.getUser();
  const orgId = process.env.NEXT_PUBLIC_ORG_ID!;

  // 2. Preparem l'objecte UserSummary (amb el Rol)
  let userData: UserSummary | null = null;

  if (user) {
    // Busquem el perfil per saber si √©s admin
    const profile = await authService.getProfile(user.id, orgId);

    userData = {
      email: user.email || '', // üëà Solucionem l'error 'undefined' amb un fallback
      full_name: profile?.full_name,
      role: profile?.role // üëà Aqu√≠ tenim el rol correcte
    };
  }

  return (
    <div className="flex flex-col min-h-screen">
      {/* NOTA: Si el Navbar encara fa servir el tipus 'User' de Supabase, 
          li passem 'user'. Si ja el vas actualitzar a UserSummary, passa-li 'userData'.
          Aqu√≠ assumeixo que Navbar encara accepta el tipus original o √©s compatible.
      */}
      <Navbar user={user} />

      <CartDrawer />

      {/* üëá NOM√âS ES RENDERITZA SI EL M√íDUL EST√Ä ACTIU */}
      {CONFIG.modules.chatbot && <ChatWidget />}

      <main className="grow pb-20 md:pb-0"> {/* Padding per no tapar amb la barra m√≤bil */}
        {children}
      </main>

      {/* üëá ARA S√ç: Passem l'objecte amb el tipus correcte */}
      <PublicMobileBar user={userData} />

      <Footer />
    </div>
  );
}

// =================== FILE: src/app/[locale]/(public)/page.tsx ===================

import { marketingService } from '@/services/container';
import { getServices } from '@/features/booking/actions';
import { ServiceContent } from '@/types/models'; // Assegura't que tens aquests tipus

// 1. IMPORTEM TOTS ELS COMPONENTS
import { HeroSection } from '@/components/modules/marketing/hero-section';
import { ServicesSection } from '@/components/modules/marketing/services-section';
import { ContactSection } from '@/components/modules/marketing/contact-section';
import { StatsSection } from '@/components/modules/marketing/stats-section';
import { TestimonialsSection } from '@/components/modules/marketing/testimonials-section';
import { MapSection } from '@/components/modules/marketing/map-section';
import { CTABannerSection } from '@/components/modules/marketing/cta-section';
import { FAQSection } from '@/components/modules/marketing/faq-section';
import { FeaturedProductsSection } from '@/components/modules/marketing/featured-products-section';
import { AboutSection } from '@/components/modules/marketing/about-section';

// 2. DEFINICI√ì DE TIPUS ESTRICTA
// En lloc de 'any', diem que un component de secci√≥ accepta una prop 'data' de tipus desconegut.
type SectionComponent = React.ComponentType<{ data: unknown }>;

// 3. MAPA DE COMPONENTS
// Fem servir 'as unknown as SectionComponent' per compatibilitzar els tipus estrictes de cada component
// amb el tipus gen√®ric del mapa. Aix√≤ √©s segur i evita l'√∫s d''any'.
const COMPONENTS: Record<string, SectionComponent | null> = {
  hero: HeroSection as unknown as SectionComponent,
  services: ServicesSection as unknown as SectionComponent,
  contact: ContactSection as unknown as SectionComponent,
  stats: StatsSection as unknown as SectionComponent,
  testimonials: TestimonialsSection as unknown as SectionComponent,
  map: MapSection as unknown as SectionComponent,
  cta_banner: CTABannerSection as unknown as SectionComponent,
  faq: FAQSection as unknown as SectionComponent,
  featured_products: FeaturedProductsSection as unknown as SectionComponent,
  about: AboutSection as unknown as SectionComponent, // üëà Registre nou
};

type Props = {
  params: Promise<{ locale: string }>;
};

export default async function DynamicLandingPage({ params }: Props) {
  const { locale } = await params;
  
  // 4. C√†rrega de Dades
  const sections = await marketingService.getLandingPageData(locale);
  const dbServices = await getServices();

  if (!sections.length) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-background">
        <div className="text-center">
          <h1 className="text-2xl font-bold">Web en construcci√≥</h1>
          <p className="text-muted-foreground">Configura les seccions a digitai.config.ts</p>
        </div>
      </div>
    );
  }

  return (
    <main className="min-h-screen">
      {sections.map((section) => {
        
        // 5. CAS ESPECIAL: SERVEIS (Injectem dades reals de DB)
        if (section.type === 'services') {
            // Casting segur en dos passos: unknown -> Tipus Correcte
            // Aix√≤ evita l'error de "types do not overlap"
            const content = section.content as unknown as ServiceContent;

            return (
                <ServicesSection 
                    key={section.id} 
                    headerData={content} 
                    services={dbServices} 
                />
            );
        }

        // 6. CAS GEN√àRIC (Renderitzat autom√†tic del config)
        const Component = COMPONENTS[section.type];
        
        if (!Component) {
          // Warning en desenvolupament nom√©s
          if (process.env.NODE_ENV === 'development') {
             console.warn(`‚ö†Ô∏è Secci√≥ desconeguda: "${section.type}"`);
          }
          return null;
        }

        return <Component key={section.id} data={section.content} />;
      })}
    </main>
  );
}

// =================== FILE: src/app/[locale]/(public)/shop/page.tsx ===================

//src\app\[locale]\(public)\shop\page.tsx

import { getProductsAction } from '@/features/ecommerce/actions';
import { ProductGrid } from '@/components/modules/ecommerce/product-grid';
import { ShoppingBag } from 'lucide-react';
import { CONFIG } from '@/config/digitai.config';

export const metadata = {
  title: `Botiga | ${CONFIG.identity.name}`,
  description: 'Descobreix els nostres productes exclusius.',
};

export default async function ShopPage() {
  // 1. Fetch de dades al servidor (R√†pid i segur)
  const products = await getProductsAction();

  return (
    <div className="min-h-screen bg-background">
      {/* Header de la Botiga */}
      <div className="bg-secondary/5 border-b border-border py-16 md:py-24">
        <div className="container mx-auto px-4 text-center">
            <div className="inline-flex items-center justify-center p-4 bg-primary/10 rounded-full mb-6 text-primary">
                <ShoppingBag className="w-8 h-8" />
            </div>
            <h1 className="text-4xl md:text-5xl font-extrabold mb-4 text-foreground">
                La Nostra Botiga
            </h1>
            <p className="text-xl text-muted-foreground max-w-2xl mx-auto">
                Explora la nostra col¬∑lecci√≥ de productes seleccionats especialment per a tu. Qualitat garantida.
            </p>
        </div>
      </div>

      {/* Grid de Productes */}
      <div className="container mx-auto px-4 py-16">
         {products.length > 0 ? (
             <ProductGrid products={products} />
         ) : (
             <div className="text-center py-20 bg-muted/20 rounded-3xl border border-dashed border-border">
                 <p className="text-xl text-muted-foreground">Encara no hi ha productes disponibles.</p>
                 <p className="text-sm mt-2">Torna m√©s tard!</p>
             </div>
         )}
      </div>
    </div>
  );
}

// =================== FILE: src/app/[locale]/(public)/shop/[slug]/page.tsx ===================

//src\app\[locale]\(public)\shop\[slug]\page.tsx

import { getProductBySlugAction } from '@/features/ecommerce/actions';
import { ProductGallery } from '@/components/modules/ecommerce/product-gallery';
import { ProductActions } from '@/components/modules/ecommerce/product-actions';
import { notFound } from 'next/navigation';
import Link from 'next/link';
import { ArrowLeft, Truck, ShieldCheck, Edit } from 'lucide-react';
import { authService } from '@/services/container';
import { createClient } from '@/lib/supabase/server';
interface Props {
  params: Promise<{ slug: string; locale: string }>;
}

export async function generateMetadata({ params }: Props) {
  const { slug } = await params;
  const product = await getProductBySlugAction(slug);
  if (!product) return { title: 'Producte no trobat' };

  return {
    title: `${product.name} | Botiga`,
    description: product.description
  };
}

export default async function ProductDetailPage({ params }: Props) {
  const { slug, locale } = await params;
  const product = await getProductBySlugAction(slug);

  if (!product) notFound();
  // 1. Obtenim sessi√≥
  const supabase = await createClient();
  const { data: { user } } = await supabase.auth.getUser();

  // 2. Comprovem Admin
  const isAdmin = user ? await authService.isAdmin(user.id, process.env.NEXT_PUBLIC_ORG_ID!) : false;

  return (
    <div className="min-h-screen bg-background py-12 md:py-20">
      <div className="container mx-auto px-4 max-w-6xl">

        {/* Breadcrumb / Back */}
        <Link href={`/${locale}/shop`} className="inline-flex items-center text-muted-foreground hover:text-primary mb-8 transition-colors">
          <ArrowLeft className="w-4 h-4 mr-2" /> Tornar a la botiga
        </Link>
        {/* üëá BOT√ì SECRET D'ADMIN */}
        {isAdmin && (
          <div className="mb-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg flex justify-between items-center">
            <span className="text-sm text-yellow-800 font-bold">Visi√≥ d'Administrador</span>
            <Link href={`/${locale}/admin/products/${product.id}/edit`}>
              <button className="flex items-center gap-2 bg-white border border-yellow-300 px-3 py-1 rounded text-sm hover:bg-yellow-100">
                <Edit size={14} /> Editar Producte
              </button>
            </Link>
          </div>
        )}
        <div className="grid md:grid-cols-2 gap-12 lg:gap-20">

          {/* Esquerra: Galeria */}
          <div>
            <ProductGallery images={product.images} title={product.name} />
          </div>

          {/* Dreta: Informaci√≥ */}
          <div className="flex flex-col h-full">
            <div className="mb-6">
              <h1 className="text-4xl md:text-5xl font-extrabold text-foreground mb-4 leading-tight">
                {product.name}
              </h1>
              <div className="flex items-baseline gap-4">
                <span className="text-3xl font-bold text-primary">{product.price} ‚Ç¨</span>
                {product.stock < 5 && (
                  <span className="text-sm font-bold text-red-500 bg-red-50 px-2 py-1 rounded">
                    Nom√©s {product.stock} unitats!
                  </span>
                )}
              </div>
            </div>

            <div className="prose prose-lg text-muted-foreground mb-8">
              <p>{product.description || "Sense descripci√≥ detallada per aquest producte."}</p>
            </div>

            <div className="mt-auto space-y-6">
              {/* Bot√≥ de compra (Client Component) */}
              <ProductActions product={product} />

              {/* Trust Badges (Est√®tica Pro) */}
              <div className="grid grid-cols-2 gap-4 text-sm text-muted-foreground pt-6 border-t border-border">
                <div className="flex items-center gap-2">
                  <Truck className="w-5 h-5 text-primary" />
                  <span>Enviament r√†pid 24/48h</span>
                </div>
                <div className="flex items-center gap-2">
                  <ShieldCheck className="w-5 h-5 text-primary" />
                  <span>Garantia de devoluci√≥</span>
                </div>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  );
}

// =================== FILE: src/app/[locale]/layout.tsx ===================

import type { Metadata } from "next";
import { Inter } from "next/font/google";
import { NextIntlClientProvider } from 'next-intl';
import { getMessages } from 'next-intl/server';
import { notFound } from 'next/navigation';
import { ThemeInjector } from "@/components/providers/theme-injector";
import { ThemeProvider } from "@/components/providers/theme-provider"; // üëà 1. IMPORTAR AIX√í
import { CONFIG } from "@/config/digitai.config";
import "../globals.css";
import { Toaster } from 'sonner';

const inter = Inter({ subsets: ["latin"] });

export const metadata: Metadata = {
  title: CONFIG.identity.name,
  description: CONFIG.identity.description,
  icons: { icon: CONFIG.identity.faviconUrl }
};

export default async function LocaleLayout({
  children,
  params
}: {
  children: React.ReactNode;
  params: Promise<{ locale: string }>;
}) {
  const { locale } = await params;

  if (!CONFIG.i18n.locales.includes(locale)) {
    notFound();
  }

  const messages = await getMessages();

  return (
    // üëà 2. suppressHydrationWarning √©s OBLIGATORI per next-themes
    <html lang={locale} suppressHydrationWarning>
      <head>
        {/* Injector de colors CSS (Primary, radius...) */}
        <ThemeInjector />
      </head>
      <body className={inter.className}>
        {/* üëà 3. WRAPPER DE TEMA
            attribute="class": Canvia la classe 'dark' al <html>
            defaultTheme="system": Respecta la prefer√®ncia del SO
            enableSystem: Permet canviar autom√†ticament
        */}
        <ThemeProvider
            attribute="class"
            defaultTheme="system"
            enableSystem
            disableTransitionOnChange
        >
            <NextIntlClientProvider messages={messages}>
              {children}
              <Toaster position="top-center" richColors />
            </NextIntlClientProvider>
        </ThemeProvider>
      </body>
    </html>
  );
}

// =================== FILE: src/components/icons/flags.tsx ===================

export function FlagCA({ className }: { className?: string }) {
  return (
    <svg viewBox="0 0 32 24" className={className} xmlns="http://www.w3.org/2000/svg">
      <rect width="32" height="24" fill="#FFD100"/>
      <g fill="#D52B1E">
        <rect y="4.8" width="32" height="2.4"/>
        <rect y="9.6" width="32" height="2.4"/>
        <rect y="14.4" width="32" height="2.4"/>
        <rect y="19.2" width="32" height="2.4"/>
      </g>
    </svg>
  );
}

export function FlagES({ className }: { className?: string }) {
  return (
    <svg viewBox="0 0 32 24" className={className} xmlns="http://www.w3.org/2000/svg">
      <rect width="32" height="24" fill="#AA151B"/>
      <rect y="6" width="32" height="12" fill="#F1BF00"/>
    </svg>
  );
}

export function FlagGB({ className }: { className?: string }) {
  return (
    <svg viewBox="0 0 32 24" className={className} xmlns="http://www.w3.org/2000/svg">
      <rect width="32" height="24" fill="#00247D"/>
      <path d="M0,0 L32,24 M32,0 L0,24" stroke="#FFF" strokeWidth="3"/>
      <path d="M0,0 L32,24 M32,0 L0,24" stroke="#CF142B" strokeWidth="1.5"/>
      <path d="M16,0 V24 M0,12 H32" stroke="#FFF" strokeWidth="5"/>
      <path d="M16,0 V24 M0,12 H32" stroke="#CF142B" strokeWidth="2.5"/>
    </svg>
  );
}

// =================== FILE: src/components/layout/app-mobile-bar.tsx ===================

'use client';

import Link from 'next/link';
import { 
  LayoutDashboard, ShoppingBag, Store, 
  List, FileText, Package, User, Globe, Menu, X 
} from 'lucide-react';
import { CONFIG } from '@/config/digitai.config';
import { useLocale } from 'next-intl';
import { useState } from 'react';
import { motion, AnimatePresence } from 'framer-motion';

export function AppMobileBar({ user }: { user: { role?: string } }) {
  const locale = useLocale();
  const isAdmin = user?.role === 'admin';
  const { modules } = CONFIG;
  const [isOpen, setIsOpen] = useState(false);

  // LINKS ADMIN
  const adminLinks = [
    { href: '/dashboard', icon: LayoutDashboard, label: 'Resum' },
    { href: '/products', icon: Store, label: 'Productes', show: modules.ecommerce },
    { href: '/orders', icon: ShoppingBag, label: 'Comandes', show: modules.ecommerce },
    { href: '/services', icon: List, label: 'Serveis', show: modules.booking },
    { href: '/blog-manager', icon: FileText, label: 'Blog', show: modules.blog },
    { href: '/inventory', icon: Package, label: 'Inventari', show: modules.inventory },
  ].filter(l => l.show !== false);

  // LINKS CLIENT
  const clientLinks = [
    { href: '/my-account', icon: User, label: 'Perfil' },
    // Afegir m√©s si cal
  ];

  const links = isAdmin ? adminLinks : clientLinks;
  
  // Mostrem max 4 fixes + men√∫
  const fixed = links.slice(0, 4);
  const more = links.slice(4);

  return (
    <>
      <AnimatePresence>
        {isOpen && (
            <motion.div initial={{ y: '100%' }} animate={{ y: 0 }} exit={{ y: '100%' }} className="fixed inset-x-0 bottom-0 z-60 bg-white rounded-t-2xl shadow-2xl p-4 pb-24 md:hidden">
                <div className="grid grid-cols-3 gap-4">
                    {more.map(l => (
                        <Link key={l.href} href={`/${locale}${l.href}`} onClick={() => setIsOpen(false)} className="flex flex-col items-center gap-2 p-3 bg-slate-50 rounded-xl">
                            <l.icon size={24} className="text-primary"/> <span className="text-xs">{l.label}</span>
                        </Link>
                    ))}
                    {isAdmin && (
                        <Link href={`/${locale}`} className="flex flex-col items-center gap-2 p-3 bg-slate-900 text-white rounded-xl col-span-3">
                            <Globe size={24} /> <span className="text-xs font-bold">Anar a Web P√∫blica</span>
                        </Link>
                    )}
                </div>
            </motion.div>
        )}
      </AnimatePresence>

      <div className="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 px-4 py-2 z-50">
        <div className="flex justify-around items-center">
            {fixed.map(link => (
                <Link key={link.href} href={`/${locale}${link.href}`} className="flex flex-col items-center gap-1 text-slate-500">
                    <link.icon size={24} />
                    <span className="text-[10px]">{link.label}</span>
                </Link>
            ))}
            {more.length > 0 || isAdmin ? (
                <button onClick={() => setIsOpen(!isOpen)} className="flex flex-col items-center gap-1 text-slate-500">
                    {isOpen ? <X size={24} /> : <Menu size={24} />}
                    <span className="text-[10px]">M√©s</span>
                </button>
            ) : null}
        </div>
      </div>
    </>
  );
}

// =================== FILE: src/components/layout/footer.tsx ===================

'use client';

import Link from 'next/link';
import { CONFIG } from '@/config/digitai.config';
// üëá Importem LucideIcon per evitar 'any'
import { Twitter, Instagram, Linkedin, Hexagon, Heart, LucideIcon } from 'lucide-react';

export function Footer() {
  const { identity, footer } = CONFIG;
  const currentYear = new Date().getFullYear();

  return (
    <footer className="relative bg-[#0a0a0a] text-white pt-24 pb-12 overflow-hidden border-t border-white/10">
      
      {/* üé® TEXTURA DE FONS & GLOW */}
      <div className="absolute inset-0 opacity-[0.03] pointer-events-none bg-[url('https://grainy-gradients.vercel.app/noise.svg')] bg-repeat" />
      
      <div className="absolute top-0 left-1/2 -translate-x-1/2 w-200 h-25 bg-primary/20 blur-[100px] opacity-30 pointer-events-none" />

      <div className="container mx-auto px-4 relative z-10">
        
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-12 gap-12 lg:gap-8 mb-20">
          
          {/* COLUMNA 1: BRANDING */}
          <div className="lg:col-span-4 space-y-8">
            <Link href="/" className="inline-flex items-center gap-3 group">
               <div className="p-2.5 bg-white/5 border border-white/10 rounded-xl group-hover:bg-primary/20 group-hover:border-primary/50 transition-all duration-500">
                  <Hexagon className="w-6 h-6 text-white group-hover:text-primary transition-colors" />
               </div>
               <span className="text-2xl font-black tracking-tight text-white group-hover:tracking-wide transition-all duration-500">
                 {identity.name}
               </span>
            </Link>
            
            <p className="text-zinc-400 leading-relaxed max-w-sm text-sm">
              {identity.description}
            </p>
            
            <div className="flex gap-3">
              {footer.socials?.twitter && <SocialButton href={footer.socials.twitter} icon={Twitter} />}
              {footer.socials?.instagram && <SocialButton href={footer.socials.instagram} icon={Instagram} />}
              {footer.socials?.linkedin && <SocialButton href={footer.socials.linkedin} icon={Linkedin} />}
            </div>
          </div>

          <div className="hidden lg:block lg:col-span-2" />

          {/* COLUMNES DIN√ÄMIQUES */}
          <div className="lg:col-span-6 grid grid-cols-2 md:grid-cols-3 gap-8">
              {footer.columns.map((col, idx) => (
                <div key={idx}>
                  <h3 className="font-bold text-white mb-6 text-sm uppercase tracking-wider opacity-90">{col.title}</h3>
                  <ul className="space-y-4">
                    {col.links.map((link, lIdx) => (
                      <li key={lIdx}>
                        <Link 
                          href={link.href} 
                          className="group flex items-center gap-2 text-zinc-400 hover:text-primary transition-colors text-sm"
                        >
                          <span className="w-1.5 h-1.5 rounded-full bg-primary/0 group-hover:bg-primary transition-all duration-300 scale-0 group-hover:scale-100" />
                          <span className="group-hover:translate-x-1 transition-transform duration-300">
                            {link.label}
                          </span>
                        </Link>
                      </li>
                    ))}
                  </ul>
                </div>
              ))}
          </div>

        </div>

        {/* --- BOTTOM BAR --- */}
        <div className="border-t border-white/10 pt-8 flex flex-col md:flex-row justify-between items-center gap-6">
          <p className="text-xs text-zinc-500 font-medium">
            ¬© {currentYear} {identity.name}. {footer.bottomText.replace(/\d{4}/, '')}
          </p>
          
          <div className="flex items-center gap-6">
             <div className="flex items-center gap-2 text-xs text-zinc-500 bg-white/5 px-4 py-2 rounded-full border border-white/5">
                <span>Fet amb</span>
                <Heart className="w-3 h-3 text-red-500 fill-red-500 animate-pulse" />
                <span>per <span className="text-zinc-300 font-bold">{identity.name}</span></span>
             </div>
          </div>
        </div>
      </div>
    </footer>
  );
}

// ‚ú® Component Auxiliar Correctament Tipat
interface SocialButtonProps {
    href: string;
    icon: LucideIcon; // üëà CORRECCI√ì: Substitu√Øt 'any' per 'LucideIcon'
}

function SocialButton({ href, icon: Icon }: SocialButtonProps) {
    return (
        <a 
            href={href} 
            target="_blank" 
            rel="noopener noreferrer" 
            className="group relative flex items-center justify-center w-10 h-10 rounded-full bg-white/5 border border-white/10 overflow-hidden hover:border-primary/50 transition-colors"
        >
            <div className="absolute inset-0 bg-primary translate-y-full group-hover:translate-y-0 transition-transform duration-300 ease-out" />
            <Icon className="w-4 h-4 text-zinc-400 relative z-10 group-hover:text-white transition-colors duration-300" />
        </a>
    )
}

// =================== FILE: src/components/layout/navbar.tsx ===================

'use client';

import Link from 'next/link';
import { usePathname } from 'next/navigation';
import { useTranslations, useLocale } from 'next-intl';
import { CONFIG } from '@/config/digitai.config';
import { ShoppingBag, Menu, X } from 'lucide-react';
import { cn } from '@/lib/utils'; // Useu cn en lloc de clsx pur per mergejar classes
import { User } from '@supabase/supabase-js';
import { useCartStore } from '@/lib/store/cart-store';
import { ThemeToggle } from '@/components/ui/theme-toggle';
import { LanguageSwitcher } from '@/components/ui/lang-switcher'; // üëà El nou component
import { useState, useEffect } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { SiteLogo } from '@/components/layout/SiteLogo';
export function Navbar({ user }: { user: User | null }) {
  const t = useTranslations('Navbar');
  const locale = useLocale();
  const pathname = usePathname();
  const isShop = CONFIG.modules.ecommerce;
  const toggleCart = useCartStore(state => state.toggleCart);

  const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);
  const [isScrolled, setIsScrolled] = useState(false);

  // Detectar scroll per afegir ombra/blur
  useEffect(() => {
    const handleScroll = () => setIsScrolled(window.scrollY > 20);
    window.addEventListener('scroll', handleScroll);
    return () => window.removeEventListener('scroll', handleScroll);
  }, []);

  const getLink = (path: string) => `/${locale}${path}`;
  // Funci√≥ millorada per detectar actiu (gestiona subrutes)
  const isActive = (path: string) => pathname === getLink(path) || pathname.startsWith(`${getLink(path)}/`);

  const navLinks = [
    { href: '/services', label: t('links.services') },
    { href: '/blog', label: t('links.blog'), show: CONFIG.modules.blog },
    { href: '/shop', label: 'Botiga', show: CONFIG.modules.ecommerce },
    // Pots afegir m√©s links aqu√≠
  ];

  return (
    <>
      <nav
        className={cn(
          "sticky top-0 z-40 w-full transition-all duration-300 border-b",
          isScrolled
            ? "bg-background/80 backdrop-blur-xl border-border/60 shadow-sm"
            : "bg-background/0 border-transparent" // Transparent al principi
        )}
      >
        <div className="container relative flex h-20 items-center justify-between px-4 md:px-6">

          {/* --- 1. ESQUERRA: LOGO --- */}
          <div className="flex-1 flex justify-start">
            {/* üëá SUBSTITU√èM TOT EL BLOC DE LINK MANUAL PEL COMPONENT INTEL¬∑LIGENT */}
            <SiteLogo />
          </div>

          {/* --- 2. CENTRE: NAV LINKS (Absolute Center) --- */}
          {/* Aix√≤ garanteix que estigui centrat respecte a la pantalla, no a l'espai sobrant */}
          <div className="hidden md:flex absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2">
            <div className="flex items-center gap-1 bg-secondary/30 p-1.5 rounded-full border border-border/50 backdrop-blur-md">
              {navLinks.filter(l => l.show !== false).map((link) => {
                const active = isActive(link.href);
                return (
                  <Link
                    key={link.href}
                    href={getLink(link.href)}
                    className={cn(
                      "relative px-5 py-2 rounded-full text-sm font-medium transition-all duration-300",
                      active ? "text-primary-foreground" : "text-muted-foreground hover:text-foreground hover:bg-background/50"
                    )}
                  >
                    {/* Fons animat "Pill" per l'actiu */}
                    {active && (
                      <motion.div
                        layoutId="navbar-pill"
                        className="absolute inset-0 bg-primary rounded-full shadow-md shadow-primary/20 -z-10"
                        transition={{ type: "spring", stiffness: 300, damping: 30 }}
                      />
                    )}
                    {link.label}
                  </Link>
                )
              })}
            </div>
          </div>

          {/* --- 3. DRETA: ACTIONS --- */}
          <div className="flex-1 flex justify-end items-center gap-2 sm:gap-3">

            {/* Toggles (Desktop only visualmente agrupat) */}
            <div className="hidden sm:flex items-center gap-1 bg-secondary/30 rounded-full p-1 border border-border/50">
              <LanguageSwitcher />
              <div className="w-px h-4 bg-border/50 mx-1" />
              <ThemeToggle />
            </div>

            {/* Cart */}
            {isShop && (
              <button
                onClick={toggleCart}
                className="relative p-2.5 rounded-full hover:bg-secondary transition-colors group"
              >
                <ShoppingBag className="w-5 h-5 text-foreground group-hover:text-primary transition-colors" />
                {/* Opcional: Badge de quantitat */}
                {/* <span className="absolute top-0 right-0 w-2 h-2 bg-red-500 rounded-full" /> */}
              </button>
            )}

            {/* User / Login */}
            {user ? (
              <Link href="/dashboard" className="hidden sm:block">
                <div className="w-10 h-10 rounded-full bg-linear-to-tr from-primary to-primary/60 p-0.5 cursor-pointer hover:scale-105 transition-transform">
                  <div className="w-full h-full rounded-full bg-background flex items-center justify-center overflow-hidden">
                    {/* Si tens avatar, posa <Image> aqu√≠ */}
                    <span className="font-bold text-sm text-primary">
                      {user.email?.[0].toUpperCase()}
                    </span>
                  </div>
                </div>
              </Link>
            ) : (
              <Link href="/auth/login" className="hidden sm:block">
                <button className="bg-foreground text-background hover:bg-foreground/80 px-6 py-2.5 rounded-full font-bold text-sm transition-all shadow-lg hover:shadow-xl">
                  {t('cta')}
                </button>
              </Link>
            )}

            {/* Mobile Menu Button */}
            <button
              onClick={() => setIsMobileMenuOpen(!isMobileMenuOpen)}
              className="md:hidden p-2 text-foreground"
            >
              {isMobileMenuOpen ? <X className="w-6 h-6" /> : <Menu className="w-6 h-6" />}
            </button>
          </div>
        </div>
      </nav>

      {/* --- MOBILE MENU OVERLAY --- */}
      <AnimatePresence>
        {isMobileMenuOpen && (
          <motion.div
            initial={{ opacity: 0, y: -20 }}
            animate={{ opacity: 1, y: 0 }}
            exit={{ opacity: 0, y: -20 }}
            className="fixed inset-x-0 top-20 z-30 bg-background/95 backdrop-blur-2xl border-b border-border shadow-2xl md:hidden p-6 flex flex-col gap-6"
          >
            <nav className="flex flex-col gap-2">
              {navLinks.filter(l => l.show !== false).map((link) => (
                <Link
                  key={link.href}
                  href={getLink(link.href)}
                  onClick={() => setIsMobileMenuOpen(false)}
                  className={cn(
                    "text-lg font-bold py-3 px-4 rounded-xl transition-colors",
                    isActive(link.href) ? "bg-primary/10 text-primary" : "text-foreground hover:bg-secondary"
                  )}
                >
                  {link.label}
                </Link>
              ))}
            </nav>

            <div className="h-px bg-border/50 w-full" />

            <div className="flex flex-col gap-4">
              <div className="flex justify-between items-center">
                <span className="text-sm font-medium text-muted-foreground">Idioma</span>
                <LanguageSwitcher />
              </div>
              <div className="flex justify-between items-center">
                <span className="text-sm font-medium text-muted-foreground">Tema</span>
                <ThemeToggle />
              </div>
            </div>

            {!user && (
              <Link href="/auth/login" onClick={() => setIsMobileMenuOpen(false)}>
                <button className="w-full bg-primary text-primary-foreground py-3.5 rounded-xl font-bold shadow-lg">
                  {t('cta')}
                </button>
              </Link>
            )}
          </motion.div>
        )}
      </AnimatePresence>
    </>
  );
}

// =================== FILE: src/components/layout/public-mobil-bar.tsx ===================

'use client';

import Link from 'next/link';
import { usePathname } from 'next/navigation';
import { Home, ShoppingBag, Calendar, User } from 'lucide-react';
import { CONFIG } from '@/config/digitai.config';
import { useCartStore } from '@/lib/store/cart-store';
import { useLocale } from 'next-intl';
type UserSummary = {
  email: string;
  full_name?: string | null;
  role?: string;
};
export function PublicMobileBar({ user }: { user: UserSummary | null}) {
  const pathname = usePathname();
  const locale = useLocale();
  const cartCount = useCartStore(s => s.items.length);
  const { modules } = CONFIG;

  const links = [
    { href: '/', icon: Home, label: 'Inici', show: true },
    { href: '/shop', icon: ShoppingBag, label: 'Botiga', show: modules.ecommerce, badge: cartCount },
    { href: '/book', icon: Calendar, label: 'Cites', show: modules.booking },
    { 
      href: user ? (user.role === 'admin' ? '/dashboard' : '/my-account') : '/auth/login', 
      icon: User, 
      label: user ? 'Compte' : 'Login', 
      show: true 
    }
  ];

  return (
    <div className="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 px-4 py-2 z-50">
      <div className="flex justify-around items-center">
        {links.filter(l => l.show).map((link) => {
          const href = `/${locale}${link.href === '/' ? '' : link.href}`;
          const isActive = pathname === href;
          return (
            <Link key={link.label} href={href} className={`flex flex-col items-center gap-1 ${isActive ? 'text-primary' : 'text-slate-400'}`}>
              <div className="relative">
                <link.icon className="w-6 h-6" />
                {link.badge ? <span className="absolute -top-1 -right-1 w-4 h-4 bg-red-500 text-white text-[9px] rounded-full flex items-center justify-center">{link.badge}</span> : null}
              </div>
              <span className="text-[10px] font-medium">{link.label}</span>
            </Link>
          );
        })}
      </div>
    </div>
  );
}

// =================== FILE: src/components/layout/SiteLogo.tsx ===================

// src/components/layout/SiteLogo.tsx
import Image from 'next/image';
import Link from 'next/link';
import { CONFIG } from '@/config/digitai.config';
import { Hexagon } from 'lucide-react'; // Fallback

interface Props {
  className?: string;
}

export function SiteLogo({ className }: Props) {
  const { name, logoUrl } = CONFIG.identity;

  return (
    <Link href="/" className={`flex items-center gap-2.5 group ${className}`}>
      
      {/* 1. Intentem mostrar la imatge si existeix */}
      {logoUrl ? (
        <div className="relative w-10 h-10 overflow-hidden rounded-xl">
          <Image 
            src={logoUrl} 
            alt={`${name} Logo`} 
            fill
            className="object-contain"
            sizes="40px"
            priority // Important per al LCP
          />
        </div>
      ) : (
        // 2. Fallback si no hi ha logo (Hexagon)
        <div className="p-2 bg-primary/10 rounded-xl group-hover:bg-primary group-hover:text-primary-foreground transition-colors duration-500">
            <Hexagon className="w-6 h-6 text-primary group-hover:text-white transition-colors" />
        </div>
      )}

      {/* Nom de l'empresa */}
      <span className="font-bold text-xl tracking-tight text-foreground group-hover:text-primary transition-colors hidden lg:inline-block">
        {name}
      </span>
    </Link>
  );
}

// =================== FILE: src/components/modules/ai/chat-widget.tsx ===================

'use client';

import { useState, useRef, useEffect } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { MessageSquare, X, Send, Bot, Loader2 } from 'lucide-react';
import ReactMarkdown from 'react-markdown';

type Message = {
    role: 'user' | 'assistant';
    content: string;
};

export function ChatWidget() {
    const [isOpen, setIsOpen] = useState(false);
    const [messages, setMessages] = useState<Message[]>([
        { role: 'assistant', content: 'Hola! üëã En qu√® et puc ajudar avui?' }
    ]);
    const [input, setInput] = useState('');
    const [isLoading, setIsLoading] = useState(false);
    const scrollRef = useRef<HTMLDivElement>(null);

    // Auto-scroll al fons
    useEffect(() => {
        if (scrollRef.current) {
            scrollRef.current.scrollTop = scrollRef.current.scrollHeight;
        }
    }, [messages, isOpen]);

    const handleSubmit = async (e: React.FormEvent) => {
        e.preventDefault();
        if (!input.trim() || isLoading) return;

        const userMsg: Message = { role: 'user', content: input };
        setMessages(prev => [...prev, userMsg]);
        setInput('');
        setIsLoading(true);

        try {
            const res = await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ messages: [...messages, userMsg] })
            });

            const data = await res.json();
            if (data.content) {
                setMessages(prev => [...prev, { role: 'assistant', content: data.content }]);
            }
        } catch (error) {
            console.log(error)
            setMessages(prev => [...prev, { role: 'assistant', content: "Ho sento, tinc problemes de connexi√≥ ara mateix." }]);
        } finally {
            setIsLoading(false);
        }
    };

    return (
        <div className="fixed bottom-6 right-6 z-50 flex flex-col items-end">

            <AnimatePresence>
                {isOpen && (
                    <motion.div
                        initial={{ opacity: 0, y: 20, scale: 0.9 }}
                        animate={{ opacity: 1, y: 0, scale: 1 }}
                        exit={{ opacity: 0, y: 20, scale: 0.9 }}
                        className="mb-4 w-[350px] sm:w-[400px] h-[500px] bg-background border border-border rounded-2xl shadow-2xl flex flex-col overflow-hidden"
                    >
                        {/* Header */}
                        <div className="bg-primary p-4 flex justify-between items-center text-primary-foreground">
                            <div className="flex items-center gap-2">
                                <Bot className="w-6 h-6" />
                                <span className="font-bold">Assistent Virtual</span>
                            </div>
                            <button onClick={() => setIsOpen(false)} className="hover:bg-white/20 p-1 rounded transition-colors">
                                <X className="w-5 h-5" />
                            </button>
                        </div>

                        {/* Messages Area */}
                        <div ref={scrollRef} className="flex-1 p-4 overflow-y-auto space-y-4 bg-secondary/5">
                            {messages.map((msg, i) => (
                                <div key={i} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                    <div className={`max-w-[85%] p-3 rounded-2xl text-sm ${msg.role === 'user'
                                            ? 'bg-primary text-primary-foreground rounded-br-none'
                                            : 'bg-white border border-border text-foreground rounded-bl-none shadow-sm'
                                        }`}>
                                        <ReactMarkdown>{msg.content}</ReactMarkdown>
                                    </div>
                                </div>
                            ))}
                            {isLoading && (
                                <div className="flex justify-start">
                                    <div className="bg-white border border-border p-3 rounded-2xl rounded-bl-none shadow-sm flex gap-1">
                                        <span className="w-2 h-2 bg-primary/50 rounded-full animate-bounce" />
                                        <span className="w-2 h-2 bg-primary/50 rounded-full animate-bounce delay-75" />
                                        <span className="w-2 h-2 bg-primary/50 rounded-full animate-bounce delay-150" />
                                    </div>
                                </div>
                            )}
                        </div>

                        {/* Input Area */}
                        <form onSubmit={handleSubmit} className="p-4 bg-background border-t border-border flex gap-2">
                            <input
                                value={input}
                                onChange={(e) => setInput(e.target.value)}
                                placeholder="Escriu la teva pregunta..."
                                className="flex-1 p-2 bg-muted/20 border border-border rounded-lg text-sm focus:ring-2 focus:ring-primary outline-none"
                            />
                            <button
                                type="submit"
                                disabled={isLoading || !input.trim()}
                                className="p-2 bg-primary text-primary-foreground rounded-lg hover:opacity-90 disabled:opacity-50 transition-all"
                            >
                                {isLoading ? <Loader2 className="w-5 h-5 animate-spin" /> : <Send className="w-5 h-5" />}
                            </button>
                        </form>
                    </motion.div>
                )}
            </AnimatePresence>

            {/* Toggle Button */}
            <motion.button
                whileHover={{ scale: 1.1 }}
                whileTap={{ scale: 0.9 }}
                onClick={() => setIsOpen(!isOpen)}
                className="w-14 h-14 bg-primary text-primary-foreground rounded-full shadow-lg flex items-center justify-center hover:shadow-primary/50 transition-shadow"
            >
                {isOpen ? <X className="w-8 h-8" /> : <MessageSquare className="w-7 h-7" />}
            </motion.button>
        </div>
    );
}

// =================== FILE: src/components/modules/ai/__tests__/ChatWidget.test.tsx ===================

import { render, screen, fireEvent, waitFor } from '@testing-library/react';
import { describe, it, expect, vi, beforeEach } from 'vitest';
import { ChatWidget } from '../chat-widget'; 

// Mock globals
global.fetch = vi.fn();
window.HTMLElement.prototype.scrollIntoView = vi.fn();

describe('ChatWidget Component', () => {
  beforeEach(() => {
    vi.clearAllMocks();
  });

  it('hauria d\'obrir-se al clicar', () => {
    render(<ChatWidget />);
    // Inicialment nom√©s hi ha 1 bot√≥ (el Toggle)
    fireEvent.click(screen.getByRole('button')); 
    expect(screen.getByText(/Hola!/i)).toBeInTheDocument();
  });

  it('hauria d\'enviar un missatge i mostrar la resposta', async () => {
    const { container } = render(<ChatWidget />);
    
    // 1. Obrim el xat (Bot√≥ Toggle)
    fireEvent.click(screen.getByRole('button'));

    // 2. Mock de l'API
    vi.mocked(global.fetch).mockResolvedValue({
      json: async () => ({ content: 'Soc la IA responent' }),
      ok: true
    } as Response);

    // 3. Escriure a l'input
    const input = screen.getByPlaceholderText(/Escriu la teva pregunta/i);
    fireEvent.change(input, { target: { value: 'Com et dius?' } });

    // ‚úÖ FIX: Buscar el bot√≥ d'enviar espec√≠ficament pel seu tipus
    // Aix√≠ evitem clicar el bot√≥ Toggle (que tancaria el xat) o el bot√≥ X
    const submitBtn = container.querySelector('button[type="submit"]');
    if (!submitBtn) throw new Error("No s'ha trobat el bot√≥ de submit");
    
    fireEvent.click(submitBtn); 
    
    // 4. Esperar que el missatge aparegui al xat (ja no a l'input)
    await waitFor(() => {
      expect(screen.getByText('Com et dius?')).toBeInTheDocument();
    });

    // 5. Esperar resposta de la IA
    await waitFor(() => {
      expect(screen.getByText('Soc la IA responent')).toBeInTheDocument();
    });
  });
});

// =================== FILE: src/components/modules/blog/post-form.tsx ===================

'use client';

import { useActionState } from 'react'; // React 19 / Next 15
// Si uses Next 14, seria: import { useFormState } from 'react-dom';
import { createPostAction } from '@/features/blog/actions';

// Estat inicial del formulari
const initialState = {
  error: '',
};

export function CreatePostForm() {
  // Enllacem l'acci√≥ amb l'estat
  const [state, formAction, isPending] = useActionState(createPostAction, initialState);

  return (
    <form action={formAction} className="space-y-6">
      {state?.error && (
        <div className="p-3 bg-red-100 text-red-700 rounded-lg text-sm">
          {state.error}
        </div>
      )}

      <div>
        <label className="block text-sm font-medium mb-1 text-foreground">T√≠tol</label>
        <input name="title" required className="w-full p-3 rounded-lg border border-border bg-background text-foreground focus:ring-2 focus:ring-primary outline-none" placeholder="T√≠tol..." />
      </div>

      <div>
        <label className="block text-sm font-medium mb-1 text-foreground">Descripci√≥ SEO</label>
        <textarea name="description" rows={2} className="w-full p-3 rounded-lg border border-border bg-background text-foreground focus:ring-2 focus:ring-primary outline-none" />
      </div>

      <div>
        <label className="block text-sm font-medium mb-1 text-foreground">Contingut</label>
        <textarea name="content" required rows={10} className="w-full p-3 rounded-lg border border-border bg-background text-foreground font-mono text-sm focus:ring-2 focus:ring-primary outline-none" />
      </div>

      <button 
        type="submit" 
        disabled={isPending}
        className="w-full bg-primary text-primary-foreground font-bold py-3 rounded-lg hover:opacity-90 shadow-lg disabled:opacity-50 transition-all"
      >
        {isPending ? 'Publicant...' : 'Publicar Article'}
      </button>
    </form>
  );
}

// =================== FILE: src/components/modules/booking/BookingWidget.tsx ===================

'use client';

import { useState, useEffect, useActionState } from 'react';
import { format } from 'date-fns';
import { ca } from 'date-fns/locale';
import { AnimatePresence } from 'framer-motion';
import { Service } from '@/types/models';
import { getAvailableSlotsAction, createBookingAction, BookingActionState } from '@/features/booking/actions';
import { Calendar as CalendarIcon, Clock, Check } from 'lucide-react';
import { motion } from 'framer-motion';

// Importem els sub-components (Separaci√≥ de responsabilitats)
import { ServiceList } from './steps/ServiceList';
import { DateTimeSelector } from './steps/DateTimeSelector';
import { BookingForm } from './steps/BookingForm';

const initialState: BookingActionState = { success: false };

export function BookingWidget({ services }: { services: Service[] }) {
    // Estat del Wizard
    const [step, setStep] = useState(1);
    const [selectedService, setSelectedService] = useState<Service | null>(null);
    const [selectedDate, setSelectedDate] = useState<Date | undefined>(undefined);
    const [selectedTime, setSelectedTime] = useState<string | null>(null);
    
    // Estat de Dades (Slots)
    const [slots, setSlots] = useState<string[]>([]);
    const [loadingSlots, setLoadingSlots] = useState(false);

    // Server Action Hook
    const [state, formAction, isPending] = useActionState(createBookingAction, initialState);

    // Fetch Slots Effect
    useEffect(() => {
        if (!selectedDate || !selectedService) {
            setSlots([]);
            return;
        }
        const fetchSlots = async () => {
            setLoadingSlots(true);
            try {
                const dateStr = format(selectedDate, 'yyyy-MM-dd');
                const res = await getAvailableSlotsAction(dateStr, selectedService.id);
                setSlots(res.success && res.slots ? res.slots : []);
            } catch (e) {
                console.log(e)
                setSlots([]);
            } finally {
                setLoadingSlots(false);
            }
        };
        fetchSlots();
    }, [selectedDate, selectedService]);

    // Move to Success Step
    useEffect(() => {
        if (state.success) setStep(4);
    }, [state.success]);

    return (
        <div className="bg-white rounded-3xl shadow-xl border border-border overflow-hidden min-h-150 flex flex-col md:flex-row">
            
            {/* SIDEBAR (Context permanent) */}
            <div className="md:w-1/3 bg-slate-50 p-8 border-r border-border flex flex-col">
                <h3 className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-8">La teva reserva</h3>
                {selectedService ? (
                    <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} className="mb-6">
                        <h2 className="text-2xl font-bold text-slate-800 mb-2">{selectedService.title}</h2>
                        <div className="flex items-center text-slate-500 gap-2 text-sm mb-4">
                            <Clock className="w-4 h-4" /> {selectedService.duration_minutes} min
                        </div>
                    </motion.div>
                ) : (
                    <p className="text-slate-400 italic">Selecciona un servei...</p>
                )}

                <div className="mt-auto space-y-4">
                    {selectedDate && (
                        <div className="flex items-center gap-3 text-slate-700 bg-white p-3 rounded-xl border border-slate-100 shadow-sm animate-in fade-in">
                            <CalendarIcon className="w-5 h-5 text-primary" />
                            <span className="font-medium capitalize">{format(selectedDate, 'PPPP', { locale: ca })}</span>
                        </div>
                    )}
                    {selectedTime && (
                        <div className="flex items-center gap-3 text-slate-700 bg-white p-3 rounded-xl border border-slate-100 shadow-sm animate-in fade-in">
                            <Clock className="w-5 h-5 text-primary" />
                            <span className="font-medium">{selectedTime} h</span>
                        </div>
                    )}
                </div>
            </div>

            {/* ZONA PRINCIPAL (Switch de Passos) */}
            <div className="flex-1 p-8 md:p-12 relative overflow-y-auto">
                <AnimatePresence mode="wait">
                    
                    {step === 1 && (
                        <ServiceList 
                            key="step1" 
                            services={services} 
                            onSelect={(s) => { setSelectedService(s); setStep(2); }} 
                        />
                    )}

                    {step === 2 && (
                        <DateTimeSelector
                            key="step2"
                            selectedDate={selectedDate}
                            onDateSelect={setSelectedDate}
                            slots={slots}
                            isLoadingSlots={loadingSlots}
                            onTimeSelect={(t) => { setSelectedTime(t); setStep(3); }}
                            onBack={() => setStep(1)}
                        />
                    )}

                    {step === 3 && selectedService && selectedDate && selectedTime && (
                        <BookingForm
                            key="step3"
                            service={selectedService}
                            date={selectedDate}
                            time={selectedTime}
                            formAction={formAction}
                            isPending={isPending}
                            state={state}
                            onBack={() => setStep(2)}
                        />
                    )}

                    {step === 4 && (
                        <motion.div key="step4" initial={{ scale: 0.8, opacity: 0 }} animate={{ scale: 1, opacity: 1 }} className="flex flex-col items-center justify-center h-full text-center py-12">
                            <div className="w-24 h-24 bg-green-100 text-green-600 rounded-full flex items-center justify-center mb-6 shadow-sm animate-bounce">
                                <Check className="w-12 h-12" />
                            </div>
                            <h2 className="text-3xl font-bold text-slate-900 mb-4">Reserva Confirmada!</h2>
                            <button onClick={() => window.location.reload()} className="px-6 py-3 bg-slate-900 text-white rounded-lg hover:bg-slate-800">
                                Tornar a l'inici
                            </button>
                        </motion.div>
                    )}

                </AnimatePresence>
            </div>
        </div>
    );
}

// =================== FILE: src/components/modules/booking/ServiceFormBuilder.tsx ===================

'use client';

import { useState, useEffect } from 'react';
import { Plus, Trash, GripVertical, Type, AlignLeft, Hash, Phone, Mail } from 'lucide-react';
import { FormField } from '@/types/models';

interface Props {
  initialFields?: FormField[];
  onChange: (fields: FormField[]) => void;
}

export function ServiceFormBuilder({ initialFields = [], onChange }: Props) {
  const [fields, setFields] = useState<FormField[]>(initialFields);

  useEffect(() => {
    onChange(fields);
  }, [fields, onChange]);

  const addField = () => {
    setFields([...fields, { key: '', label: '', type: 'text', required: false }]);
  };

  const removeField = (index: number) => {
    setFields(fields.filter((_, i) => i !== index));
  };

  const updateField = (index: number, key: keyof FormField, value: string | boolean) => {
    const newFields = [...fields];
    
    
    newFields[index] = { ...newFields[index], [key]: value };

    // Auto-generar KEY (slug) des del Label
    if (key === 'label' && typeof value === 'string') {
        const slug = value
            .toLowerCase()
            .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
            .replace(/[^a-z0-9]/g, '_');
        newFields[index].key = slug;
    }

    setFields(newFields);
  };

  const getIcon = (type: string) => {
    switch(type) {
        case 'text': return <Type size={14} />;
        case 'textarea': return <AlignLeft size={14} />;
        case 'number': return <Hash size={14} />;
        case 'tel': return <Phone size={14} />;
        case 'email': return <Mail size={14} />;
        default: return <Type size={14} />;
    }
  };

  return (
    <div className="space-y-4 border border-border p-5 rounded-xl bg-slate-50/50">
      <div className="flex justify-between items-center mb-2">
        <h3 className="font-bold text-sm text-slate-900">Formulari Personalitzat</h3>
        <span className="text-xs bg-slate-200 px-2 py-1 rounded text-slate-600">{fields.length} camps</span>
      </div>
      
      <div className="space-y-3">
        {fields.map((field, idx) => (
            <div key={idx} className="group flex gap-3 items-start bg-white p-3 rounded-lg border border-slate-200 shadow-sm hover:border-primary/30 transition-colors">
                <div className="mt-3 text-slate-300 cursor-move group-hover:text-slate-400">
                    <GripVertical size={16} />
                </div>

                <div className="flex-1 space-y-3">
                    <div className="flex gap-3">
                        <div className="flex-1">
                            <input 
                                placeholder="Nom del camp (ex: Matr√≠cula)" 
                                className="w-full p-2 border border-slate-200 rounded-md text-sm focus:ring-2 focus:ring-primary/20 outline-none font-medium"
                                value={field.label}
                                onChange={(e) => updateField(idx, 'label', e.target.value)}
                            />
                        </div>
                        <div className="w-1/3">
                            <div className="relative">
                                <select 
                                    className="w-full p-2 pl-8 border border-slate-200 rounded-md text-sm bg-slate-50 focus:ring-2 focus:ring-primary/20 outline-none appearance-none"
                                    value={field.type}
                                    onChange={(e) => updateField(idx, 'type', e.target.value)}
                                >
                                    <option value="text">Text Curt</option>
                                    <option value="textarea">Text Llarg</option>
                                    <option value="number">N√∫mero</option>
                                    <option value="tel">Tel√®fon</option>
                                    <option value="email">Email</option>
                                </select>
                                <div className="absolute left-2.5 top-2.5 text-slate-400 pointer-events-none">
                                    {getIcon(field.type)}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div className="flex items-center justify-between text-xs">
                        <div className="flex items-center gap-2">
                             <span className="text-slate-400 font-mono bg-slate-100 px-1.5 py-0.5 rounded border border-slate-200">
                                key: {field.key || '...'}
                            </span>
                            <label className="flex items-center gap-1.5 text-slate-600 cursor-pointer hover:text-slate-900">
                                <input 
                                    type="checkbox" 
                                    className="rounded border-slate-300 text-primary focus:ring-primary"
                                    checked={field.required} 
                                    onChange={(e) => updateField(idx, 'required', e.target.checked)}
                                /> 
                                Obligatori
                            </label>
                        </div>
                        
                        <button 
                            type="button" 
                            onClick={() => removeField(idx)} 
                            className="text-red-400 hover:text-red-600 hover:bg-red-50 px-2 py-1 rounded transition-colors flex items-center gap-1"
                        >
                            <Trash size={12} /> Eliminar
                        </button>
                    </div>
                </div>
            </div>
        ))}
      </div>

      <button 
        type="button" 
        onClick={addField} 
        className="w-full py-2.5 flex items-center justify-center gap-2 text-sm font-medium text-slate-600 bg-white border border-slate-200 border-dashed rounded-lg hover:border-primary hover:text-primary hover:bg-primary/5 transition-all"
      >
        <Plus size={16} /> Afegir Camp
      </button>
    </div>
  );
}

// =================== FILE: src/components/modules/booking/steps/BookingForm.tsx ===================

'use client';

import { Service, FormField } from '@/types/models';
import { format } from 'date-fns';
import { Loader2, AlertCircle } from 'lucide-react';
import { motion } from 'framer-motion';
import { BookingActionState } from '@/features/booking/actions';

interface Props {
  service: Service;
  date: Date;
  time: string;
  formAction: (payload: FormData) => void;
  isPending: boolean;
  state: BookingActionState;
  onBack: () => void;
}

export function BookingForm({ service, date, time, formAction, isPending, state, onBack }: Props) {
  
  // Helper intern per camps din√†mics (SRP: La l√≤gica de renderitzar inputs √©s aqu√≠)
  const renderDynamicField = (field: FormField) => {
    const commonClasses = "w-full p-3 rounded-lg border border-slate-200 focus:ring-2 focus:ring-primary/20 outline-none transition-all";
    const inputName = `custom_${field.key}`;

    if (field.type === 'textarea') {
        return <textarea name={inputName} required={field.required} placeholder={field.label} className={commonClasses} rows={3} />;
    }
    return <input type={field.type} name={inputName} required={field.required} placeholder={field.label} className={commonClasses} />;
  };

  return (
    <motion.div 
      initial={{ opacity: 0, x: 20 }} 
      animate={{ opacity: 1, x: 0 }} 
      className="max-w-md mx-auto w-full"
    >
      <button onClick={onBack} className="text-sm text-slate-400 hover:text-slate-600 mb-6 flex items-center gap-1">
        ‚Üê Canviar hora
      </button>
      
      <h2 className="text-2xl font-bold text-slate-900 mb-2">Les teves dades</h2>
      <p className="text-slate-500 mb-8">Completa el formulari per confirmar.</p>

      <form action={formAction} className="space-y-4">
        {/* Hidden Inputs (Context) */}
        <input type="hidden" name="serviceId" value={service.id} />
        <input type="hidden" name="date" value={format(date, 'yyyy-MM-dd')} />
        <input type="hidden" name="time" value={time} />

        {/* Standard Fields */}
        <div className="grid grid-cols-2 gap-4">
          <div className="space-y-1">
            <label className="text-xs font-bold text-slate-500 uppercase">Nom</label>
            <input name="name" required placeholder="Joan Vila" className="w-full p-3 rounded-lg border border-slate-200 focus:ring-2 focus:ring-primary/20 outline-none" />
          </div>
          <div className="space-y-1">
            <label className="text-xs font-bold text-slate-500 uppercase">Email</label>
            <input name="email" type="email" required placeholder="joan@exemple.com" className="w-full p-3 rounded-lg border border-slate-200 focus:ring-2 focus:ring-primary/20 outline-none" />
          </div>
        </div>

        {/* Dynamic Fields */}
        {service.form_schema && service.form_schema.length > 0 && (
          <div className="space-y-4 pt-4 border-t border-slate-100 mt-4">
            <p className="text-xs font-bold text-slate-400 uppercase">Informaci√≥ addicional</p>
            {service.form_schema.map((field) => (
              <div key={field.key} className="space-y-1">
                <label className="text-sm font-medium text-slate-700">
                  {field.label} {field.required && <span className="text-red-400">*</span>}
                </label>
                {renderDynamicField(field)}
              </div>
            ))}
          </div>
        )}

        {/* Error Feedback */}
        {state.message && !state.success && (
          <div className="p-3 bg-red-50 text-red-600 text-sm rounded-lg flex items-center gap-2">
            <AlertCircle size={16} /> {state.message}
          </div>
        )}

        <button 
          type="submit" 
          disabled={isPending}
          className="w-full bg-primary text-white font-bold py-4 rounded-xl shadow-lg shadow-primary/20 hover:opacity-90 hover:scale-[1.02] disabled:opacity-50 disabled:scale-100 transition-all mt-6 flex justify-center items-center gap-2"
        >
          {isPending ? <Loader2 className="animate-spin" /> : 'Confirmar Reserva'}
        </button>
      </form>
    </motion.div>
  );
}

// =================== FILE: src/components/modules/booking/steps/DateTimeSelector.tsx ===================

'use client';

import { DayPicker } from 'react-day-picker';
import { ca } from 'date-fns/locale';
import { Loader2, AlertCircle } from 'lucide-react';
import { motion } from 'framer-motion';
import 'react-day-picker/dist/style.css';

interface Props {
  selectedDate: Date | undefined;
  onDateSelect: (date: Date | undefined) => void;
  slots: string[];
  isLoadingSlots: boolean;
  onTimeSelect: (time: string) => void;
  onBack: () => void;
}

export function DateTimeSelector({ selectedDate, onDateSelect, slots, isLoadingSlots, onTimeSelect, onBack }: Props) {
  return (
    <motion.div 
      initial={{ opacity: 0, x: 20 }} 
      animate={{ opacity: 1, x: 0 }} 
      exit={{ opacity: 0, x: -20 }} 
      className="h-full flex flex-col"
    >
      <button onClick={onBack} className="text-sm text-slate-400 hover:text-slate-600 mb-6 flex items-center gap-1 self-start">
        ‚Üê Tornar als serveis
      </button>
      
      <div className="flex flex-col xl:flex-row gap-12">
        {/* CALENDARI */}
        <div>
          <h2 className="text-xl font-bold text-slate-900 mb-6">Tria un dia</h2>
          <DayPicker
            mode="single"
            selected={selectedDate}
            onSelect={onDateSelect}
            locale={ca}
            disabled={{ before: new Date() }}
            modifiersClassNames={{
              selected: 'bg-primary text-white hover:bg-primary hover:text-white rounded-lg'
            }}
            className="p-4 bg-white rounded-2xl border border-slate-100 shadow-sm inline-block"
          />
        </div>

        {/* SLOTS */}
        <div className="flex-1">
          <h2 className="text-xl font-bold text-slate-900 mb-6">Hores lliures</h2>
          {!selectedDate ? (
            <p className="text-slate-400 text-sm">Selecciona un dia del calendari.</p>
          ) : isLoadingSlots ? (
            <div className="flex items-center justify-center h-40">
              <Loader2 className="w-8 h-8 animate-spin text-primary" />
            </div>
          ) : slots.length === 0 ? (
            <p className="text-red-400 text-sm bg-red-50 p-3 rounded-lg flex items-center gap-2">
              <AlertCircle size={16} /> No hi ha hores disponibles.
            </p>
          ) : (
            <div className="grid grid-cols-3 gap-2 max-h-[300px] overflow-y-auto pr-2 custom-scrollbar">
              {slots.map(slot => (
                <button
                  key={slot}
                  onClick={() => onTimeSelect(slot)}
                  className="px-2 py-3 text-sm font-medium rounded-lg border border-slate-200 hover:border-primary hover:text-primary hover:bg-primary/5 transition-all text-center"
                >
                  {slot}
                </button>
              ))}
            </div>
          )}
        </div>
      </div>
    </motion.div>
  );
}

// =================== FILE: src/components/modules/booking/steps/ServiceList.tsx ===================

'use client';

import { Service } from '@/types/models';
import { ChevronRight, Clock } from 'lucide-react';
import { motion } from 'framer-motion';

interface Props {
  services: Service[];
  onSelect: (service: Service) => void;
}

export function ServiceList({ services, onSelect }: Props) {
  return (
    <motion.div 
      initial={{ opacity: 0, x: 20 }} 
      animate={{ opacity: 1, x: 0 }} 
      exit={{ opacity: 0, x: -20 }} 
      className="space-y-6"
    >
      <h2 className="text-2xl font-bold text-slate-900">Quin servei necessites?</h2>
      <div className="grid gap-4">
        {services.map(service => (
          <button
            key={service.id}
            onClick={() => onSelect(service)}
            className="group flex items-center justify-between p-6 rounded-2xl border border-slate-200 hover:border-primary hover:bg-primary/5 transition-all text-left w-full"
          >
            <div>
              <h3 className="font-bold text-lg text-slate-900 group-hover:text-primary transition-colors">
                {service.title}
              </h3>
              <p className="text-sm text-slate-500 flex items-center gap-1">
                 <Clock size={14} /> {service.duration_minutes} min ‚Ä¢ <span className="font-semibold text-slate-700">{service.price} ‚Ç¨</span>
              </p>
            </div>
            <div className="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center group-hover:bg-primary group-hover:text-white transition-colors">
              <ChevronRight className="w-5 h-5" />
            </div>
          </button>
        ))}
      </div>
    </motion.div>
  );
}

// =================== FILE: src/components/modules/booking/steps/__tests__/BookingForm.test.tsx ===================

import { render, screen } from '@testing-library/react';
import { describe, it, expect, vi } from 'vitest';
import { BookingForm } from '../BookingForm';
import { Service } from '@/types/models';

describe('BookingForm Component', () => {
  const mockService: Service = {
    id: 's1',
    title: 'Servei Test',
    organization_id: 'org1',
    price: 10,
    duration_minutes: 30,
    active: true,
    description: '',
    created_at: new Date(),
    // ‚ö°Ô∏è SCHEMA DIN√ÄMIC DE PROVA
    form_schema: [
      { key: 'matricula', label: 'Matr√≠cula Cotxe', type: 'text', required: true }
    ]
  };

  const defaultProps = {
    service: mockService,
    date: new Date(),
    time: '10:00',
    formAction: vi.fn(), // Aix√≤ √©s el que passa el useActionState
    isPending: false,
    state: { success: false },
    onBack: vi.fn(),
  };

  it('hauria de renderitzar camps est√†ndard i din√†mics', () => {
    render(<BookingForm {...defaultProps} />);

    // Camps est√†ndard
    expect(screen.getByPlaceholderText(/Joan Vila/i)).toBeInTheDocument(); // Nom
    expect(screen.getByPlaceholderText(/joan@exemple.com/i)).toBeInTheDocument(); // Email

    // Camp din√†mic (Matr√≠cula)
    expect(screen.getByText('Matr√≠cula Cotxe')).toBeInTheDocument();
    // Validem que l'input t√© el name correcte per al backend
    const dynamicInput = screen.getByPlaceholderText('Matr√≠cula Cotxe');
    expect(dynamicInput).toHaveAttribute('name', 'custom_matricula');
    expect(dynamicInput).toBeRequired();
  });

  it('hauria de mostrar errors si el state en t√©', () => {
    render(<BookingForm {...defaultProps} state={{ success: false, message: 'Error fatal' }} />);
    expect(screen.getByText('Error fatal')).toBeInTheDocument();
  });
});

// =================== FILE: src/components/modules/booking/steps/__tests__/DateTimeSelector.test.tsx ===================

import { render, screen, fireEvent } from '@testing-library/react';
import { describe, it, expect, vi } from 'vitest';
import { DateTimeSelector } from '../DateTimeSelector';

describe('DateTimeSelector Component', () => {
  const defaultProps = {
    selectedDate: undefined,
    onDateSelect: vi.fn(),
    slots: [],
    isLoadingSlots: false,
    onTimeSelect: vi.fn(),
    onBack: vi.fn(),
  };

  it('hauria de mostrar missatge si no hi ha data seleccionada', () => {
    render(<DateTimeSelector {...defaultProps} />);
    expect(screen.getByText(/Selecciona un dia/i)).toBeInTheDocument();
  });

  it('hauria de mostrar loader quan carrega slots', () => {
    render(<DateTimeSelector {...defaultProps} selectedDate={new Date()} isLoadingSlots={true} />);
    // Busquem un element que indiqui c√†rrega (pel text o classe, aqu√≠ assumim que el Loader2 no t√© text accessible per defecte, aix√≠ que busquem el contenidor o text alternatiu si en t√©)
    // Al teu codi no hi ha text "Loading", aix√≠ que comprovarem que NO apareix "No hi ha hores"
    expect(screen.queryByText(/No hi ha hores/i)).not.toBeInTheDocument();
  });

  it('hauria de llistar slots disponibles i permetre selecci√≥', () => {
    const onTimeSelect = vi.fn();
    render(<DateTimeSelector 
      {...defaultProps} 
      selectedDate={new Date()} 
      slots={['10:00', '11:00']} 
      onTimeSelect={onTimeSelect}
    />);

    const slotBtn = screen.getByText('10:00');
    expect(slotBtn).toBeInTheDocument();
    
    fireEvent.click(slotBtn);
    expect(onTimeSelect).toHaveBeenCalledWith('10:00');
  });

  it('hauria de cridar onBack al clicar tornar', () => {
    const onBack = vi.fn();
    render(<DateTimeSelector {...defaultProps} onBack={onBack} />);
    
    fireEvent.click(screen.getByText(/Tornar/i));
    expect(onBack).toHaveBeenCalled();
  });
});

// =================== FILE: src/components/modules/booking/steps/__tests__/ServiceList.test.tsx ===================

import { render, screen, fireEvent } from '@testing-library/react';
import { describe, it, expect, vi } from 'vitest';
import { ServiceList } from '../ServiceList';
import { Service } from '@/types/models';

describe('ServiceList Component', () => {
  const mockServices: Service[] = [
    { 
      id: '1', 
      title: 'Massatge', 
      price: 50, 
      duration_minutes: 60, 
      description: 'Relax',
      active: true,
      organization_id: 'org1',
      form_schema: [],
      created_at: new Date()
    }
  ];

  it('hauria de renderitzar la llista de serveis', () => {
    const onSelect = vi.fn();
    render(<ServiceList services={mockServices} onSelect={onSelect} />);

    expect(screen.getByText('Massatge')).toBeInTheDocument();
    expect(screen.getByText(/50 ‚Ç¨/)).toBeInTheDocument();
  });

  it('hauria de cridar onSelect al fer clic', () => {
    const onSelect = vi.fn();
    render(<ServiceList services={mockServices} onSelect={onSelect} />);

    fireEvent.click(screen.getByText('Massatge'));
    expect(onSelect).toHaveBeenCalledWith(mockServices[0]);
  });
});

// =================== FILE: src/components/modules/booking/__tests__/BookingWidgeet.test.tsx ===================

import { render, screen, fireEvent, waitFor } from '@testing-library/react';
import { describe, it, expect, vi, beforeEach } from 'vitest';
import { BookingWidget } from '../BookingWidget';
import { Service } from '@/types/models';
import * as actions from '@/features/booking/actions';

// Mocks de les accions
vi.mock('@/features/booking/actions', () => ({
  createBookingAction: vi.fn(),
  getAvailableSlotsAction: vi.fn(),
}));

const mockServiceFull: Service = {
  id: 's1',
  title: 'Servei 1',
  organization_id: 'org-mock',
  price: 10,
  duration_minutes: 30,
  active: true,
  description: 'Descripci√≥ test',
  form_schema: [],
  created_at: new Date()
};

// --- MOCKS DE SUBCOMPONENTS ---

vi.mock('../steps/ServiceList', () => ({
  ServiceList: ({ onSelect }: { onSelect: (s: Service) => void }) => (
    <button onClick={() => onSelect(mockServiceFull)}>Select Service</button>
  )
}));

// MOCK ACTUALITZAT: Bot√≥ per triar data
vi.mock('../steps/DateTimeSelector', () => ({
  DateTimeSelector: ({ onTimeSelect, onDateSelect }: { onTimeSelect: (t: string) => void, onDateSelect: (d: Date) => void }) => (
    <div>
      <button onClick={() => onDateSelect(new Date('2023-10-10'))}>Select Date</button>
      <button onClick={() => onTimeSelect('10:00')}>Select Time</button>
    </div>
  )
}));

vi.mock('../steps/BookingForm', () => ({
  BookingForm: () => <div>Formulari Final</div>
}));

describe('BookingWidget Integration', () => {
  const services: Service[] = [mockServiceFull];

  beforeEach(() => {
    vi.clearAllMocks();
  });

  it('hauria de navegar pels passos correctament', async () => {
    // Mock resposta slots
    vi.mocked(actions.getAvailableSlotsAction).mockResolvedValue({ success: true, slots: ['10:00'] });

    render(<BookingWidget services={services} />);

    // PAS 1: Seleccionar Servei
    fireEvent.click(screen.getByText('Select Service'));

    // PAS 2: Estem al DateTimeSelector.
    // Primer hem de seleccionar una data per disparar la c√†rrega de slots
    fireEvent.click(screen.getByText('Select Date'));

    // Ara s√≠, esperem que es cridi l'acci√≥ perqu√® tenim Servei + Data
    await waitFor(() => {
      expect(actions.getAvailableSlotsAction).toHaveBeenCalled();
    });

    // Clicar hora
    fireEvent.click(screen.getByText('Select Time'));

    // PAS 3: Veure formulari
    expect(screen.getByText('Formulari Final')).toBeInTheDocument();
  });
});

// =================== FILE: src/components/modules/dashboard/admin-sidebar.tsx ===================

'use client';

import Link from 'next/link';
import { usePathname } from 'next/navigation';
import { useLocale } from 'next-intl';
import { CONFIG } from '@/config/digitai.config';
import { signOutAction } from '@/features/auth/actions';
import { ThemeToggle } from '@/components/ui/theme-toggle'; // üëà
import { LanguageSwitcher } from '@/components/ui/lang-switcher'; // üëà
import { 
  LayoutDashboard, Package, ShoppingBag, 
  LogOut, Store, List, 
  Globe, FileText, User as UserIcon
} from 'lucide-react';

export function AdminSidebar({ user }: { user: { email: string, full_name?: string | null } }) {
  const pathname = usePathname();
  const locale = useLocale();
  const { modules } = CONFIG;

  const navItems = [
    { label: 'Resum', href: '/dashboard', icon: LayoutDashboard, show: true },
    { label: 'Comandes', href: '/orders', icon: ShoppingBag, show: modules.ecommerce },
    { label: 'Productes', href: '/products', icon: Store, show: modules.ecommerce },
    { label: 'Serveis', href: '/services', icon: List, show: modules.booking },
    { label: 'Blog', href: '/blog-manager', icon: FileText, show: modules.blog },
    { label: 'Inventari', href: '/inventory', icon: Package, show: modules.inventory },
  ];

  return (
    // CANVI: bg-slate-900 -> bg-card (m√©s sem√†ntic per suportar temes)
    <aside className="hidden md:flex w-64 h-full bg-card text-card-foreground flex-col border-r border-border">
      
      {/* HEADER */}
      <div className="h-16 flex items-center px-6 border-b border-border">
        <span className="font-bold text-xl tracking-tight text-primary">{CONFIG.identity.name}</span>
        <span className="ml-2 text-[10px] uppercase tracking-wider bg-primary/10 text-primary px-2 py-0.5 rounded font-bold border border-primary/20">Admin</span>
      </div>

      {/* NAV */}
      <nav className="flex-1 p-4 space-y-1 overflow-y-auto">
        {navItems.filter(i => i.show).map((item) => {
          const href = `/${locale}${item.href}`;
          const isActive = pathname.startsWith(href);
          return (
            <Link 
                key={item.href} 
                href={href} 
                className={`flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium transition-colors ${
                    isActive 
                    ? "bg-primary text-primary-foreground shadow-md shadow-primary/20" 
                    : "text-muted-foreground hover:bg-secondary/50 hover:text-foreground"
                }`}
            >
              <item.icon className="w-5 h-5" />
              {item.label}
            </Link>
          );
        })}
      </nav>

      {/* FOOTER ACTIONS */}
      <div className="p-4 border-t border-border bg-muted/30 space-y-4">
        
        {/* Selectors a la part inferior */}
        <div className="flex justify-between items-center px-1">
            <LanguageSwitcher />
            <ThemeToggle />
        </div>

        <Link href={`/${locale}`} className="flex items-center gap-3 px-3 py-2 rounded-lg text-sm font-medium text-muted-foreground hover:text-primary hover:bg-secondary/20 transition-colors">
            <Globe className="w-5 h-5" /> Veure Web P√∫blica
        </Link>
        
        <div className="h-px bg-border w-full" />
        
        <div className="flex items-center gap-3">
            <div className="w-9 h-9 rounded-full bg-primary/20 flex items-center justify-center text-primary border border-primary/20">
                <UserIcon className="w-4 h-4" />
            </div>
            <div className="overflow-hidden flex-1">
                <p className="text-sm font-bold truncate">{user.full_name}</p>
                <p className="text-[10px] text-muted-foreground">Administrador</p>
            </div>
            <form action={signOutAction}>
                <button type="submit" className="p-2 text-muted-foreground hover:text-red-500 transition-colors" title="Tancar Sessi√≥">
                    <LogOut className="w-5 h-5" />
                </button>
            </form>
        </div>
      </div>
    </aside>
  );
}

// =================== FILE: src/components/modules/dashboard/user-sidebar.tsx ===================

'use client';

import Link from 'next/link';
import { usePathname } from 'next/navigation';
import { useLocale } from 'next-intl';
import { CONFIG } from '@/config/digitai.config';
import { signOutAction } from '@/features/auth/actions';
import { ThemeToggle } from '@/components/ui/theme-toggle'; // üëà
import { LanguageSwitcher } from '@/components/ui/lang-switcher'; // üëà
import { User, Calendar, LogOut, ShoppingBag, Store } from 'lucide-react';

export function UserSidebar({ user }: { user: { email: string, full_name?: string | null } }) {
  const pathname = usePathname();
  const locale = useLocale();
  const { modules } = CONFIG;

  const navItems = [
    { label: 'El meu Compte', href: '/my-account', icon: User, show: true },
    { label: 'Les meves Cites', href: '/my-booking-history', icon: Calendar, show: modules.booking },
    { label: 'Tornar a la Botiga', href: '/shop', icon: ShoppingBag, show: modules.ecommerce },
  ];

  return (
    <aside className="hidden md:flex w-64 h-full bg-card text-card-foreground flex-col border-r border-border">
      <div className="h-16 flex items-center px-6 border-b border-border">
        <span className="font-bold text-xl text-primary">{CONFIG.identity.name}</span>
      </div>

      <nav className="flex-1 p-4 space-y-1">
        {navItems.filter(i => i.show).map((item) => {
          const href = `/${locale}${item.href}`;
          const isActive = pathname.startsWith(href);
          return (
            <Link 
                key={item.href} 
                href={href} 
                className={`flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium transition-colors ${
                    isActive 
                    ? "bg-secondary text-secondary-foreground font-bold" 
                    : "text-muted-foreground hover:bg-muted"
                }`}
            >
              <item.icon className="w-5 h-5" />
              {item.label}
            </Link>
          );
        })}
      </nav>

      <div className="p-4 border-t border-border bg-muted/30 space-y-4">
        {/* INTEGRACI√ì TOGGLES */}
        <div className="flex justify-between items-center px-1">
            <LanguageSwitcher />
            <ThemeToggle />
        </div>

        <div className="h-px bg-border w-full" />

        <div className="flex items-center gap-3">
            <div className="w-9 h-9 rounded-full bg-primary/10 flex items-center justify-center text-primary"><User className="w-4 h-4" /></div>
            <div className="overflow-hidden flex-1"><p className="text-sm font-bold truncate">{user.full_name || 'Client'}</p></div>
            <form action={signOutAction}><button type="submit" className="p-2 text-muted-foreground hover:text-red-500"><LogOut className="w-5 h-5" /></button></form>
        </div>
      </div>
    </aside>
  );
}

// =================== FILE: src/components/modules/ecommerce/cart-drawer.tsx ===================

'use client';

import { useCartStore } from '@/lib/store/cart-store';
import { AnimatePresence, motion } from 'framer-motion';
import { X, Trash2, Minus, Plus, CreditCard, ShoppingBag } from 'lucide-react';
import { checkoutAction } from '@/features/ecommerce/actions';
import { useState } from 'react';
import { useRouter } from 'next/navigation';
import Image from 'next/image';
import { toast } from 'sonner';

export function CartDrawer() {
    // üî¥ ERROR: 'total' no existeix.
    // ‚úÖ CORRECCI√ì: Canviem 'total' per 'totalPrice' (i li diem 'total' localment si vols)
    const {
        items,
        isOpen,
        toggleCart,
        removeItem,
        updateQuantity,
        totalPrice: total, // üëà ALIES CLAU
        clearCart
    } = useCartStore();
    const [isCheckingOut, setIsCheckingOut] = useState(false);
    const router = useRouter();

    const handleCheckout = async () => {
        setIsCheckingOut(true);

        const orderData = {
            customer_email: "client@exemple.com", // TODO: Connectar amb Auth o Input
            customer_details: {},
            items: items,
            payment_method: 'stripe' as const
        };

        const res = await checkoutAction(orderData);
        setIsCheckingOut(false);

        if (res.success && res.redirectUrl) {
            clearCart();
            toggleCart();
            router.push(res.redirectUrl);
        } else {
            toast.error("Error: " + res.error);
        }
    };

    return (
        <AnimatePresence>
            {isOpen && (
                <>
                    {/* Backdrop */}
                    <motion.div
                        initial={{ opacity: 0 }}
                        animate={{ opacity: 1 }}
                        exit={{ opacity: 0 }}
                        onClick={toggleCart}
                        className="fixed inset-0 bg-black/40 backdrop-blur-sm z-50"
                    />

                    {/* Drawer */}
                    <motion.div
                        initial={{ x: "100%" }}
                        animate={{ x: 0 }}
                        exit={{ x: "100%" }}
                        transition={{ type: "spring", stiffness: 300, damping: 30 }}
                        className="fixed top-0 right-0 h-full w-full max-w-md bg-background shadow-2xl z-50 flex flex-col border-l border-border"
                    >
                        {/* Header */}
                        <div className="p-6 border-b border-border flex justify-between items-center bg-card">
                            <h2 className="text-xl font-bold flex items-center gap-2">
                                <ShoppingBag className="w-5 h-5" /> La teva cistella ({items.length})
                            </h2>
                            <button onClick={toggleCart} className="p-2 hover:bg-secondary rounded-full transition-colors">
                                <X size={20} />
                            </button>
                        </div>

                        {/* Items List */}
                        <div className="flex-1 overflow-y-auto p-6 space-y-6">
                            {items.length === 0 ? (
                                <div className="h-full flex flex-col items-center justify-center text-muted-foreground space-y-4">
                                    <ShoppingBag size={48} className="opacity-20" />
                                    <p>El carret est√† buit üò¢</p>
                                    <button onClick={toggleCart} className="text-primary font-bold hover:underline">
                                        Continuar comprant
                                    </button>
                                </div>
                            ) : (
                                items.map(item => (
                                    <div key={item.id} className="flex gap-4 group">
                                        {/* Imatge corregida üëá */}
                                        <div className="relative w-20 h-20 bg-secondary/20 rounded-xl overflow-hidden shrink-0 border border-border">
                                            {item.image ? (
                                                <Image
                                                    src={item.image}
                                                    alt={item.name}
                                                    fill
                                                    className="object-cover"
                                                    sizes="80px"
                                                />
                                            ) : (
                                                <div className="w-full h-full flex items-center justify-center bg-secondary/10">
                                                    <ShoppingBag size={20} className="opacity-20" />
                                                </div>
                                            )}
                                        </div>

                                        <div className="flex-1 flex flex-col justify-between py-1">
                                            <div>
                                                <div className="flex justify-between items-start">
                                                    <h4 className="font-bold text-sm line-clamp-1 pr-2">{item.name}</h4>
                                                    <button onClick={() => removeItem(item.id)} className="text-muted-foreground hover:text-red-500 transition-colors" aria-label="Eliminar producte">
                                                        <Trash2 size={16} />
                                                    </button>
                                                </div>
                                                <p className="text-primary font-bold text-sm mt-1">{item.price.toFixed(2)} ‚Ç¨</p>
                                            </div>

                                            {/* Contro de quantitat */}
                                            <div className="flex items-center gap-3 mt-2">
                                                <div className="flex items-center border border-input rounded-lg bg-background">
                                                    <button
                                                        onClick={() => updateQuantity(item.id, Math.max(1, item.quantity - 1))}
                                                        className="p-1.5 hover:bg-secondary/50 rounded-l-lg transition-colors"
                                                    >
                                                        <Minus size={12} />
                                                    </button>

                                                    <span className="w-8 text-center text-sm font-medium">{item.quantity}</span>

                                                    <button
                                                        onClick={() => updateQuantity(item.id, item.quantity + 1)}
                                                        disabled={item.quantity >= item.stock}
                                                        className="p-1.5 hover:bg-secondary/50 rounded-r-lg disabled:opacity-30 disabled:hover:bg-transparent transition-colors"
                                                    >
                                                        <Plus size={12} />
                                                    </button>
                                                </div>

                                                {item.quantity >= item.stock && (
                                                    <span className="text-[10px] text-orange-500 font-medium bg-orange-50 px-2 py-0.5 rounded-full">
                                                        Max stock
                                                    </span>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                ))
                            )}
                        </div>

                        {/* Footer / Checkout */}
                        {items.length > 0 && (
                            <div className="p-6 border-t border-border bg-muted/20">
                                <div className="flex justify-between items-center mb-6">
                                    <span className="text-muted-foreground">Subtotal</span>
                                    <span className="font-extrabold text-2xl">{total().toFixed(2)} ‚Ç¨</span>
                                </div>

                                <button
                                    onClick={handleCheckout}
                                    disabled={isCheckingOut}
                                    className="w-full bg-primary text-primary-foreground py-4 rounded-xl font-bold shadow-lg shadow-primary/20 hover:opacity-90 active:scale-[0.98] transition-all flex justify-center items-center gap-2 disabled:opacity-70 disabled:cursor-not-allowed"
                                >
                                    {isCheckingOut ? (
                                        <>Processant...</>
                                    ) : (
                                        <>
                                            <CreditCard size={20} /> Tramitar Comanda
                                        </>
                                    )}
                                </button>
                                <p className="text-xs text-center text-muted-foreground mt-4">
                                    Pagament segur via Stripe. Enviament i taxes calculats al seg√ºent pas.
                                </p>
                            </div>
                        )}
                    </motion.div>
                </>
            )}
        </AnimatePresence>
    );
}

// =================== FILE: src/components/modules/ecommerce/product-actions.tsx ===================

'use client';

import { Product } from '@/types/models';
import { useCartStore } from '@/lib/store/cart-store';
import { ShoppingCart, Check, PackageX } from 'lucide-react';
import { useState } from 'react';
import { motion } from 'framer-motion';
import { toast } from 'sonner';

export function ProductActions({ product }: { product: Product }) {
  const addItem = useCartStore(state => state.addItem);
  const [added, setAdded] = useState(false);

  const handleAdd = () => {
    addItem(product);
    setAdded(true);
    toast.success(`${product.name} afegit al carret`);
    
    // Reset del bot√≥ despr√©s de 2 segons
    setTimeout(() => setAdded(false), 2000);
  };

  if (product.stock <= 0) {
      return (
          <button disabled className="w-full py-4 bg-muted text-muted-foreground rounded-xl font-bold cursor-not-allowed flex items-center justify-center gap-2">
            <PackageX size={20} />
            Esgotat
          </button>
      );
  }

  return (
    <motion.button 
        whileTap={{ scale: 0.95 }}
        onClick={handleAdd}
        className={`w-full py-4 rounded-xl font-bold text-lg flex items-center justify-center gap-3 transition-all duration-300 shadow-lg ${
            added 
                ? "bg-green-500 text-white shadow-green-500/20" 
                : "bg-primary text-primary-foreground hover:bg-primary/90 hover:shadow-primary/20"
        }`}
    >
        {added ? (
            <motion.div initial={{ scale: 0 }} animate={{ scale: 1 }} className="flex items-center gap-2">
                <Check size={20} /> Afegit
            </motion.div>
        ) : (
            <div className="flex items-center gap-2">
                <ShoppingCart size={20} /> Afegir al Carret
            </div>
        )}
    </motion.button>
  );
}

// =================== FILE: src/components/modules/ecommerce/product-card.tsx ===================

'use client';

import Image from 'next/image';
import Link from 'next/link';
import { ShoppingCart, Eye, PackageX, Sparkles } from 'lucide-react';
import { Product } from '@/types/models';
import { useCartStore } from '@/lib/store/cart-store';
import { toast } from 'sonner';
import { motion } from 'framer-motion';

interface ProductCardProps {
    product: Product;
    index?: number;
}

export function ProductCard({ product, index = 0 }: ProductCardProps) {
    const addItem = useCartStore((state) => state.addItem);

    const handleAddToCart = (e: React.MouseEvent) => {
        e.preventDefault();
        e.stopPropagation();
        addItem(product);
        toast.success("Afegit al carret!");
    };

    const isOutOfStock = product.stock <= 0;

    // üñºÔ∏è L√íGICA D'IMATGES M√ÄGIQUES
    // Si no tenim imatge, n'agafem una d'Unsplash basada en el nom del producte o un ID aleatori
    const fallbackImage = `https://images.unsplash.com/photo-1523275335684-37898b6baf30?q=80&w=1000&auto=format&fit=crop`;
    
    // Utilitzem la imatge del producte o el fallback
    const displayImage = product.images?.[0] || fallbackImage;

    return (
        <motion.div
            initial={{ opacity: 0, y: 20 }}
            whileInView={{ opacity: 1, y: 0 }}
            viewport={{ once: true, margin: "-50px" }}
            transition={{ delay: index * 0.1, duration: 0.5 }}
            className="group relative flex flex-col h-full bg-card border border-border/40 rounded-[1.5rem] overflow-hidden hover:shadow-2xl hover:shadow-black/5 dark:hover:shadow-black/20 transition-all duration-300"
        >
            {/* 1. ZONA D'IMATGE (Redu√Øda a 4:3 per no ser tan alta) */}
            <div className="relative aspect-[4/3] overflow-hidden bg-secondary/10">
                <Image
                    src={displayImage}
                    alt={product.name}
                    fill
                    className={`object-cover transition-transform duration-700 ease-out group-hover:scale-105 ${isOutOfStock ? 'opacity-60 grayscale' : ''}`}
                />

                {/* Badges Flotants */}
                <div className="absolute top-3 left-3 flex gap-2">
                    {isOutOfStock ? (
                        <span className="bg-black/70 backdrop-blur text-white text-[10px] font-bold px-2 py-1 rounded-full uppercase tracking-wider">
                            Esgotat
                        </span>
                    ) : (
                        product.stock < 5 && (
                            <span className="bg-amber-500/90 backdrop-blur text-white text-[10px] font-bold px-2 py-1 rounded-full uppercase tracking-wider animate-pulse">
                                √öltimes Uts.
                            </span>
                        )
                    )}
                    {/* Badge "Nou" decoratiu si no t√© imatge real */}
                    {!product.images?.[0] && !isOutOfStock && (
                        <span className="bg-primary/90 backdrop-blur text-primary-foreground text-[10px] font-bold px-2 py-1 rounded-full uppercase tracking-wider flex items-center gap-1">
                            <Sparkles size={10} /> Demo
                        </span>
                    )}
                </div>

                {/* OVERLAY D'ACCIONS (Glassmorphism) */}
                {!isOutOfStock && (
                    <div className="absolute inset-0 bg-black/10 opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex items-center justify-center gap-3 backdrop-blur-[2px]">
                        <Link href={`/shop/${product.slug}`}>
                            <motion.button 
                                whileHover={{ scale: 1.1 }}
                                whileTap={{ scale: 0.9 }}
                                className="w-12 h-12 rounded-full bg-white text-black shadow-xl flex items-center justify-center hover:bg-primary hover:text-white transition-colors"
                            >
                                <Eye size={20} />
                            </motion.button>
                        </Link>
                        <motion.button 
                            onClick={handleAddToCart}
                            whileHover={{ scale: 1.1 }}
                            whileTap={{ scale: 0.9 }}
                            className="w-12 h-12 rounded-full bg-white text-black shadow-xl flex items-center justify-center hover:bg-primary hover:text-white transition-colors"
                        >
                            <ShoppingCart size={20} />
                        </motion.button>
                    </div>
                )}
            </div>

            {/* 2. CONTINGUT (Compacte i Net) */}
            <div className="p-5 flex flex-col grow">
                {/* Categoria petita */}
                <div className="text-[10px] font-bold text-muted-foreground uppercase tracking-wider mb-1">
                    Col¬∑lecci√≥ {new Date().getFullYear()}
                </div>

                <Link href={`/shop/${product.slug}`} className="group-hover:text-primary transition-colors block mb-2">
                    <h3 className="font-bold text-lg text-card-foreground leading-snug line-clamp-1">
                        {product.name}
                    </h3>
                </Link>
                
                {/* Descripci√≥ curta */}
                <p className="text-sm text-muted-foreground line-clamp-2 mb-4 leading-relaxed">
                    {product.description || "Un producte exclusiu dissenyat per oferir la millor qualitat i experi√®ncia."}
                </p>

                {/* Footer del producte */}
                <div className="mt-auto pt-4 border-t border-border/30 flex items-center justify-between">
                    <span className="text-xl font-bold text-foreground">
                        {product.price.toFixed(2)}‚Ç¨
                    </span>
                    
                    {/* Bot√≥ "Afegir" nom√©s visible en m√≤bil (en desktop √©s l'overlay) */}
                    <button 
                        onClick={handleAddToCart}
                        disabled={isOutOfStock}
                        className="md:hidden text-sm font-bold text-primary"
                    >
                        {isOutOfStock ? "Esgotat" : "Afegir +"}
                    </button>
                </div>
            </div>
        </motion.div>
    );
}

// =================== FILE: src/components/modules/ecommerce/product-gallery.tsx ===================

'use client';

import { useState } from 'react';
import Image from 'next/image';
import { cn } from '@/lib/utils';
import { motion, AnimatePresence } from 'framer-motion';

interface ProductGalleryProps {
  images: string[];
  title: string;
}

export function ProductGallery({ images, title }: ProductGalleryProps) {
  const [selectedImage, setSelectedImage] = useState(0);
  const hasImages = images && images.length > 0;

  return (
    <div className="space-y-4">
      {/* Imatge Principal */}
      <div className="relative aspect-square bg-card rounded-4xl overflow-hidden border border-border/50 shadow-sm">
        <AnimatePresence mode="wait">
            {hasImages ? (
            <motion.div
                key={selectedImage}
                initial={{ opacity: 0 }}
                animate={{ opacity: 1 }}
                exit={{ opacity: 0 }}
                transition={{ duration: 0.3 }}
                className="relative w-full h-full"
            >
                <Image
                    src={images[selectedImage]}
                    alt={`${title} - Vista ${selectedImage + 1}`}
                    fill
                    className="object-cover"
                    priority
                />
            </motion.div>
            ) : (
            <div className="w-full h-full flex items-center justify-center text-muted-foreground bg-muted">
                <span>Sense imatge</span>
            </div>
            )}
        </AnimatePresence>
      </div>

      {/* Miniatures */}
      {hasImages && images.length > 1 && (
        <div className="flex gap-3 overflow-x-auto pb-2 scrollbar-hide">
          {images.map((img, idx) => (
            <button
              key={idx}
              onClick={() => setSelectedImage(idx)}
              className={cn(
                "relative w-20 h-20 rounded-xl overflow-hidden border-2 shrink-0 transition-all duration-300",
                selectedImage === idx 
                  ? "border-primary ring-2 ring-primary/20 scale-105" 
                  : "border-transparent opacity-70 hover:opacity-100"
              )}
            >
              <Image 
                src={img} 
                alt={`Miniatura ${idx}`} 
                fill 
                className="object-cover" 
              />
            </button>
          ))}
        </div>
      )}
    </div>
  );
}

// =================== FILE: src/components/modules/ecommerce/product-grid.tsx ===================

'use client';

import { Product } from '@/types/models';
import { ProductCard } from './product-card';

interface ProductGridProps {
  products: Product[];
}

export function ProductGrid({ products }: ProductGridProps) {
  if (!products.length) return null;

  return (
    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 md:gap-8">
      {products.map((product, index) => (
        <ProductCard key={product.id} product={product} index={index} />
      ))}
    </div>
  );
}

// =================== FILE: src/components/modules/ecommerce/__tests__/CardDrawer.test.tsx ===================

import { render, screen, fireEvent, waitFor } from '@testing-library/react';
import { describe, it, expect, vi, beforeEach, Mock } from 'vitest';
import { CartDrawer } from '../cart-drawer'; 
import * as actions from '@/features/ecommerce/actions';
import { useCartStore } from '@/lib/store/cart-store';
import { CartItem } from '@/types/models';
import React from 'react'; // üëà Necessari per als tipus del Mock

// ----------------------------------------------------------------------
// üõ†Ô∏è MOCKS LOCALS
// ----------------------------------------------------------------------

// 1. Mock de Next/Navigation
const mockPush = vi.fn();
vi.mock('next/navigation', () => ({
  useRouter: () => ({ push: mockPush }),
}));

// 2. Mock de Next/Image (CR√çTIC: Arreglat tipatge 'any')
vi.mock('next/image', () => ({
  __esModule: true,
  // üëá FIX: Usem el tipus natiu de props d'una etiqueta <img>
  default: (props: React.ComponentProps<'img'>) => {
    // eslint-disable-next-line @next/next/no-img-element
    return <img {...props} alt={props.alt || ''} />;
  },
}));

// 3. Mock del Server Action
const mockCheckoutAction = vi.spyOn(actions, 'checkoutAction');

// 4. Mock del Store (Zustand)
vi.mock('@/lib/store/cart-store');

// ----------------------------------------------------------------------
// üìù DEFINICIONS I DADES
// ----------------------------------------------------------------------

interface CartStoreState {
  isOpen: boolean;
  items: CartItem[];
  totalPrice: () => number;
  toggleCart: () => void;
  removeItem: (id: string) => void;
  updateQuantity: (id: string, qty: number) => void;
  clearCart: () => void;
}

const baseMockItem: CartItem = {
  id: '1',
  organization_id: 'org-test-123',
  name: 'Producte Test',
  slug: 'producte-test',

  price: 50,
  quantity: 1,
  stock: 10,

  image: 'https://example.com/img.jpg', // URL absoluta per evitar errors
  
};

// ----------------------------------------------------------------------
// üß™ TESTS
// ----------------------------------------------------------------------

describe('CartDrawer Component', () => {
  
  const setupStore = (overrides: Partial<CartStoreState> = {}) => {
    const defaultState: CartStoreState = {
      isOpen: true,
      items: [],
      totalPrice: () => 0,
      toggleCart: vi.fn(),
      removeItem: vi.fn(),
      updateQuantity: vi.fn(),
      clearCart: vi.fn(),
      ...overrides
    };
    (useCartStore as unknown as Mock).mockReturnValue(defaultState);
  };

  beforeEach(() => {
    vi.clearAllMocks();
  });

  it('hauria de cridar a removeItem al clicar la paperera', () => {
    const mockRemove = vi.fn();
    const mockItem: CartItem = { ...baseMockItem, id: 'prod-1' };
    
    setupStore({
      items: [mockItem],
      removeItem: mockRemove,
      totalPrice: () => 50
    });

    render(<CartDrawer />);
    
    // Busquem el bot√≥ per l'aria-label
    const deleteBtn = screen.getByRole('button', { name: /Eliminar producte/i });
    fireEvent.click(deleteBtn);

    expect(mockRemove).toHaveBeenCalledWith('prod-1');
  });

  it('hauria de gestionar el Checkout amb √®xit', async () => {
    const mockClear = vi.fn();
    const mockToggle = vi.fn();
    const mockItem: CartItem = { ...baseMockItem };

    setupStore({
      items: [mockItem],
      clearCart: mockClear,
      toggleCart: mockToggle,
      totalPrice: () => 50
    });

    mockCheckoutAction.mockResolvedValue({ 
        success: true, 
        redirectUrl: 'http://stripe.com/pay' 
    });

    render(<CartDrawer />);

    const checkoutBtn = screen.getByRole('button', { name: /Tramitar/i });
    fireEvent.click(checkoutBtn);

    expect(screen.getByText(/Processant/i)).toBeInTheDocument();

    await waitFor(() => {
        expect(mockCheckoutAction).toHaveBeenCalled();
    });

    expect(mockClear).toHaveBeenCalled();
    expect(mockPush).toHaveBeenCalledWith('http://stripe.com/pay');
  });
});

// =================== FILE: src/components/modules/landing/service-card.tsx ===================

'use client';

import { useState } from 'react';
import { ServiceDTO } from '@/types/models'; // Nota: Si uses ServiceDTO, importa aquest
import { motion } from 'framer-motion';
import { Clock, Sparkles, ArrowRight, ChevronDown, Check } from 'lucide-react';
import Link from 'next/link';
import { cn } from '@/lib/utils';

interface ServiceCardProps {
  service: ServiceDTO;
  index: number;
}

export function ServiceCard({ service, index }: ServiceCardProps) {
  const [isOpen, setIsOpen] = useState(false);

  // Formategem preu
  const priceString = (service.price ?? 0).toString();
  const [priceMain, priceDecimals] = priceString.split('.');

  // Toggle per m√≤bil
  const toggleOpen = () => setIsOpen(!isOpen);

  return (
    <motion.div
        initial={{ opacity: 0, y: 20 }}
        whileInView={{ opacity: 1, y: 0 }}
        viewport={{ once: true }}
        transition={{ delay: index * 0.1 }}
        className="h-full"
    >
        <div 
            onClick={toggleOpen} 
            className={cn(
                "group relative bg-card/40 backdrop-blur-xl border border-white/10 dark:border-white/5 overflow-hidden transition-all duration-300",
                "rounded-2xl cursor-pointer md:cursor-default", 
                isOpen ? "bg-card/60 shadow-lg border-primary/20" : "hover:bg-card/50",
                "md:h-full md:flex md:flex-col md:p-6 md:hover:border-primary/20 md:hover:shadow-xl md:hover:shadow-primary/5 md:bg-card/40"
            )}
        >
            {/* Header */}
            <div className="p-5 md:p-0 flex items-center justify-between gap-4 relative z-10">
                <div className="flex items-center gap-4">
                    <div className={cn(
                        "w-10 h-10 rounded-xl flex items-center justify-center transition-colors duration-300",
                        "bg-primary/10 text-primary shadow-inner shadow-primary/10",
                        "md:group-hover:bg-primary md:group-hover:text-primary-foreground"
                    )}>
                        <Sparkles className="w-5 h-5" />
                    </div>

                    <div className="flex flex-col">
                        <h3 className="font-bold text-lg md:text-xl text-foreground leading-tight group-hover:text-primary transition-colors">
                            {service.title}
                        </h3>
                        {/* Teaser M√≤bil */}
                        <div className={cn("md:hidden text-xs font-medium text-muted-foreground flex items-center gap-2", isOpen && "opacity-0")}>
                           <span>{service.duration_minutes} min</span> ‚Ä¢ <span className="text-foreground font-bold">{service.price}‚Ç¨</span>
                        </div>
                    </div>
                </div>

                <ChevronDown className={cn(
                    "w-5 h-5 text-muted-foreground transition-transform duration-300 md:hidden",
                    isOpen && "rotate-180 text-primary"
                )} />
            </div>

            {/* Contingut */}
            <div className={cn(
                "md:block md:mt-4 md:flex-1", 
                isOpen ? "block" : "hidden"
            )}>
                <div className="h-px w-full bg-border/50 md:hidden mb-4" />

                <div className="px-5 pb-5 md:p-0 flex flex-col h-full">
                    <p className="text-sm text-muted-foreground leading-relaxed line-clamp-3 mb-4 md:mb-6">
                        {service.description || "Servei professional optimitzat per a resultats r√†pids."}
                    </p>

                    <div className="flex items-center gap-3 mb-6 text-xs text-muted-foreground/80 md:mb-auto">
                         <div className="flex items-center gap-1 bg-secondary/30 px-2 py-1 rounded-md">
                            <Clock size={12} /> {service.duration_minutes} min
                         </div>
                         <div className="flex items-center gap-1 px-2 py-1">
                            <Check size={12} className="text-green-500" /> Disponibilitat immediata
                         </div>
                    </div>

                    <div className="flex items-center justify-between gap-4 mt-auto pt-4 md:pt-0 md:border-t-0 border-t border-border/30">
                        <div className="flex flex-col">
                            <span className="text-[10px] uppercase font-bold text-muted-foreground tracking-wider">Preu</span>
                            <div className="flex items-baseline leading-none">
                                <span className="text-2xl font-black text-foreground">{priceMain}</span>
                                {priceDecimals && <span className="text-sm font-bold text-muted-foreground">.{priceDecimals}</span>}
                                <span className="text-sm font-bold text-primary ml-0.5">‚Ç¨</span>
                            </div>
                        </div>

                        <Link href={`/book?serviceId=${service.id}`} className="md:w-auto">
                            <button className="group/btn relative overflow-hidden rounded-lg bg-foreground text-background px-5 py-2.5 font-bold text-sm shadow-lg hover:shadow-primary/20 transition-all active:scale-95">
                                <span className="relative z-10 flex items-center gap-2 group-hover/btn:text-primary-foreground transition-colors">
                                    Reservar <ArrowRight size={14} className="group-hover/btn:translate-x-1 transition-transform" />
                                </span>
                                <div className="absolute inset-0 bg-primary translate-y-full group-hover/btn:translate-y-0 transition-transform duration-300" />
                            </button>
                        </Link>
                    </div>
                </div>
            </div>
            
            <div className="hidden md:block absolute -inset-px bg-linear-to-b from-primary/30 to-transparent opacity-0 group-hover:opacity-100 blur-lg transition-opacity duration-500 -z-10 rounded-2xl" />
        </div>
    </motion.div>
  );
}

// =================== FILE: src/components/modules/marketing/about-section.tsx ===================

'use client';

import Image from "next/image";
import { CheckCircle2, TrendingUp } from "lucide-react"; 
import { motion, Variants } from "framer-motion";
import { AboutContent } from '@/types/models'; // ‚úÖ Importem el tipus global

export function AboutSection({ data }: { data: AboutContent }) {
  
  // --- 1. CONFIGURACI√ì DE FALLBACKS INTEL¬∑LIGENTS ---
  // Prioritzem el que envia la IA. Si falta alguna cosa, posem un text gen√®ric bonic.
  
  const badge = data?.badge || "Sobre Nosaltres";
  const title = data?.title || "La nostra ess√®ncia";
  // Si la IA falla, posem un text placeholder
  const description = data?.description || "Som una empresa compromesa amb l'excel¬∑l√®ncia i la innovaci√≥, oferint solucions que transformen negocis.";
  
  // Imatge: Si la IA no en dona, posem una d'Unsplash d'oficina moderna
  const image = data?.imageUrl || "https://images.unsplash.com/photo-1497366216548-37526070297c?q=80&w=2301&auto=format&fit=crop";
  
  // Features: Com que la IA (per ara) no genera llista de punts, posem aquests gen√®rics que queden b√© a tot arreu
  const features = data?.features?.length ? data.features : [
    "Qualitat garantida en cada projecte",
    "Equip professional i dedicat",
    "Solucions adaptades a les teves necessitats"
  ];

  // Stats: Aquests venen DIRECTES de la IA ("10 Anys", etc.)
  const stats = data?.stats?.length ? data.stats : [
    { label: "Anys d'experi√®ncia", value: "+5" }, 
    { label: "Clients Satisfets", value: "100%" }, 
    { label: "Comprom√≠s", value: "Total" }
  ];

  // Targeta Flotant: Decoraci√≥ visual
  const cardData = data?.card || { title: "Creixement", subtitle: "Resultats constants" };

  // --- 2. ANIMACIONS (Variants) ---
  const fadeInUp: Variants = {
    hidden: { opacity: 0, y: 30 },
    visible: { opacity: 1, y: 0, transition: { duration: 0.6, ease: "easeOut" } }
  };

  const staggerContainer: Variants = {
    hidden: {},
    visible: { transition: { staggerChildren: 0.15 } }
  };

  const progressBar: Variants = {
    hidden: { width: 0 },
    visible: { width: "85%", transition: { delay: 0.8, duration: 1, ease: "easeOut" } }
  };

  return (
    <section id="about" className="relative py-24 bg-background overflow-hidden">
      
      {/* DECORACI√ì DE FONS */}
      <div className="absolute top-0 right-0 w-full h-full overflow-hidden -z-10 pointer-events-none">
          <div className="absolute top-[20%] right-[-5%] w-[30%] h-[30%] bg-primary/5 rounded-full blur-3xl" />
          <div className="absolute bottom-[10%] left-[-10%] w-[20%] h-[20%] bg-blue-500/5 rounded-full blur-3xl" />
      </div>

      <div className="container px-4 md:px-6 mx-auto">
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-16 lg:gap-24 items-center">
          
          {/* COLUMNA DE TEXT */}
          <motion.div 
            initial="hidden" whileInView="visible" viewport={{ once: true, margin: "-100px" }}
            variants={staggerContainer}
            className="flex flex-col gap-8 order-2 lg:order-1"
          >
            {/* Badge */}
            <motion.div variants={fadeInUp}>
                <span className="inline-flex items-center px-4 py-1.5 rounded-full text-xs font-bold tracking-widest text-primary uppercase bg-primary/10 border border-primary/20">
                  {badge}
                </span>
            </motion.div>
            
            {/* T√≠tol IA */}
            <motion.h2 variants={fadeInUp} className="text-4xl md:text-5xl font-black tracking-tight text-foreground leading-[1.1]">
              {title}
            </motion.h2>
            
            {/* Descripci√≥ IA */}
            <motion.p variants={fadeInUp} className="text-lg text-muted-foreground leading-relaxed">
              {description}
            </motion.p>

            {/* Features (Llista amb checks) */}
            <motion.div variants={fadeInUp} className="flex flex-col gap-4">
              {features.map((item, index) => (
                <div key={index} className="flex items-start gap-4 group">
                  <div className="mt-1 p-1 bg-primary/10 rounded-full group-hover:bg-primary/20 transition-colors">
                    <CheckCircle2 className="w-5 h-5 text-primary shrink-0" />
                  </div>
                  <span className="text-base font-medium text-foreground/80 group-hover:text-foreground transition-colors">
                    {item}
                  </span>
                </div>
              ))}
            </motion.div>

            {/* Stats (Dades num√®riques petites) */}
            <motion.div variants={fadeInUp} className="grid grid-cols-3 gap-6 pt-8 mt-4 border-t border-border/50">
              {stats.map((stat, idx) => (
                <div key={idx} className="text-center lg:text-left">
                  <p className="text-3xl font-bold text-foreground mb-1">{stat.value}</p>
                  <p className="text-xs font-semibold text-muted-foreground uppercase tracking-wide">
                    {stat.label}
                  </p>
                </div>
              ))}
            </motion.div>
          </motion.div>

          {/* COLUMNA D'IMATGE */}
          <div className="relative order-1 lg:order-2">
            <motion.div 
              initial={{ opacity: 0, scale: 0.95 }} whileInView={{ opacity: 1, scale: 1 }}
              transition={{ duration: 0.8 }} viewport={{ once: true }}
              className="relative"
            >
                {/* Marc Decoratiu */}
                <div className="absolute inset-0 bg-linear-to-tr from-primary/20 to-transparent rounded-[2.5rem] rotate-3 blur-sm transform translate-x-4 translate-y-4 -z-10" />
                
                {/* Imatge Principal */}
                <div className="relative aspect-4/5 w-full rounded-4xl overflow-hidden shadow-2xl border border-border/50 bg-secondary/20">
                    <Image
                        src={image} 
                        alt={title} 
                        fill
                        className="object-cover transition-transform duration-700 hover:scale-105"
                        sizes="(max-width: 768px) 100vw, 50vw"
                    />
                </div>
            </motion.div>

            {/* Targeta Flotant Animada */}
            <motion.div 
                className="absolute -bottom-8 -left-8 md:bottom-10 md:-left-10 z-10 max-w-60 w-full"
                initial={{ y: 20, opacity: 0 }} whileInView={{ y: 0, opacity: 1 }}
                viewport={{ once: true }} transition={{ delay: 0.5, duration: 0.5 }}
            >
                <motion.div
                    animate={{ y: [0, -10, 0] }}
                    transition={{ repeat: Infinity, duration: 4, ease: "easeInOut" }}
                    className="bg-card/95 backdrop-blur-md p-5 rounded-2xl border border-border shadow-xl"
                >
                    <div className="flex items-center gap-4 mb-2">
                        <div className="p-2 bg-green-100 dark:bg-green-900/30 rounded-lg text-green-600 dark:text-green-400">
                            <TrendingUp className="w-6 h-6" />
                        </div>
                        <div>
                            <p className="text-sm font-bold text-foreground">{cardData.title}</p>
                            <p className="text-xs text-muted-foreground">{cardData.subtitle}</p>
                        </div>
                    </div>
                    {/* Barra de progr√©s decorativa */}
                    <div className="h-1.5 w-full bg-secondary rounded-full overflow-hidden">
                        <motion.div variants={progressBar} initial="hidden" whileInView="visible" viewport={{ once: true }} className="h-full bg-primary rounded-full" />
                    </div>
                </motion.div>
            </motion.div>

          </div>
        </div>
      </div>
    </section>
  );
}

// =================== FILE: src/components/modules/marketing/contact-section.tsx ===================

'use client';

import { useActionState, useEffect, useRef } from 'react';
import { ContactContent } from '@/types/models';
import { motion, AnimatePresence } from 'framer-motion';
import { Send, Mail, Phone, MapPin, Loader2, CheckCircle2, LucideIcon } from 'lucide-react';
import { submitContactForm } from '@/features/contact/actions';
import { cn } from '@/lib/utils';
import Link from 'next/link'; // üëà Importem Link per als termes

export function ContactSection({ data }: { data: ContactContent }) {
  const [state, formAction, isPending] = useActionState(submitContactForm, { 
    success: false, 
    message: '' 
  });
  
  const formRef = useRef<HTMLFormElement>(null);

  useEffect(() => {
    if (state.success && formRef.current) {
      formRef.current.reset();
    }
  }, [state.success]);

  return (
    <section className="relative py-24 bg-background overflow-hidden" id="contact">
      
      {/* ... (Fons decoratiu igual que abans) ... */}
      <div className="absolute top-0 left-0 w-full h-full overflow-hidden pointer-events-none -z-10">
          <div className="absolute top-[-10%] right-[-5%] w-[500px] h-[500px] bg-primary/5 rounded-full blur-[100px]" />
          <div className="absolute bottom-[-10%] left-[-10%] w-[400px] h-[400px] bg-secondary/10 rounded-full blur-[100px]" />
      </div>

      <div className="container px-4 mx-auto max-w-6xl">
        <div className="grid lg:grid-cols-2 gap-12 lg:gap-24 items-start">
          
          {/* ... (Columna Esquerra igual que abans) ... */}
          <motion.div 
             initial={{ opacity: 0, x: -30 }}
             whileInView={{ opacity: 1, x: 0 }}
             viewport={{ once: true }}
             transition={{ duration: 0.6 }}
          >
             {/* ... Contingut esquerra ... */}
             <span className="inline-block py-1 px-3 rounded-full bg-primary/10 text-primary text-xs font-bold uppercase tracking-wider mb-6">
              Contacte
            </span>
            <h2 className="text-4xl md:text-5xl font-black text-foreground mb-6 leading-tight">
              {data.title || "Parlem del teu projecte?"}
            </h2>
            <p className="text-lg text-muted-foreground mb-12 leading-relaxed">
              {data.description || "Tens una idea en ment? Estem aqu√≠ per ajudar-te a fer-la realitat."}
            </p>

            <div className="space-y-8">
              <ContactItem icon={Mail} title="Email" value={data.email || "hola@digitai.studio"} href={`mailto:${data.email}`} />
              <ContactItem icon={Phone} title="Tel√®fon" value={data.phone || "+34 93 123 45 67"} href={`tel:${data.phone}`} />
              <ContactItem icon={MapPin} title="Oficina" value={data.address || "Barcelona, Catalunya"} />
            </div>
          </motion.div>

          {/* --- COLUMNA DRETA: Formulari --- */}
          <motion.div 
            initial={{ opacity: 0, y: 30 }}
            whileInView={{ opacity: 1, y: 0 }}
            viewport={{ once: true }}
            transition={{ duration: 0.6, delay: 0.2 }}
            className="relative"
          >
            <div className="bg-card/50 backdrop-blur-xl border border-border/50 p-8 md:p-10 rounded-4xl shadow-2xl shadow-primary/5">
              
              <h3 className="text-2xl font-bold mb-6 text-foreground">Envia'ns un missatge</h3>
              
              <form ref={formRef} action={formAction} className="space-y-6">
                
                {/* Inputs existents... */}
                <div className="space-y-2">
                  <label htmlFor="name" className="text-sm font-medium text-foreground/80 ml-1">Nom complet</label>
                  <input type="text" id="name" name="name" required placeholder="Joan Garcia" className="w-full px-5 py-3.5 rounded-xl bg-background/50 border border-border focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none transition-all" />
                </div>

                <div className="space-y-2">
                  <label htmlFor="email" className="text-sm font-medium text-foreground/80 ml-1">Correu electr√≤nic</label>
                  <input type="email" id="email" name="email" required placeholder="joan@empresa.com" className="w-full px-5 py-3.5 rounded-xl bg-background/50 border border-border focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none transition-all" />
                </div>

                <div className="space-y-2">
                  <label htmlFor="message" className="text-sm font-medium text-foreground/80 ml-1">Missatge</label>
                  <textarea id="message" name="message" required rows={4} placeholder="Explica'ns el teu projecte..." className="w-full px-5 py-3.5 rounded-xl bg-background/50 border border-border focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none transition-all resize-none" />
                </div>

                {/* üëá CHECKBOX RGPD (NOU) */}
                <div className="flex items-start gap-3 pt-2">
                    <div className="relative flex items-center">
                        <input 
                            type="checkbox" 
                            id="terms" 
                            name="terms" 
                            required // Validaci√≥ client
                            className="peer h-5 w-5 cursor-pointer appearance-none rounded-md border border-border bg-background transition-all checked:border-primary checked:bg-primary hover:border-primary/50 focus:ring-2 focus:ring-primary/20"
                        />
                        {/* Icona Check custom (SVG) */}
                        <CheckCircle2 className="pointer-events-none absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-3.5 h-3.5 text-primary-foreground opacity-0 peer-checked:opacity-100 transition-opacity" />
                    </div>
                    
                    <label htmlFor="terms" className="text-xs text-muted-foreground leading-relaxed cursor-pointer select-none">
                        He llegit i accepto la{" "}
                        <Link href="/privacy" className="font-bold text-foreground hover:text-primary underline decoration-primary/30 underline-offset-2 transition-colors">
                            pol√≠tica de privacitat
                        </Link>{" "}
                        i els{" "}
                        <Link href="/terms" className="font-bold text-foreground hover:text-primary underline decoration-primary/30 underline-offset-2 transition-colors">
                            termes i condicions
                        </Link>
                        . Entenc que les meves dades es tractaran de forma segura.
                    </label>
                </div>

                {/* Missatges d'Estat */}
                <AnimatePresence>
                  {state.message && (
                    <motion.div 
                      initial={{ opacity: 0, height: 0 }}
                      animate={{ opacity: 1, height: 'auto' }}
                      exit={{ opacity: 0, height: 0 }}
                      className={cn(
                        "p-4 rounded-lg text-sm font-medium flex items-center gap-2",
                        state.success 
                          ? "bg-green-500/10 text-green-600 dark:text-green-400 border border-green-500/20" 
                          : "bg-red-500/10 text-red-600 dark:text-red-400 border border-red-500/20"
                      )}
                    >
                      {state.success ? <CheckCircle2 className="w-4 h-4" /> : null}
                      {state.message}
                    </motion.div>
                  )}
                </AnimatePresence>

                {/* Bot√≥ Submit */}
                <button 
                  type="submit" 
                  disabled={isPending}
                  className="w-full group relative flex items-center justify-center gap-2 px-8 py-4 bg-foreground text-background rounded-xl font-bold text-lg overflow-hidden transition-all disabled:opacity-70 disabled:cursor-not-allowed hover:shadow-lg hover:shadow-primary/10"
                >
                  <div className="absolute inset-0 bg-primary translate-y-full group-hover:translate-y-0 transition-transform duration-300 ease-out" />
                  <span className="relative z-10 flex items-center gap-2 group-hover:text-primary-foreground transition-colors">
                    {isPending ? (
                      <> <Loader2 className="w-5 h-5 animate-spin" /> Enviant... </>
                    ) : (
                      <> Enviar Missatge <Send className="w-4 h-4 group-hover:translate-x-1 transition-transform" /> </>
                    )}
                  </span>
                </button>

              </form>
            </div>
          </motion.div>

        </div>
      </div>
    </section>
  );
}

// ... ContactItem es mant√© igual ...
interface ContactItemProps {
  icon: LucideIcon;
  title: string;
  value: string;
  href?: string;
}

function ContactItem({ icon: Icon, title, value, href }: ContactItemProps) {
    const Wrapper = href ? 'a' : 'div';
    return (
        <Wrapper href={href} className={cn("flex items-start gap-5 p-4 rounded-2xl transition-all duration-300 border border-transparent", href ? "hover:bg-card hover:border-border hover:shadow-sm group cursor-pointer" : "")}>
            <div className="p-3 bg-secondary rounded-xl text-foreground group-hover:bg-primary group-hover:text-primary-foreground transition-colors duration-300">
                <Icon className="w-6 h-6" />
            </div>
            <div>
                <h3 className="font-bold text-foreground text-base mb-1">{title}</h3>
                <p className="text-muted-foreground group-hover:text-primary transition-colors duration-300 font-medium">{value}</p>
            </div>
        </Wrapper>
    );
}

// =================== FILE: src/components/modules/marketing/cta-section.tsx ===================

'use client';

import { CTABannerContent } from '@/types/models';
import Link from 'next/link';
import { motion } from 'framer-motion';
import { ArrowRight, CheckCircle2 } from 'lucide-react';

export function CTABannerSection({ data }: { data: CTABannerContent }) {
  return (
    <section className="py-24 px-4 relative overflow-hidden">
        <div className="container mx-auto max-w-6xl relative z-10">
            
            {/* 1. CONTENIDOR PRINCIPAL (Glassmorphism Adaptatiu) 
                - Light: Fons blanc transl√∫cid, vores suaus.
                - Dark: Fons negre transl√∫cid, vores brillants.
            */}
            <motion.div 
                initial={{ opacity: 0, y: 40 }}
                whileInView={{ opacity: 1, y: 0 }}
                viewport={{ once: true, margin: "-100px" }}
                transition={{ duration: 0.8, ease: "easeOut" }}
                className="relative overflow-hidden rounded-[3rem] border border-border/50 bg-background/30 backdrop-blur-2xl shadow-2xl isolate"
            >
                
                {/* 2. MOTOR D'ANIMACI√ì DE FONS (L'Aurora) */}
                <div className="absolute inset-0 -z-10 overflow-hidden">
                    
                    {/* Blob 1: Color Primari (Es mou lentament) */}
                    <motion.div 
                        animate={{ 
                            scale: [1, 1.2, 1],
                            x: [0, 100, 0],
                            y: [0, -50, 0],
                        }}
                        transition={{ duration: 15, repeat: Infinity, ease: "easeInOut" }}
                        className="absolute -top-[20%] -right-[10%] w-150 h-150 rounded-full bg-primary/20 blur-[120px] dark:bg-primary/30 dark:blur-[150px]"
                    />
                    
                    {/* Blob 2: Color Secundari (Es mou en contra) */}
                    <motion.div 
                        animate={{ 
                            scale: [1, 1.5, 1],
                            x: [0, -100, 0],
                            y: [0, 50, 0],
                        }}
                        transition={{ duration: 20, repeat: Infinity, ease: "easeInOut", delay: 2 }}
                        className="absolute -bottom-[20%] -left-[10%] w-125 h-125 rounded-full bg-secondary/20 blur-[100px] dark:bg-secondary/30 dark:blur-[140px]"
                    />
                </div>

                {/* Grid Overlay Subtil (Per donar textura professional) */}
                <div className="absolute inset-0 bg-[url('https://grainy-gradients.vercel.app/noise.svg')] opacity-[0.02] mix-blend-overlay pointer-events-none" />


                {/* 3. ESTRUCTURA DE CONTINGUT (Grid) */}
                <div className="relative z-10 grid lg:grid-cols-2 gap-12 p-10 md:p-20 items-center">
                    
                    {/* TEXT (Esquerra) */}
                    <div className="text-left space-y-6">
                        <motion.h2 
                            initial={{ opacity: 0, y: 20 }}
                            whileInView={{ opacity: 1, y: 0 }}
                            transition={{ delay: 0.2 }}
                            className="text-4xl md:text-5xl lg:text-6xl font-black tracking-tight leading-[1.1] text-foreground"
                        >
                            {data.heading}
                        </motion.h2>
                        
                        <motion.p 
                            initial={{ opacity: 0, y: 20 }}
                            whileInView={{ opacity: 1, y: 0 }}
                            transition={{ delay: 0.3 }}
                            className="text-lg md:text-xl text-muted-foreground leading-relaxed max-w-md font-medium"
                        >
                            {data.subheading}
                        </motion.p>

                        {/* Punts de confian√ßa (Trust Signals) */}
                        <motion.div 
                            initial={{ opacity: 0 }}
                            whileInView={{ opacity: 1 }}
                            transition={{ delay: 0.4 }}
                            className="flex flex-col sm:flex-row gap-4 pt-4"
                        >
                            {['Proves gratu√Øtes', 'Configuraci√≥ instant√†nia'].map((item, i) => (
                                <div key={i} className="flex items-center gap-2 text-sm text-foreground/70 font-semibold bg-background/50 px-4 py-2 rounded-full border border-border/50">
                                    <CheckCircle2 className="w-5 h-5 text-primary" />
                                    {item}
                                </div>
                            ))}
                        </motion.div>
                    </div>

                    {/* ACCI√ì (Dreta) */}
                    <div className="flex flex-col items-start lg:items-end justify-center">
                        <motion.div 
                            whileHover={{ scale: 1.05 }}
                            whileTap={{ scale: 0.95 }}
                            className="relative group"
                        >
                            {/* Halo Glow darrere del bot√≥ */}
                            <div className="absolute -inset-1 bg-linear-to-r from-primary via-secondary to-primary rounded-full blur opacity-40 group-hover:opacity-100 transition duration-500 animate-gradient-x" />
                            
                            <Link 
                                href={data.buttonLink} 
                                className="relative flex items-center gap-4 bg-primary text-primary-foreground px-10 py-6 rounded-full font-bold text-xl shadow-xl transition-all"
                            >
                                <span>{data.buttonText}</span>
                                <div className="bg-background/20 rounded-full p-2 group-hover:translate-x-1 transition-transform">
                                    <ArrowRight className="w-5 h-5 text-primary-foreground" />
                                </div>
                            </Link>
                        </motion.div>
                        
                        <p className="mt-6 text-sm text-muted-foreground text-center lg:text-right w-full lg:w-auto opacity-70">
                            No es requereix targeta de cr√®dit
                        </p>
                    </div>

                </div>

                {/* Vora brillant suau (Glass Border) */}
                <div className="absolute inset-0 border border-white/20 dark:border-white/10 rounded-[3rem] pointer-events-none" />
                
            </motion.div>
        </div>
    </section>
  );
}

// =================== FILE: src/components/modules/marketing/faq-section.tsx ===================

'use client';

import { useState } from 'react';
import { FAQContent } from '@/types/models';
import { ChevronDown, MessageCircle, Sparkles } from 'lucide-react';
import { motion, AnimatePresence, Variants } from 'framer-motion';
import { cn } from '@/lib/utils';

// Ampliem la demo a 6 preguntes per veure b√© l'efecte Grid
const DEMO_FAQS = [
  {
    question: "Quant trigueu a entregar el projecte?",
    answer: "Normalment, per a projectes est√†ndard, el termini d'entrega √©s de 2 a 4 setmanes. Per a desenvolupaments a mida m√©s complexos, establim un cronograma detallat."
  },
  {
    question: "Puc actualitzar el contingut jo mateix?",
    answer: "I tant! Totes les nostres webs inclouen un panell d'administraci√≥ intu√Øtiu perqu√® puguis canviar textos, imatges i productes sense necessitat de saber programaci√≥."
  },
  {
    question: "Oferiu manteniment post-llan√ßament?",
    answer: "S√≠, oferim plans de manteniment que inclouen actualitzacions de seguretat, c√≤pies de seguretat di√†ries i suport t√®cnic prioritari."
  },
  {
    question: "La web estar√† optimitzada per a Google?",
    answer: "Absolutament. Desenvolupem seguint les millors pr√†ctiques de Google: velocitat de c√†rrega, estructura sem√†ntica i meta-etiquetes optimitzades."
  },
  {
    question: "Com funcionen els pagaments?",
    answer: "Treballem amb un 50% per avan√ßat a l'inici del projecte i el 50% restant un cop la web est√† publicada i validada per tu."
  },
  {
    question: "Integreu passarel¬∑les de pagament?",
    answer: "S√≠, som experts en integrar Stripe, PayPal i Redsys perqu√® puguis cobrar els teus serveis o productes directament des de la web."
  }
];

export function FAQSection({ data }: { data: FAQContent }) {
  const [openIndex, setOpenIndex] = useState<number | null>(0);

  const items = data?.items?.length > 0 ? data.items : DEMO_FAQS;
  const title = data?.title || "Preguntes Freq√ºents";
  const subtitle = data?.subtitle || "Tot el que necessites saber sobre com treballem.";

  const toggle = (index: number) => {
    setOpenIndex(openIndex === index ? null : index);
  };

  // --- VARIANTS ---
  const containerVars: Variants = {
    hidden: { opacity: 0 },
    visible: {
      opacity: 1,
      transition: { staggerChildren: 0.1, delayChildren: 0.2 }
    }
  };

  const itemVars: Variants = {
    hidden: { opacity: 0, y: 30, scale: 0.95 },
    visible: { 
      opacity: 1, y: 0, scale: 1,
      transition: { type: "spring", stiffness: 70, damping: 20 } 
    }
  };

  const contentVars: Variants = {
    collapsed: { opacity: 0, height: 0, marginTop: 0, scale: 0.98 },
    open: { 
      opacity: 1, height: "auto", marginTop: 16, scale: 1,
      transition: { duration: 0.4, ease: [0.04, 0.62, 0.23, 0.98] }
    }
  };

  return (
    <section className="relative py-24 bg-background overflow-hidden">
      
      {/* FONS ANIMAT */}
      <div className="absolute inset-0 overflow-hidden pointer-events-none">
          <motion.div 
            animate={{ scale: [1, 1.2, 1], opacity: [0.3, 0.5, 0.3] }}
            transition={{ duration: 8, repeat: Infinity, ease: "easeInOut" }}
            className="absolute -top-[20%] -right-[10%] w-150 h-150 bg-primary/5 rounded-full blur-[120px]" 
          />
          <div className="absolute bottom-0 left-0 w-100 h-100 bg-secondary/10 rounded-full blur-[100px]" />
      </div>

      {/* CANVI 1: Ampliem container de max-w-3xl a max-w-6xl 
         perqu√® c√†piguen b√© les dues columnes 
      */}
      <div className="container mx-auto px-4 max-w-6xl relative z-10">
        
        {/* HEADER */}
        <div className="text-center mb-16 max-w-3xl mx-auto">
          <motion.div 
            initial={{ scale: 0, rotate: -180 }} 
            whileInView={{ scale: 1, rotate: 0 }}
            viewport={{ once: true }}
            className="inline-flex items-center justify-center p-4 bg-linear-to-br from-primary/10 to-primary/5 rounded-2xl mb-6 text-primary shadow-lg shadow-primary/10 ring-1 ring-primary/20"
          >
            <Sparkles className="w-8 h-8" />
          </motion.div>
          
          <motion.h2 
            initial={{ opacity: 0, y: 20 }}
            whileInView={{ opacity: 1, y: 0 }}
            viewport={{ once: true }}
            className="text-4xl md:text-5xl font-black mb-6 tracking-tight text-foreground"
          >
            {title}
          </motion.h2>
          
          <p className="text-lg text-muted-foreground leading-relaxed">
            {subtitle}
          </p>
        </div>

        {/* CANVI 2: GRID SYSTEM 
           - grid-cols-1 (m√≤bil)
           - md:grid-cols-2 (escriptori)
           - gap-6 (espai entre targetes)
           - items-start (perqu√® si una s'obre, no estiri la del costat)
        */}
        <motion.div 
            variants={containerVars}
            initial="hidden"
            whileInView="visible"
            viewport={{ once: true, margin: "-100px" }}
            className="grid grid-cols-1 md:grid-cols-2 gap-6 items-start"
        >
          {items.map((item, i) => {
            const isOpen = openIndex === i;
            
            return (
              <motion.div 
                key={i} 
                variants={itemVars}
                className={cn(
                  "group relative rounded-2xl overflow-hidden transition-all duration-500",
                  isOpen 
                    ? "bg-card shadow-xl shadow-primary/5 ring-1 ring-primary/30 z-10" 
                    : "bg-card/40 hover:bg-card hover:shadow-md border border-border/50"
                )}
              >
                {/* Gradient de fons actiu */}
                <div className={cn(
                    "absolute inset-0 bg-linear-to-r from-primary/5 to-transparent opacity-0 transition-opacity duration-500 pointer-events-none",
                    isOpen && "opacity-100"
                )} />

                <button
                  onClick={() => toggle(i)}
                  className="relative w-full flex items-start justify-between p-6 text-left focus:outline-none focus-visible:ring-2 focus-visible:ring-primary z-10"
                >
                  <div className="flex items-start gap-4">
                      {/* Icona */}
                      <div className={cn(
                          "hidden sm:flex items-center justify-center w-8 h-8 rounded-full transition-colors duration-300 mt-1 shrink-0",
                          isOpen ? "bg-primary text-primary-foreground" : "bg-secondary text-muted-foreground"
                      )}>
                          <MessageCircle className="w-4 h-4" />
                      </div>

                      <span className={cn(
                        "font-bold text-lg transition-colors duration-300 leading-tight",
                        isOpen ? "text-primary" : "text-foreground group-hover:text-foreground/80"
                      )}>
                        {item.question}
                      </span>
                  </div>
                  
                  {/* Fletxa */}
                  <motion.div
                    animate={{ rotate: isOpen ? 180 : 0 }}
                    transition={{ type: "spring", stiffness: 200, damping: 20 }}
                    className={cn(
                        "p-2 rounded-full transition-colors shrink-0 ml-2",
                        isOpen ? "bg-primary/10 text-primary" : "text-muted-foreground"
                    )}
                  >
                    <ChevronDown className="w-5 h-5" />
                  </motion.div>
                </button>

                <AnimatePresence initial={false}>
                    {isOpen && (
                        <motion.div
                            initial="collapsed"
                            animate="open"
                            exit="collapsed"
                            variants={contentVars}
                            className="relative z-10 px-6 sm:pl-18 pr-6 pb-6"
                        >
                            <div className="text-muted-foreground leading-relaxed text-base">
                                {item.answer}
                            </div>
                        </motion.div>
                    )}
                </AnimatePresence>
              </motion.div>
            );
          })}
        </motion.div>
      </div>
    </section>
  );
}

// =================== FILE: src/components/modules/marketing/featured-products-section.tsx ===================

import { FeaturedProductsContent } from '@/types/models';
import { getProductsAction } from '@/features/ecommerce/actions';
import { ProductGrid } from '../ecommerce/product-grid'; // Importem el nostre grid animat
import Link from 'next/link';
import { ArrowRight, Sparkles } from 'lucide-react';

export async function FeaturedProductsSection({ data }: { data: FeaturedProductsContent }) {
  // 1. Fetch dels productes (al servidor)
  const allProducts = await getProductsAction();
  
  // 2. Filtrem els N primers (o els que tinguin flag 'featured' si en tens)
  const productsToShow = allProducts.slice(0, data.limit || 4);

  if (productsToShow.length === 0) return null;

  return (
    <section className="py-24 relative overflow-hidden bg-background">
      
      {/* Elements decoratius de fons */}
      <div className="absolute top-0 left-1/2 -translate-x-1/2 w-full h-full max-w-7xl pointer-events-none">
          <div className="absolute top-20 right-0 w-96 h-96 bg-primary/5 rounded-full blur-[100px]" />
          <div className="absolute bottom-0 left-0 w-72 h-72 bg-secondary/5 rounded-full blur-[80px]" />
      </div>

      <div className="container mx-auto px-4 relative z-10">
        
        {/* HEADER DE SECCI√ì ANIMAT */}
        {/* Nota: Com que estem en un Server Component, podem usar classes d'animaci√≥ CSS 
            o crear un petit wrapper 'SectionHeader' client si volem Framer Motion aqu√≠ tamb√©.
            Per simplicitat i rendiment, usarem un layout net.
        */}
        <div className="flex flex-col md:flex-row justify-between items-end mb-16 gap-6">
            <div className="max-w-2xl">
                <div className="flex items-center gap-2 mb-3">
                    <span className="inline-flex items-center justify-center w-8 h-8 rounded-full bg-primary/10 text-primary">
                        <Sparkles size={16} />
                    </span>
                    <span className="text-sm font-bold tracking-widest text-primary uppercase">
                        Selecci√≥ Exclusiva
                    </span>
                </div>
                
                <h2 className="text-4xl md:text-5xl font-black text-foreground tracking-tight leading-[1.1]">
                    {data.title}
                </h2>
                <p className="mt-4 text-xl text-muted-foreground leading-relaxed max-w-lg">
                    {data.subtitle}
                </p>
            </div>

            <Link href="/shop" className="group">
                <div className="flex items-center gap-3 px-6 py-3 rounded-full bg-secondary/10 hover:bg-secondary/20 transition-all text-secondary-foreground font-bold">
                    <span>Veure tota la col¬∑lecci√≥</span>
                    <div className="bg-background rounded-full p-1.5 group-hover:translate-x-1 transition-transform">
                        <ArrowRight className="w-4 h-4 text-foreground" />
                    </div>
                </div>
            </Link>
        </div>

        {/* GRID DE PRODUCTES (Client Component) */}
        <ProductGrid products={productsToShow} />
        
      </div>
    </section>
  );
}

// =================== FILE: src/components/modules/marketing/hero-section.tsx ===================

'use client';

import { HeroContent } from '@/types/models';
import { motion, Variants } from 'framer-motion';
import { ArrowRight, PlayCircle } from 'lucide-react';
import { useTranslations } from 'next-intl';

export function HeroSection({ data }: { data: HeroContent }) {
  const t = useTranslations('Hero'); // Assegura't de tenir aix√≤ al teu json

  const container: Variants = {
    hidden: { opacity: 0 },
    show: {
      opacity: 1,
      transition: {
        staggerChildren: 0.15,
        delayChildren: 0.2,
      }
    }
  };

  const item: Variants = {
    hidden: { opacity: 0, y: 30, scale: 0.95 },
    show: {
      opacity: 1,
      y: 0,
      scale: 1,
      transition: {
        type: "spring",
        stiffness: 70,
        damping: 15
      }
    }
  };

  return (
    <section className="relative py-24 lg:py-40 overflow-hidden flex flex-col items-center justify-center min-h-[85vh]">
      
      {/* 1. Fons Din√†mic (Theme-Aware) */}
      <div className="absolute inset-0 bg-background transition-colors duration-500 -z-20" />
      
      {/* Blob Primari (Lila) */}
      <motion.div
        animate={{
          scale: [1, 1.1, 1],
          opacity: [0.3, 0.5, 0.3],
          x: [0, 20, 0]
        }}
        transition={{ duration: 8, repeat: Infinity, ease: "easeInOut" }}
        className="absolute top-0 right-0 -mr-20 -mt-20 w-125 h-125 rounded-full bg-primary/20 blur-[120px] pointer-events-none -z-10"
      />
      
      {/* Blob Secundari (Verd/Blau) */}
      <motion.div
        animate={{
          scale: [1, 1.2, 1],
          opacity: [0.2, 0.4, 0.2],
          x: [0, -20, 0]
        }}
        transition={{ duration: 10, repeat: Infinity, ease: "easeInOut", delay: 1 }}
        className="absolute bottom-0 left-0 -ml-20 -mb-20 w-100 h-100 rounded-full bg-secondary/20 blur-[100px] pointer-events-none -z-10"
      />

      {/* 2. Contingut Principal */}
      <motion.div
        variants={container}
        initial="hidden"
        whileInView="show"
        viewport={{ once: true }}
        className="container mx-auto px-4 relative z-10 text-center max-w-5xl"
      >
        {/* Badge "Company Name" */}
        <motion.div variants={item} className="flex justify-center mb-8">
          <span className="inline-flex items-center gap-2 px-4 py-1.5 rounded-full bg-secondary/10 text-secondary text-sm font-bold tracking-wide ring-1 ring-inset ring-secondary/20 shadow-sm shadow-secondary/10">
            ‚ú® {data.companyName}
          </span>
        </motion.div>

        {/* T√≠tol Gran */}
        <motion.h1
          variants={item}
          className="text-5xl sm:text-6xl md:text-7xl lg:text-8xl font-extrabold tracking-tight mb-8 text-foreground leading-[1.1]"
        >
          {/* Gradient intel¬∑ligent: Va del color de text base al color primari */}
          <span className="bg-clip-text text-transparent bg-linear-to-r from-foreground via-foreground to-primary animate-gradient-x">
            {data.title}
          </span>
        </motion.h1>

        {/* Subt√≠tol */}
        <motion.p
          variants={item}
          className="text-xl md:text-2xl text-muted-foreground max-w-2xl mx-auto mb-12 leading-relaxed font-medium"
        >
          {data.subtitle}
        </motion.p>

        {/* Botons d'Acci√≥ */}
        <motion.div variants={item} className="flex flex-col sm:flex-row items-center justify-center gap-4">

          {/* Primary CTA */}
          <button className="group relative w-full sm:w-auto bg-primary text-primary-foreground px-8 py-4 rounded-xl font-bold shadow-xl shadow-primary/20 hover:shadow-primary/40 transition-all hover:-translate-y-1 active:translate-y-0 flex items-center justify-center gap-3 overflow-hidden">
            <span className="relative z-10">{data.ctaText}</span>
            <ArrowRight className="w-5 h-5 relative z-10 group-hover:translate-x-1 transition-transform" />
            {/* Brillantor al hover */}
            <div className="absolute inset-0 bg-white/20 translate-y-full group-hover:translate-y-0 transition-transform duration-300" />
          </button>

          {/* Secondary CTA */}
          <button className="group w-full sm:w-auto px-8 py-4 rounded-xl font-bold border border-border bg-background/50 backdrop-blur hover:border-primary/50 hover:bg-primary/5 text-foreground transition-all flex items-center justify-center gap-3 hover:-translate-y-1">
            <PlayCircle className="w-5 h-5 text-muted-foreground group-hover:text-primary transition-colors" />
            <span>{t('demoVideo') || "Veure Demo"}</span>
          </button>

        </motion.div>
      </motion.div>
    </section>
  );
}

// =================== FILE: src/components/modules/marketing/map-section.tsx ===================

'use client';

import { MapContent } from '@/types/models';
import { motion, Variants } from 'framer-motion';
import { MapPin, Navigation, ExternalLink} from 'lucide-react';
import { cn } from '@/lib/utils';

// 1. DADES "INVENTADES" (Fallback) per si no arriba configuraci√≥
// Aix√≠ sempre veur√†s un mapa bonic de Barcelona en lloc d'un espai buit.
const DEFAULT_LOCATION = {
  title: "Seu Central DigitAI",
  address: "Pla√ßa de Catalunya, 1, 08002 Barcelona",
  // Aquesta √©s una URL d'embed real de Google Maps (Pla√ßa Catalunya)
  embedUrl: "https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d2993.438863673733!2d2.168568476686311!3d41.38639397130283!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x12a4a2f260e1a991%3A0x1d5b037307044230!2sPl.%20de%20Catalunya%2C%20Barcelona!5e0!3m2!1sca!2ses!4v1716300000000!5m2!1sca!2ses"
};

export function MapSection({ data }: { data: MapContent }) {
  
  // Fusi√≥ de dades reals amb les dades per defecte
  const location = {
    title: data.title || DEFAULT_LOCATION.title,
    address: data.address || DEFAULT_LOCATION.address,
    embedUrl: (data.embedUrl && data.embedUrl.length > 5) ? data.embedUrl : DEFAULT_LOCATION.embedUrl
  };

  const cardVariants: Variants = {
    hidden: { opacity: 0, y: 30, scale: 0.95 },
    show: { 
      opacity: 1, 
      y: 0, 
      scale: 1,
      transition: { type: "spring", stiffness: 60, damping: 20, delay: 0.2 } 
    }
  };

  return (
    <section className="relative w-full h-125 md:h-150 group overflow-hidden bg-muted/10 border-y border-border/50">
      
      {/* üó∫Ô∏è MAPA IFRAME */}
      <div className="absolute inset-0 w-full h-full">
         {/* Truc visual: Grayscale al 100% per defecte (m√©s elegant) 
            i a tot color quan fas hover.
         */}
         <iframe 
            src={location.embedUrl} 
            width="100%" 
            height="100%" 
            style={{ border: 0 }} 
            allowFullScreen 
            loading="lazy" 
            referrerPolicy="no-referrer-when-downgrade"
            title="Localitzaci√≥ de l'empresa"
            className="w-full h-full object-cover grayscale transition-all duration-700 ease-in-out group-hover:grayscale-0 opacity-90 group-hover:opacity-100"
         />
         
         {/* Overlay Gradient: Suavitza la uni√≥ amb la web a dalt i a baix */}
         <div className="absolute inset-x-0 top-0 h-24 bg-linear-to-b from-background to-transparent pointer-events-none" />
         <div className="absolute inset-x-0 bottom-0 h-24 bg-linear-to-t from-background to-transparent pointer-events-none" />
      </div>

      {/* üìç TARGETA FLOTANT D'INFORMACI√ì */}
      <div className="container mx-auto px-4 h-full relative pointer-events-none flex flex-col justify-end pb-12 md:pb-16">
        <motion.div 
            variants={cardVariants}
            initial="hidden"
            whileInView="show"
            viewport={{ once: true }}
            className="pointer-events-auto max-w-sm w-full bg-card/85 backdrop-blur-xl border border-white/20 dark:border-slate-800/50 p-6 rounded-3xl shadow-2xl shadow-black/10"
        >
            <div className="flex items-start gap-5">
                {/* Icona Gran */}
                <div className="p-3.5 bg-primary rounded-2xl text-primary-foreground shadow-lg shadow-primary/20 shrink-0">
                    <MapPin className="w-6 h-6" />
                </div>

                <div className="space-y-3">
                    <div>
                        <h3 className="font-bold text-xl text-foreground tracking-tight">
                            {location.title}
                        </h3>
                        <p className="text-muted-foreground text-sm leading-relaxed mt-1">
                            {location.address}
                        </p>
                    </div>

                    <div className="flex gap-3 pt-2">
                        {/* Bot√≥ Principal: Com arribar-hi */}
                        <a 
                            href={`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(location.address)}`} 
                            target="_blank" 
                            rel="noreferrer"
                            className={cn(
                                "flex items-center gap-2 px-4 py-2 rounded-xl text-xs font-bold transition-all",
                                "bg-foreground text-background hover:bg-foreground/80 shadow-md"
                            )}
                        >
                            <Navigation className="w-3.5 h-3.5" />
                            Com arribar-hi
                        </a>

                        {/* Bot√≥ Secundari: Veure al mapa */}
                        <a 
                             href={`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(location.address)}`} 
                             target="_blank" 
                             rel="noreferrer"
                             className="flex items-center gap-2 px-3 py-2 rounded-xl text-xs font-bold text-foreground hover:bg-secondary/50 transition-colors border border-border/50"
                        >
                            <ExternalLink className="w-3.5 h-3.5" />
                        </a>
                    </div>
                </div>
            </div>
        </motion.div>
      </div>
    </section>
  );
}

// =================== FILE: src/components/modules/marketing/services-section.tsx ===================

'use client';

import { ServiceContent, ServiceDTO } from '@/types/models';
import { motion, Variants } from 'framer-motion';
import { Sparkles, ArrowRight } from 'lucide-react';
import { ServiceCard } from '../landing/service-card'; 

// ‚úÖ 1. Definim el tipus exacte per als items de la IA
interface AIServiceItem {
    title: string;
    description: string;
}

interface Props {
    headerData: ServiceContent;
    services: ServiceDTO[];
}

export function ServicesSection({ headerData, services }: Props) {

    // --- 1. L√íGICA DE DECISI√ì (El Cervell del Component) ---
    const dbItems = services || [];
    
    // ‚úÖ 2. SOLUCI√ì ERROR: Fem un 'Cast' expl√≠cit aqu√≠.
    // Li diem a TypeScript: "Confia en mi, aix√≤ √©s un array de AIServiceItem"
    const aiItems = (headerData.items || []) as AIServiceItem[]; 

    // Tenim serveis reals (amb preu, imatge, etc.)?
    const hasDbServices = dbItems.length > 0;
    // Si no, tenim serveis inventats per la IA (nom√©s text)?
    const hasAiServices = !hasDbServices && aiItems.length > 0;
    // Si no tenim res de res
    const showEmptyState = !hasDbServices && !hasAiServices;

    // Textos
    const headlinePrefix = headerData.headlinePrefix || "Escull la teva";
    const headlineHighlight = headerData.headlineHighlight || "Experi√®ncia";
    const emptyTitle = headerData.emptyState?.title || "No hi ha serveis";
    const emptyText = headerData.emptyState?.text || "Torna m√©s tard.";

    // Animacions
    const container: Variants = {
        hidden: { opacity: 0 },
        show: {
            opacity: 1,
            transition: { staggerChildren: 0.1, delayChildren: 0.2 }
        }
    };

    return (
        <section className="py-24 md:py-32 bg-secondary/5 relative overflow-hidden" id="services">

            {/* Fons Decoratiu */}
            <div className="absolute top-0 right-0 w-125 h-125 bg-primary/5 rounded-full blur-[120px] -translate-y-1/2 translate-x-1/2 pointer-events-none" />
            <div className="absolute bottom-0 left-0 w-125 h-125 bg-secondary/10 rounded-full blur-[120px] translate-y-1/2 -translate-x-1/2 pointer-events-none" />

            <div className="container mx-auto px-4 relative z-10">

                {/* Cap√ßalera */}
                <div className="text-center mb-20 max-w-3xl mx-auto">
                    <motion.div
                        initial={{ opacity: 0, y: 20 }}
                        whileInView={{ opacity: 1, y: 0 }}
                        viewport={{ once: true }}
                        transition={{ duration: 0.6 }}
                    >
                        <span className="text-primary font-bold tracking-wider uppercase text-sm mb-2 block">
                            {headerData.title}
                        </span>
                        <h2 className="text-4xl md:text-5xl lg:text-6xl font-black mb-6 text-foreground tracking-tight">
                            {headlinePrefix} <span className="text-transparent bg-clip-text bg-linear-to-r from-primary to-primary/60">{headlineHighlight}</span>
                        </h2>
                        <p className="text-xl text-muted-foreground leading-relaxed">
                            {headerData.subtitle}
                        </p>
                    </motion.div>
                </div>

                {/* --- ESCENARI A: SERVEIS REALS (DB) --- */}
                {hasDbServices && (
                    <motion.div
                        variants={container}
                        initial="hidden"
                        whileInView="show"
                        viewport={{ once: true, margin: "-50px" }}
                        className="grid md:grid-cols-2 lg:grid-cols-3 gap-8"
                    >
                        {dbItems.map((service, i) => (
                            <ServiceCard key={service.id} service={service} index={i} />
                        ))}
                    </motion.div>
                )}

                {/* --- ESCENARI B: SERVEIS IA (Text Only) --- */}
                {hasAiServices && (
                    <motion.div
                        variants={container}
                        initial="hidden"
                        whileInView="show"
                        viewport={{ once: true, margin: "-50px" }}
                        className="grid md:grid-cols-2 lg:grid-cols-3 gap-8"
                    >
                        {/* ‚úÖ 3. Ara ja no cal tipar 'item' aqu√≠, TypeScript ja ho sap gr√†cies al pas 2 */}
                        {aiItems.map((item, i) => (
                            <motion.div
                                key={i}
                                variants={{ hidden: { opacity: 0, y: 20 }, show: { opacity: 1, y: 0 } }}
                                className="group relative p-8 bg-background rounded-3xl border border-border/50 shadow-lg hover:shadow-xl hover:-translate-y-1 transition-all duration-300 overflow-hidden"
                            >
                                {/* Gradient subtil al hover */}
                                <div className="absolute inset-0 bg-linear-to-br from-primary/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity" />

                                <div className="relative z-10">
                                    <div className="w-14 h-14 bg-primary/10 rounded-2xl flex items-center justify-center mb-6 group-hover:scale-110 transition-transform duration-300">
                                        <Sparkles className="w-7 h-7 text-primary" />
                                    </div>

                                    <h3 className="text-2xl font-bold mb-3 text-foreground group-hover:text-primary transition-colors">
                                        {item.title}
                                    </h3>

                                    <p className="text-muted-foreground leading-relaxed mb-6">
                                        {item.description}
                                    </p>

                                    <div className="flex items-center text-sm font-bold text-primary opacity-0 group-hover:opacity-100 transform translate-y-2 group-hover:translate-y-0 transition-all duration-300">
                                        Saber-ne m√©s <ArrowRight className="ml-2 w-4 h-4" />
                                    </div>
                                </div>
                            </motion.div>
                        ))}
                    </motion.div>
                )}

                {/* --- ESCENARI C: BUIT --- */}
                {showEmptyState && (
                    <motion.div
                        initial={{ opacity: 0, scale: 0.9 }}
                        animate={{ opacity: 1, scale: 1 }}
                        className="flex flex-col items-center justify-center py-20 bg-card rounded-3xl border border-dashed border-muted-foreground/20 text-center max-w-2xl mx-auto"
                    >
                        <div className="w-16 h-16 bg-muted rounded-full flex items-center justify-center mb-4">
                            <Sparkles className="w-8 h-8 text-muted-foreground" />
                        </div>
                        <h3 className="text-xl font-bold text-foreground mb-2">{emptyTitle}</h3>
                        <p className="text-muted-foreground">{emptyText}</p>
                    </motion.div>
                )}
            </div>
        </section>
    );
}

// =================== FILE: src/components/modules/marketing/stats-section.tsx ===================

'use client';

import { StatsContent } from '@/types/models';
import { motion, useSpring, useTransform, useInView, Variants } from 'framer-motion';
import { useEffect, useRef } from 'react';

// ‚ú® Component M√†gic: Comptador Animat
function AnimatedCounter({ value, suffix = "" }: { value: string, suffix?: string }) {
  // Neteja: Extraiem nom√©s els n√∫meros per animar
  const numericValue = parseInt(value.replace(/[^0-9]/g, '')) || 0;
  // Extraiem s√≠mbols com "+", "k", "%" per pintar-los est√†tics
  const nonNumericSuffix = value.replace(/[0-9]/g, ''); 

  const ref = useRef(null);
  const isInView = useInView(ref, { once: true, margin: "-20px" });
  
  // F√çSICA DISNEY: M√©s 'damping' per evitar que oscil¬∑li massa al final
  const spring = useSpring(0, { mass: 1, stiffness: 75, damping: 15 });
  const display = useTransform(spring, (current) => Math.round(current));

  useEffect(() => {
    if (isInView) {
      spring.set(numericValue);
    }
  }, [isInView, numericValue, spring]);

  return (
    <span ref={ref} className="inline-flex items-baseline">
      <motion.span>{display}</motion.span>
      <span className="ml-0.5">{nonNumericSuffix}{suffix}</span>
    </span>
  );
}

export function StatsSection({ data }: { data: StatsContent }) {
  
  // üõ°Ô∏è SECURITY GUARD: Evitem errors si la IA no ha generat items
  const items = data?.items || [];

  // Si no hi ha estad√≠stiques, no renderitzem res (millor que un error o espai buit)
  if (items.length === 0) return null;

  // 1. Definim els tipus correctament amb Variants
  const containerVariants: Variants = {
    hidden: { opacity: 0 },
    show: {
      opacity: 1,
      transition: { 
        staggerChildren: 0.15, // Efecte cascada r√†pid
        delayChildren: 0.2
      }
    }
  };

  // 2. Animaci√≥ d'Impacte (Blur + Scale + Fade)
  const itemVariants: Variants = {
    hidden: { 
        opacity: 0, 
        y: 40, 
        scale: 0.5, 
        filter: "blur(10px)" 
    },
    show: { 
        opacity: 1, 
        y: 0, 
        scale: 1, 
        filter: "blur(0px)",
        transition: { 
            type: "spring", // Eliminat 'as const' innecessari si el tipus Variants √©s correcte
            bounce: 0.4, 
            duration: 0.8
        } 
    }
  };

  return (
    <section className="py-24 bg-card border-y border-border/50 relative overflow-hidden">
      
      {/* Pattern de fons molt subtil */}
      <div className="absolute inset-0 opacity-[0.03] dark:opacity-[0.05] pointer-events-none" 
           style={{ backgroundImage: 'radial-gradient(circle, currentColor 1px, transparent 1px)', backgroundSize: '32px 32px' }} 
      />

      {/* Gradient superior per suavitzar la vora */}
      <div className="absolute top-0 left-0 right-0 h-px bg-linear-to-r from-transparent via-primary/20 to-transparent" />

      <motion.div 
        variants={containerVariants}
        initial="hidden"
        whileInView="show"
        viewport={{ once: true, margin: "-100px" }}
        className="container mx-auto px-4 relative z-10"
      >
        <div className="grid grid-cols-2 md:grid-cols-4 gap-8 md:gap-12">
          {items.map((stat, i) => (
            <motion.div 
              key={i} 
              variants={itemVariants}
              whileHover={{ scale: 1.05 }} 
              className="relative group text-center flex flex-col items-center justify-center p-4 rounded-2xl transition-colors hover:bg-muted/50"
            >
              {/* Separador vertical elegant (desapareix en m√≤bil i a l'√∫ltim element) */}
              {i !== items.length - 1 && (
                <div className="hidden md:block absolute right-0 top-1/2 -translate-y-1/2 w-px h-12 bg-linear-to-b from-transparent via-border to-transparent translate-x-6 lg:translate-x-12 opacity-50" />
              )}
              
              {/* N√∫mero Gegant amb Gradient */}
              <div className="text-4xl md:text-5xl lg:text-6xl font-black mb-2 tracking-tight">
                <span className="bg-clip-text text-transparent bg-linear-to-br from-primary via-primary to-primary/60 drop-shadow-sm">
                    <AnimatedCounter value={stat.value} />
                </span>
              </div>
              
              {/* Etiqueta amb animaci√≥ de color */}
              <div className="text-xs md:text-sm font-bold text-muted-foreground uppercase tracking-widest group-hover:text-primary transition-colors duration-300">
                {stat.label}
              </div>
            </motion.div>
          ))}
        </div>
      </motion.div>
    </section>
  );
}

// =================== FILE: src/components/modules/marketing/testimonials-section.tsx ===================

'use client';

import { TestimonialsContent } from '@/types/models';
import { Star, Quote } from 'lucide-react';
import { motion, Variants } from 'framer-motion';
import { cn } from '@/lib/utils'; // Assumint que tens la utilitat de shadcn/ui

export function TestimonialsSection({ data }: { data: TestimonialsContent }) {
  
  // Variants per a l'orquestraci√≥ (Stagger)
  const containerVars: Variants = {
    hidden: { opacity: 0 },
    show: { 
      opacity: 1, 
      transition: { 
        staggerChildren: 0.2,
        delayChildren: 0.1
      } 
    }
  };

  // Variants per a cada targeta (Spring suau)
  const cardVars: Variants = {
    hidden: { opacity: 0, y: 50, scale: 0.95 },
    show: { 
      opacity: 1, 
      y: 0, 
      scale: 1, 
      transition: { type: "spring", stiffness: 100, damping: 15 } 
    }
  };

  return (
    <section className="relative py-24 overflow-hidden bg-background">
      
      {/* üé® ELEMENTS DECORATIUS DE FONS (Din√†mics segons Theme) */}
      <div className="absolute top-0 left-0 w-full h-full overflow-hidden -z-10 pointer-events-none">
          <div className="absolute top-[-10%] left-[-10%] w-[40%] h-[40%] bg-primary/5 rounded-full blur-3xl animate-pulse" />
          <div className="absolute bottom-[-10%] right-[-10%] w-[30%] h-[30%] bg-blue-500/5 rounded-full blur-3xl" />
      </div>

      <div className="container px-4 mx-auto">
        
        {/* HEADER DE SECCI√ì */}
        <div className="text-center max-w-3xl mx-auto mb-20 relative">
            <motion.div 
                initial={{ opacity: 0, scale: 0 }}
                whileInView={{ opacity: 1, scale: 1 }}
                viewport={{ once: true }}
                className="inline-flex items-center justify-center w-16 h-16 bg-primary/10 rounded-2xl mb-6 text-primary rotate-3"
            >
                <Quote className="w-8 h-8" />
            </motion.div>
            
            <motion.h2 
                initial={{ opacity: 0, y: 20 }}
                whileInView={{ opacity: 1, y: 0 }}
                viewport={{ once: true }}
                className="text-4xl md:text-6xl font-black mb-6 tracking-tight text-foreground"
            >
                {data.title}
            </motion.h2>
            
            <motion.p 
                initial={{ opacity: 0 }}
                whileInView={{ opacity: 1 }}
                transition={{ delay: 0.2 }}
                viewport={{ once: true }}
                className="text-xl text-muted-foreground leading-relaxed"
            >
                {data.subtitle}
            </motion.p>
        </div>
        
        {/* GRAELLA DE TESTIMONIS */}
        <motion.div 
            variants={containerVars}
            initial="hidden"
            whileInView="show"
            viewport={{ once: true, margin: "-50px" }}
            className="grid md:grid-cols-3 gap-6 lg:gap-8"
        >
            {data.reviews.map((review, i) => (
                <motion.div 
                    key={i} 
                    variants={cardVars}
                    whileHover={{ y: -10, transition: { duration: 0.2 } }}
                    className={cn(
                        "group relative p-8 h-full flex flex-col justify-between",
                        "bg-card/50 backdrop-blur-sm border border-border/50", // Glassmorphism
                        "rounded-4xl hover:border-primary/30 hover:shadow-2xl hover:shadow-primary/5", // Hover effects
                        "transition-all duration-300 ease-out"
                    )}
                >
                    {/* Icona de cometes decorativa gran al fons */}
                    <Quote className="absolute top-8 right-8 w-12 h-12 text-primary/5 group-hover:text-primary/10 transition-colors" />

                    <div>
                        {/* ESTRELLES */}
                        <div className="flex gap-1 mb-6">
                            {[...Array(5)].map((_, starI) => (
                                <Star 
                                    key={starI} 
                                    className={cn(
                                        "w-4 h-4 transition-all duration-300",
                                        starI < review.rating 
                                            ? "fill-amber-400 text-amber-400 drop-shadow-sm" 
                                            : "text-muted/30 fill-muted/10"
                                    )} 
                                />
                            ))}
                        </div>
                        
                        {/* TEXT DEL REVIEW */}
                        <p className="mb-8 text-lg font-medium text-foreground/90 leading-relaxed relative z-10">
                            "{review.text}"
                        </p>
                    </div>
                    
                    {/* FOOTER: AUTOR */}
                    <div className="flex items-center gap-4 pt-6 border-t border-border/40">
                        <div className={cn(
                            "w-12 h-12 rounded-full flex items-center justify-center font-bold text-lg shadow-md ring-2 ring-background",
                            "bg-linear-to-br from-primary to-primary/60 text-primary-foreground" // √ös correcte de gradient
                        )}>
                            {/* Si tingu√©ssim avatar_url a la interf√≠cie, aqu√≠ posar√≠em la imatge */}
                            {review.author[0]}
                        </div>
                        <div>
                            <h4 className="font-bold text-base text-foreground group-hover:text-primary transition-colors">
                                {review.author}
                            </h4>
                            <p className="text-sm text-muted-foreground font-medium">
                                {review.role}
                            </p>
                        </div>
                    </div>
                </motion.div>
            ))}
        </motion.div>
      </div>
    </section>
  );
}

// =================== FILE: src/components/providers/theme-injector.tsx ===================

'use client';

import { CONFIG } from '@/config/digitai.config';
import { generateThemeVariables } from '@/lib/theme-utils';

export function ThemeInjector() {
  const { colors, radius } = CONFIG.branding;

  // C√†lculs es fan al render inicial (molt r√†pid)
  const { lightVars, darkVars, paletteVars } = generateThemeVariables(colors.primary);

  // Convertim objectes JS a string CSS
  const cssString = (vars: Record<string, string>) => 
    Object.entries(vars).map(([key, value]) => `${key}: ${value};`).join(' ');

  // Constru√Øm el CSS final
  const styles = `
    :root {
      ${cssString(lightVars)}
      ${cssString(paletteVars)}
      --radius: ${radius}rem;
    }

    .dark {
      ${cssString(darkVars)}
    }
  `;

  return (
    <style dangerouslySetInnerHTML={{ __html: styles }} />
  );
}

// =================== FILE: src/components/providers/theme-provider.tsx ===================

// src/components/providers/theme-provider.tsx
"use client"

import * as React from "react"
import { ThemeProvider as NextThemesProvider } from "next-themes"

export function ThemeProvider({
  children,
  ...props
}: React.ComponentProps<typeof NextThemesProvider>) {
  return <NextThemesProvider {...props}>{children}</NextThemesProvider>
}

// =================== FILE: src/components/ui/button.tsx ===================

import * as React from "react"
import { Slot } from "@radix-ui/react-slot"
import { cva, type VariantProps } from "class-variance-authority"
import { Loader2 } from "lucide-react"
import { cn } from "@/lib/utils"

const buttonVariants = cva(
  "inline-flex items-center justify-center whitespace-nowrap rounded-lg text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 active:scale-95",
  {
    variants: {
      variant: {
        default:
          "bg-primary text-primary-foreground shadow hover:bg-primary/90",
        destructive:
          "bg-destructive text-destructive-foreground shadow-sm hover:bg-destructive/90",
        outline:
          "border border-input bg-background shadow-sm hover:bg-accent hover:text-accent-foreground",
        secondary:
          "bg-secondary text-secondary-foreground shadow-sm hover:bg-secondary/80",
        ghost: "hover:bg-accent hover:text-accent-foreground",
        link: "text-primary underline-offset-4 hover:underline",
      },
      size: {
        default: "h-10 px-4 py-2",
        sm: "h-9 rounded-md px-3",
        lg: "h-12 rounded-md px-8 text-base",
        icon: "h-10 w-10",
      },
    },
    defaultVariants: {
      variant: "default",
      size: "default",
    },
  }
)

export interface ButtonProps
  extends React.ButtonHTMLAttributes<HTMLButtonElement>,
    VariantProps<typeof buttonVariants> {
  asChild?: boolean
  isLoading?: boolean
}

const Button = React.forwardRef<HTMLButtonElement, ButtonProps>(
  ({ className, variant, size, asChild = false, isLoading = false, children, disabled, ...props }, ref) => {
    const Comp = asChild ? Slot : "button"
    
    return (
      <Comp
        className={cn(buttonVariants({ variant, size, className }))}
        ref={ref}
        disabled={disabled || isLoading}
        {...props}
      >
        {isLoading ? (
          <>
            <Loader2 className="mr-2 h-4 w-4 animate-spin" />
            {children}
          </>
        ) : (
          children
        )}
      </Comp>
    )
  }
)
Button.displayName = "Button"

export { Button, buttonVariants }

// =================== FILE: src/components/ui/lang-switcher.tsx ===================

'use client';

import { useState, useRef, useEffect } from 'react';
import { usePathname, useRouter } from 'next/navigation';
import { motion, AnimatePresence } from 'framer-motion';
import { Check, ChevronDown } from 'lucide-react';
import { cn } from '@/lib/utils';
// üëá Importem les noves banderes
import { FlagCA, FlagES, FlagGB } from '@/components/icons/flags';

const LANGUAGES = [
  { code: 'ca', label: 'Catal√†', Flag: FlagCA },
  { code: 'es', label: 'Espa√±ol', Flag: FlagES },
  { code: 'en', label: 'English', Flag: FlagGB },
];

export function LanguageSwitcher() {
  const [isOpen, setIsOpen] = useState(false);
  const containerRef = useRef<HTMLDivElement>(null);
  
  const pathname = usePathname();
  const router = useRouter();

  const currentLocale = pathname.split('/')[1] || 'ca';
  const currentLang = LANGUAGES.find(l => l.code === currentLocale) || LANGUAGES[0];

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      if (containerRef.current && !containerRef.current.contains(event.target as Node)) {
        setIsOpen(false);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, []);

  const handleLanguageChange = (newCode: string) => {
    if (newCode === currentLocale) {
        setIsOpen(false);
        return;
    }
    const segments = pathname.split('/');
    segments[1] = newCode;
    const newPath = segments.join('/');
    router.push(newPath);
    setIsOpen(false);
  };

  return (
    <div className="relative" ref={containerRef}>
      {/* BOT√ì TRIGGER */}
      <button
        onClick={() => setIsOpen(!isOpen)}
        className="flex items-center gap-2 px-2 py-1.5 rounded-full hover:bg-secondary/50 transition-colors text-sm font-medium border border-transparent"
      >
        {/* Renderitzem el component SVG */}
        <currentLang.Flag className="w-5 h-auto rounded-[2px] shadow-sm object-cover" />
        
        <span className="hidden lg:inline uppercase text-[10px] font-bold tracking-wide opacity-70">
          {currentLang.code}
        </span>
        <ChevronDown className={cn("w-3 h-3 text-muted-foreground transition-transform duration-300", isOpen && "rotate-180")} />
      </button>

      {/* DROPDOWN MENU */}
      <AnimatePresence>
        {isOpen && (
          <motion.div
            initial={{ opacity: 0, y: 8, scale: 0.96 }}
            animate={{ opacity: 1, y: 0, scale: 1 }}
            exit={{ opacity: 0, y: 8, scale: 0.96 }}
            transition={{ duration: 0.2, ease: "easeOut" }}
            className="absolute right-0 mt-2 w-40 bg-background/95 backdrop-blur-xl border border-border rounded-xl shadow-xl z-50 overflow-hidden ring-1 ring-black/5"
          >
            <div className="p-1 flex flex-col gap-0.5">
              {LANGUAGES.map((lang) => {
                const isSelected = currentLocale === lang.code;
                return (
                  <button
                    key={lang.code}
                    onClick={() => handleLanguageChange(lang.code)}
                    className={cn(
                      "w-full flex items-center justify-between px-3 py-2 rounded-lg text-sm transition-all",
                      isSelected 
                        ? "bg-primary/10 text-primary font-bold" 
                        : "hover:bg-secondary/80 text-foreground"
                    )}
                  >
                    <div className="flex items-center gap-3">
                        {/* SVG al men√∫ desplegable tamb√© */}
                        <lang.Flag className="w-5 h-auto rounded-[2px] shadow-sm" />
                        <span>{lang.label}</span>
                    </div>
                    {isSelected && <Check className="w-3.5 h-3.5 stroke-3" />}
                  </button>
                );
              })}
            </div>
          </motion.div>
        )}
      </AnimatePresence>
    </div>
  );
}

// =================== FILE: src/components/ui/theme-toggle.tsx ===================

"use client"

import * as React from "react"
import { Moon, Sun } from "lucide-react"
import { useTheme } from "next-themes"
import { Button } from "@/components/ui/button"

export function ThemeToggle() {
  const { setTheme, resolvedTheme } = useTheme()
  const [mounted, setMounted] = React.useState(false)

  // 1. Evitem errors d'hidrataci√≥ (el servidor no sap el tema de l'usuari)
  React.useEffect(() => {
    setMounted(true)
  }, [])

  if (!mounted) {
    // Retornem un espai buit de la mateixa mida per evitar salts visuals
    return <div className="w-9 h-9" />
  }

  // 2. Determinem si √©s fosc basant-nos en el tema RESOLT (inclou 'system')
  const isDark = resolvedTheme === 'dark'

  return (
    <Button
      variant="ghost"
      size="icon"
      onClick={() => setTheme(isDark ? "light" : "dark")}
      className="rounded-full relative w-9 h-9 border border-transparent hover:bg-muted/50"
      aria-label={isDark ? "Activar mode clar" : "Activar mode fosc"}
    >
      {/* ‚òÄÔ∏è SOL: Es mostra quan NO √©s fosc */}
      <Sun 
        className={`h-5 w-5 transition-all duration-300 absolute ${
          isDark 
            ? 'scale-0 rotate-90 opacity-0' // Si √©s fosc: Amaga't
            : 'scale-100 rotate-0 opacity-100' // Si √©s clar: Mostra't
        }`} 
      />
      
      {/* üåô LLUNA: Es mostra quan √âS fosc */}
      <Moon 
        className={`h-5 w-5 transition-all duration-300 absolute ${
          isDark 
            ? 'scale-100 rotate-0 opacity-100' // Si √©s fosc: Mostra't
            : 'scale-0 -rotate-90 opacity-0'   // Si √©s clar: Amaga't
        }`} 
      />
    </Button>
  )
}

// =================== FILE: src/config/digitai.config.ts ===================

// PROJECTE: Master Template
// FITXER: src/config/digitai.config.ts

// 1. Importem els tipus que hem definit al pas 1
import { MasterConfig, ConfigLandingSection } from "@/types/config";

export const CONFIG: MasterConfig = {
  identity: {
    name: "Master Template Project",
    description: "Lloc web generat amb tecnologia DigitAI.",
    // üëá Assegura't que la ruta √©s correcta
    logoUrl: "/branding/logo.png",
    faviconUrl: "/favicon.ico",
    contactEmail: "demo@digitai.com",
    address: "Carrer de la Ind√∫stria, 123, Barcelona",
  },
  
  branding: {
    colors: {
      primary: "#6366f1",   // Indigo Modern
      secondary: "#10b981", // Emerald
      background: "#ffffff",
      foreground: "#0f172a",
    },
    radius: 0.75,
  },

  // üÜï CONTINGUT EST√ÄTIC (Opcional, si no vols dependre nom√©s de traduccions)
  content: {
    about: {
      image_url: "https://images.unsplash.com/photo-1522071820081-009f0129c71c?auto=format&fit=crop&w=800&q=80",
      stats: [
        { label: "Anys", value: "10+" },
        { label: "Clients", value: "500+" }
      ]
    }
  },

  footer: {
    columns: [
      {
        title: "Producte",
        links: [
          { label: "Serveis", href: "/services" },
          { label: "Preus", href: "/#pricing" },
        ]
      },
      {
        title: "Empresa",
        links: [
          { label: "Sobre Nosaltres", href: "/about" },
          { label: "Contacte", href: "/#contact" }
        ]
      }
    ],
    socials: {
      twitter: "https://twitter.com/digitai",
      instagram: "https://instagram.com/digitai"
    },
    bottomText: "¬© 2025 DigitAI Studios."
  },

  modules: {
    layout: {
      variant: 'modern',
      stickyHeader: true,
    },
    landing: {
      active: true,
      
      // ‚úÖ SOLUCI√ì DE L'ERROR: Fem un cast expl√≠cit al tipus correcte
      sections: [
        'hero', 
        'stats', 
        'about',             // <--- Nou About
        'services', 
        'featured_products', // <--- Nous Productes
        'cta_banner', 
        'testimonials', 
        'contact', 
        'faq'
      ] as ConfigLandingSection[] 
    },
    auth: {
      active: true,
      allowPublicRegistration: true, 
      redirects: {
        admin: '/dashboard',
        client: '/my-account', 
      }
    },
    dashboard: true,
    booking: true,
    ecommerce: true,
    blog: true,
    inventory: true,
    accessControl: true,
    chatbot: true
  },
  i18n: {
    locales: ['ca', 'es', 'en'],
    defaultLocale: 'ca'
  }
};

// =================== FILE: src/features/auth/actions.ts ===================

'use server';

import { authService } from '@/services/container';
import { redirect } from 'next/navigation';
import { getLocale } from 'next-intl/server';
// Assegura't que aquest servei existeix o comenta la l√≠nia si encara no el tens
import { EmailService } from '@/lib/email/email-service';

export type AuthState = {
  error?: string;
  message?: string;
};

function getOrgId() {
  const orgId = process.env.NEXT_PUBLIC_ORG_ID;
  if (!orgId) throw new Error("ERROR CR√çTIC: Manca NEXT_PUBLIC_ORG_ID");
  return orgId;
}

export async function loginAction(
  prevState: AuthState | null,
  formData: FormData
): Promise<AuthState> {
  const email = formData.get('email') as string;
  const password = formData.get('password') as string;
  const locale = await getLocale();

  try {
    const orgId = getOrgId();
    const user = await authService.login(email, password, orgId);
    const destination = await authService.getRedirectPath(user.id, orgId);
    
    redirect(`/${locale}${destination}`);

  } catch (error: unknown) {
    if ((error as Error).message === 'NEXT_REDIRECT') throw error;

    console.error("Login Error:", error);
    let errorKey = 'generic';
    const msg = (error as Error).message;

    if (msg.includes('Invalid login credentials') || msg === 'Credencials inv√†lides') {
      errorKey = 'invalid_credentials';
    } else if (msg === 'NO_PROFILE') {
      errorKey = 'no_access';
    }

    return { error: errorKey };
  }
}

export async function registerAction(
  prevState: AuthState | null,
  formData: FormData
): Promise<AuthState> {
  const email = formData.get('email') as string;
  const password = formData.get('password') as string;
  const fullName = formData.get('fullName') as string;
  const locale = await getLocale();

  try {
    const orgId = getOrgId();
    await authService.register({
      email,
      password,
      fullName,
      orgId
    });
    
    // Intentem enviar mail, per√≤ no bloquegem si falla
    try {
        await EmailService.sendWelcomeEmail(email, fullName);
    } catch (e) {
        console.warn("No s'ha pogut enviar el mail de benvinguda:", e);
    }

    redirect(`/${locale}/auth/login?message=registered`);

  } catch (error: unknown) {
    if ((error as Error).message === 'NEXT_REDIRECT') throw error;

    console.error("Register Error:", error);
    let errorKey = 'generic';
    const msg = (error as Error).message;

    if (msg === 'ACCOUNT_EXISTS_WRONG_PASS' || msg.includes('already registered')) {
      errorKey = 'account_exists';
    }

    return { error: errorKey };
  }
}

export async function signOutAction() {
  const locale = await getLocale();
  try {
    await authService.logout();
  } catch (e) {
    console.error("Error al fer logout", e);
  }
  redirect(`/${locale}/auth/login`);
}

// =================== FILE: src/features/auth/__tests__/actions.test.ts ===================

import { describe, it, expect, vi, beforeEach } from 'vitest';
import { loginAction, registerAction } from '../actions';
import { authService } from '@/services/container';
import { redirect } from 'next/navigation';
// Importem tipus reals (o els simulem si no els tenim a l'scope actual)
import type { User } from '@supabase/supabase-js'; 

vi.mock('@/services/container', () => ({
  authService: {
    login: vi.fn(),
    getRedirectPath: vi.fn(),
    register: vi.fn(),
    logout: vi.fn(),
  },
}));

vi.mock('next/navigation', () => ({
  redirect: vi.fn(),
}));

vi.mock('next-intl/server', () => ({
  getLocale: vi.fn(() => Promise.resolve('ca')),
}));

vi.mock('@/lib/email/email-service', () => ({
  EmailService: {
    sendWelcomeEmail: vi.fn(),
  },
}));

describe('Auth Actions', () => {
  const mockFormData = new FormData();
  mockFormData.append('email', 'test@test.com');
  mockFormData.append('password', '123456');

  beforeEach(() => {
    vi.clearAllMocks();
    process.env.NEXT_PUBLIC_ORG_ID = 'org_123';
  });

  describe('loginAction', () => {
    it('hauria de redirigir si el login √©s correcte', async () => {
      // ‚úÖ CORRECTE: Fem servir 'as unknown as User' per simular l'objecte de retorn
      const mockUser = { id: 'user_1', email: 'test@test.com' };
      vi.mocked(authService.login).mockResolvedValue(mockUser as unknown as User);
      vi.mocked(authService.getRedirectPath).mockResolvedValue('/dashboard');

      try {
        await loginAction(null, mockFormData);
      } catch (e) {
        console.log(e)
        // Ignorem l'error intern de redirect
      }

      expect(authService.login).toHaveBeenCalledWith('test@test.com', '123456', 'org_123');
      expect(redirect).toHaveBeenCalledWith('/ca/dashboard');
    });

    it('hauria de retornar error si credencials s√≥n inv√†lides', async () => {
      vi.mocked(authService.login).mockRejectedValue(new Error('Invalid login credentials'));

      const result = await loginAction(null, mockFormData);

      expect(result).toEqual({ error: 'invalid_credentials' });
      expect(redirect).not.toHaveBeenCalled();
    });
  });

  describe('registerAction', () => {
    it('hauria de registrar i redirigir', async () => {
      mockFormData.append('fullName', 'Test User');
      // ‚úÖ CORRECTE: Retornem void o l'objecte esperat sense any
      vi.mocked(authService.register).mockResolvedValue(undefined);

      await registerAction(null, mockFormData);

      expect(authService.register).toHaveBeenCalled();
      expect(redirect).toHaveBeenCalledWith('/ca/auth/login?message=registered');
    });
  });
});

// =================== FILE: src/features/blog/actions.ts ===================

'use server';

import { redirect } from 'next/navigation';
import { getLocale } from 'next-intl/server';
import { revalidatePath } from 'next/cache';
import { postService } from '@/services/container';

function getOrgId() {
    const orgId = process.env.NEXT_PUBLIC_ORG_ID;
    if (!orgId) throw new Error("Missing ORG_ID");
    return orgId;
}

export async function getPostsAction() {
    try {
        return await postService.getDashboardPosts(getOrgId());
    } catch (e) {
        console.error("Error fetching posts:", e);
        return [];
    }
}

export async function getPublicPostsAction() {
    try {
        return await postService.getPublicPosts(getOrgId());
    } catch (e) {
        console.error("Error fetching public posts:", e);
        return [];
    }
}

export async function createPostAction(prevState: unknown, formData: FormData) {
    const locale = await getLocale();
    const orgId = getOrgId();

    const title = formData.get('title') as string;
    const description = formData.get('description') as string;
    const content = formData.get('content') as string;

    if (!title || !content) {
        return { error: "El t√≠tol i el contingut s√≥n obligatoris." };
    }

    try {
        await postService.createNewPost({
            title,
            description,
            content,
            status: 'published'
        }, orgId);

    } catch (error) {
        console.error("Create Post Error:", error);
        return { error: "Hi ha hagut un error guardant l'article." };
    }

    revalidatePath('/blog-manager');
    redirect(`/${locale}/blog-manager`);
}

export async function deletePostAction(formData: FormData) {
    const id = formData.get('id') as string;
    if (!id) return;

    try {
        await postService.deletePost(id);
        revalidatePath('/blog-manager');
    } catch (error) {
        console.error("Delete Post Error:", error);
    }
}

// =================== FILE: src/features/blog/__tests__/actions.test.ts ===================

import { describe, it, expect, vi, beforeEach } from 'vitest';
import { createPostAction, getPostsAction } from '../actions';
import { postService } from '@/services/container';
import { redirect } from 'next/navigation';
import { revalidatePath } from 'next/cache';
import type { BlogPost as Post} from '@/types/models'; // Assumim que existeix

vi.mock('@/services/container', () => ({
  postService: {
    getDashboardPosts: vi.fn(),
    createNewPost: vi.fn(),
    deletePost: vi.fn(),
  },
}));

vi.mock('next/navigation', () => ({
  redirect: vi.fn(),
}));

vi.mock('next/cache', () => ({
  revalidatePath: vi.fn(),
}));

vi.mock('next-intl/server', () => ({
  getLocale: vi.fn(() => Promise.resolve('en')),
}));

describe('Blog Actions', () => {
  beforeEach(() => {
    vi.clearAllMocks();
    process.env.NEXT_PUBLIC_ORG_ID = 'org_123';
  });

  it('getPostsAction hauria de retornar posts', async () => {
    // ‚úÖ CORRECTE: Tipatge segur
    const mockPosts = [{ id: '1', title: 'Post 1' }];
    vi.mocked(postService.getDashboardPosts).mockResolvedValue(mockPosts as unknown as Post[]);

    const result = await getPostsAction();
    expect(result).toEqual(mockPosts);
    expect(postService.getDashboardPosts).toHaveBeenCalledWith('org_123');
  });

  it('createPostAction hauria de crear, revalidar i redirigir', async () => {
    const formData = new FormData();
    formData.append('title', 'New Post');
    formData.append('content', 'Content');
    formData.append('description', 'Desc');

    try {
        await createPostAction(null, formData);
    } catch(e) {console.log(e)}

    expect(postService.createNewPost).toHaveBeenCalledWith(
      expect.objectContaining({ title: 'New Post' }),
      'org_123'
    );
    expect(revalidatePath).toHaveBeenCalledWith('/blog-manager');
    expect(redirect).toHaveBeenCalledWith('/en/blog-manager');
  });
});

// =================== FILE: src/features/booking/actions.ts ===================

'use server';

import { redirect } from 'next/navigation';
import { getLocale } from 'next-intl/server';
import { revalidatePath } from 'next/cache';
import { bookingService } from '@/services/container';
import { Service, Booking } from '@/types/models';

// --- DEFINICI√ì DE TIPUS (ZERO ANY) ---

export type BookingActionState = {
  success: boolean;
  message?: string;
  error?: string;
  slots?: string[];
};

// --- HELPERS ---

function getOrgId(): string {
  const orgId = process.env.NEXT_PUBLIC_ORG_ID;
  if (!orgId) throw new Error("Missing NEXT_PUBLIC_ORG_ID");
  return orgId;
}

// --- GETTERS (Lectura) ---

export async function getServices(): Promise<Service[]> {
  try {
    return await bookingService.getAllServices(getOrgId());
  } catch (error) {
    console.error("Error fetching services:", error);
    return [];
  }
}

export async function getDashboardBookings(): Promise<Booking[]> {
  try {
    return await bookingService.getDashboardBookings(getOrgId());
  } catch (error) {
    console.error("Error fetching dashboard bookings:", error);
    return [];
  }
}

export async function getAvailableSlotsAction(date: string, serviceId: string): Promise<BookingActionState> {
  try {
    const slots = await bookingService.getAvailableSlots(date, serviceId, getOrgId());
    return { success: true, slots };
  } catch (error) {
    console.error("Slots Error:", error);
    return { success: false, slots: [], error: 'Error calculant disponibilitat' };
  }
}

// --- MUTATIONS (Escriptura) ---

/**
 * Crear Reserva (P√∫blica o Admin)
 * Tipus estricte: 'prevState' √©s unknown perqu√® ve del hook per√≤ no l'utilitzem per a l√≤gica.
 */
export async function createBookingAction(prevState: unknown, formData: FormData): Promise<BookingActionState> {
  const orgId = getOrgId();
  
  // 1. Dades est√†ndard (Casting segur)
  const serviceId = formData.get('serviceId') as string;
  const name = formData.get('name') as string;
  const email = formData.get('email') as string;
  const dateStr = formData.get('date') as string;
  const timeStr = formData.get('time') as string;

  // 2. Dades din√†miques (Camps personalitzats)
  const customData: Record<string, unknown> = {};
  for (const [key, value] of formData.entries()) {
    if (key.startsWith('custom_')) {
      const fieldName = key.replace('custom_', '');
      customData[fieldName] = value;
    }
  }

  // 3. Validaci√≥ b√†sica
  if (!serviceId || !name || !email || !dateStr || !timeStr) {
    return { success: false, message: "Tots els camps obligatoris s√≥n necessaris." };
  }

  try {
    await bookingService.processBooking({
      serviceId,
      name,
      email,
      date: dateStr,
      time: timeStr,
      formData: customData
    }, orgId);

    revalidatePath('/dashboard/booking');
    return { success: true, message: 'Reserva confirmada correctament!' };

  } catch (error) {
    console.error("Booking error:", error);
    let message = 'Error creant la reserva.';
    if (error instanceof Error) message = error.message;
    return { success: false, message };
  }
}

/**
 * Crear Nou Servei (Admin)
 */
export async function createServiceAction(prevState: unknown, formData: FormData): Promise<BookingActionState> {
  try {
    const title = formData.get('title') as string;
    const description = formData.get('description') as string;
    const priceRaw = formData.get('price');
    const durationRaw = formData.get('duration');
    const formSchemaJson = formData.get('form_schema') as string;

    // Conversi√≥ segura de tipus num√®rics
    const price = priceRaw ? parseFloat(priceRaw.toString()) : 0;
    const duration = durationRaw ? parseInt(durationRaw.toString()) : 30;

    let formSchema = [];
    if (formSchemaJson) {
      try {
        formSchema = JSON.parse(formSchemaJson);
      } catch (e) {
        console.error("Error parsing form schema:", e);
        throw new Error("Format dels camps personalitzats inv√†lid.");
      }
    }

    await bookingService.createNewService({
      title,
      description,
      price,
      duration,
      form_schema: formSchema
    }, getOrgId());

    revalidatePath('/services');
    return { success: true, message: 'Servei creat correctament' };

  } catch (error) {
    console.error("Create Service Error:", error);
    let errorMessage = "Error desconegut creant el servei";
    if (error instanceof Error) errorMessage = error.message;
    return { success: false, message: errorMessage };
  }
}

/**
 * Esborrar Servei (Admin)
 */
export async function deleteServiceAction(formData: FormData): Promise<void> {
  const serviceId = formData.get('id') as string;
  const locale = await getLocale();
  
  if (!serviceId) return;

  try {
    // Aqu√≠ idealment cridar√≠em a bookingService.deleteService(serviceId)
    // Com que no ho tenim implementat al service encara, fem un log
    console.log(`[PENDING] Delete service ${serviceId}`);
    
    // Simulem revalidaci√≥
    revalidatePath('/services');
    redirect(`/${locale}/services`);
  } catch (error) {
     console.error("Delete error", error);
  }
}

// =================== FILE: src/features/booking/__tests__/actions.test.ts ===================

import { describe, it, expect, vi, beforeEach } from 'vitest';
import * as actions from '../actions';
import { bookingService } from '@/services/container';
import { Service, Booking, FormField } from '@/types/models'; // üëà Afegeix FormField aqu√≠

// 1. Mock de Next.js i llibreries externes
vi.mock('next/navigation', () => ({
  redirect: vi.fn(),
}));

vi.mock('next/cache', () => ({
  revalidatePath: vi.fn(),
}));

vi.mock('next-intl/server', () => ({
  getLocale: vi.fn().mockResolvedValue('ca'),
}));

// 2. Mock del Container de Serveis (bookingService)
vi.mock('@/services/container', () => ({
  bookingService: {
    getAllServices: vi.fn(),
    getDashboardBookings: vi.fn(),
    processBooking: vi.fn(),
    createNewService: vi.fn(),
    getAvailableSlots: vi.fn(),
  },
}));

describe('Booking Server Actions', () => {
  const mockOrgId = 'test-org-123';

  beforeEach(() => {
    vi.clearAllMocks();
    // Configurem l'entorn perqu√® getOrgId() funcioni
    process.env.NEXT_PUBLIC_ORG_ID = mockOrgId;
  });

  // --- TEST GETTERS ---
  describe('getServices', () => {
    it('hauria de retornar els serveis de l\'organitzaci√≥', async () => {
      // üõ°Ô∏è FIX: Constru√Øm un objecte Service complet per evitar 'as any'
      const mockServices: Service[] = [{ 
        id: '1', 
        title: 'Tallada',
        organization_id: mockOrgId,
        description: 'Descripci√≥ test',
        price: 20,
        duration_minutes: 30,
        active: true,
        form_schema: [],
        created_at: new Date()
      }];
      
      vi.mocked(bookingService.getAllServices).mockResolvedValue(mockServices);

      const result = await actions.getServices();

      expect(bookingService.getAllServices).toHaveBeenCalledWith(mockOrgId);
      expect(result).toEqual(mockServices);
    });

    it('hauria de gestionar errors retornant array buit', async () => {
      vi.mocked(bookingService.getAllServices).mockRejectedValue(new Error('DB Error'));
      const result = await actions.getServices();
      expect(result).toEqual([]);
    });
  });

  // --- TEST MUTATIONS: CREATE BOOKING ---
  describe('createBookingAction', () => {
    it('hauria de retornar error si falten camps obligatoris', async () => {
      const formData = new FormData();
      // Nom√©s posem serviceId, falten la resta
      formData.append('serviceId', 's1');

      const result = await actions.createBookingAction({}, formData);

      expect(result.success).toBe(false);
      expect(result.message).toContain('camps obligatoris');
      expect(bookingService.processBooking).not.toHaveBeenCalled();
    });

    it('hauria de processar la reserva correctament i revalidar', async () => {
      const formData = new FormData();
      formData.append('serviceId', 's1');
      formData.append('name', 'Joan');
      formData.append('email', 'joan@test.com');
      formData.append('date', '2023-10-10');
      formData.append('time', '10:00');
      // Camps custom
      formData.append('custom_notes', 'Al¬∑l√®rgia al l√†tex');

      // üõ°Ô∏è FIX: Constru√Øm un objecte Booking v√†lid
      const mockBooking: Booking = {
        id: 'b1',
        organization_id: mockOrgId,
        service_id: 's1',
        customer_name: 'Joan',
        customer_email: 'joan@test.com',
        start_time: new Date('2023-10-10T10:00:00'),
        end_time: new Date('2023-10-10T11:00:00'),
        status: 'confirmed',
        user_id: null,
        form_data: { notes: 'Al¬∑l√®rgia al l√†tex' },
        created_at: new Date()
      };

      vi.mocked(bookingService.processBooking).mockResolvedValue(mockBooking);

      const result = await actions.createBookingAction({}, formData);

      // Verifiquem que es crida al servei amb les dades netes i el customData extret
      expect(bookingService.processBooking).toHaveBeenCalledWith(
        expect.objectContaining({
          serviceId: 's1',
          name: 'Joan',
          formData: { notes: 'Al¬∑l√®rgia al l√†tex' } // 'custom_' eliminat
        }),
        mockOrgId
      );

      expect(result.success).toBe(true);
    });

    it('hauria de gestionar errors del servei', async () => {
      const formData = new FormData();
      formData.append('serviceId', 's1');
      formData.append('name', 'Joan');
      formData.append('email', 'joan@test.com');
      formData.append('date', '2023-10-10');
      formData.append('time', '10:00');

      vi.mocked(bookingService.processBooking).mockRejectedValue(new Error('Servei complet'));

      const result = await actions.createBookingAction({}, formData);

      expect(result.success).toBe(false);
      expect(result.message).toBe('Servei complet');
    });
  });

// --- TEST MUTATIONS: CREATE SERVICE (ADMIN) ---
  describe('createServiceAction', () => {
    
    // üõ°Ô∏è TIPATGE ESTRICTE: Definim l'schema com a FormField[]
    // Aix√≤ valida 'key', 'required' i que 'type' sigui un dels valors permesos
    const validSchema: FormField[] = [{ 
      key: 'notes',
      label: 'Notes', 
      type: 'text', 
      required: false
    }];

    it('hauria de crear un servei amb schema JSON v√†lid', async () => {
      const formData = new FormData();
      formData.append('title', 'Nou Servei');
      formData.append('price', '50');
      formData.append('duration', '60');
      formData.append('form_schema', JSON.stringify(validSchema));

      // üõ°Ô∏è FIX: Mock complet sense 'any'
      // Com que validSchema √©s estricte (FormField[]), TypeScript l'accepta perfectament
      const mockService: Service = {
        id: 'new-1',
        title: 'Nou Servei',
        organization_id: mockOrgId,
        price: 50,
        duration_minutes: 60,
        form_schema: validSchema, 
        description: null,
        active: true,
        created_at: new Date()
      };
      
      vi.mocked(bookingService.createNewService).mockResolvedValue(mockService);

      await actions.createServiceAction({}, formData);

      expect(bookingService.createNewService).toHaveBeenCalledWith(
        expect.objectContaining({
          title: 'Nou Servei',
          price: 50,
          form_schema: validSchema
        }),
        mockOrgId
      );
    });

    it('hauria de fallar si el JSON del schema √©s inv√†lid', async () => {
      const formData = new FormData();
      formData.append('title', 'Nou Servei');
      formData.append('form_schema', '{ json trencat ...');

      const result = await actions.createServiceAction({}, formData);
      
      expect(result.success).toBe(false);
      expect(result.message).toContain('inv√†lid');
      expect(bookingService.createNewService).not.toHaveBeenCalled();
    });
  });
});

// =================== FILE: src/features/contact/actions.ts ===================

'use server';

export type FormState = {
  success: boolean;
  message: string;
};

export async function submitContactForm(prevState: FormState, formData: FormData): Promise<FormState> {
  // Simulem retard
  await new Promise((resolve) => setTimeout(resolve, 1000));

  const name = formData.get('name') as string;
  const email = formData.get('email') as string;
  const message = formData.get('message') as string;
  const terms = formData.get('terms'); // üëà Recuperem el checkbox

  // --- VALIDACIONS ---
  
  // 1. Validaci√≥ de Termes (CR√çTICA)
  if (!terms) {
    return { success: false, message: "Has d'acceptar la pol√≠tica de privacitat per continuar." };
  }

  // 2. Altres validacions
  if (!name || name.length < 2) return { success: false, message: "El nom √©s massa curt." };
  if (!email || !email.includes('@')) return { success: false, message: "L'email no √©s v√†lid." };
  if (!message || message.length < 10) return { success: false, message: "El missatge √©s massa curt." };

  // 3. Enviament (simulat)
  console.log(`üìß Contacte v√†lid: ${name} - Terms: ${terms}`);

  return { 
    success: true, 
    message: "Missatge enviat correctament! Et respondrem aviat." 
  };
}

// =================== FILE: src/features/ecommerce/actions.ts ===================

'use server';

import { ecommerceService } from '@/services/container';
import { CreateOrderDTO } from '@/types/models';
import { revalidatePath } from 'next/cache';
import { requireAdmin } from '@/lib/auth/guards'; // üëà Importar
// 1. Definim el tipus d'estat de forma expl√≠cita
export type ActionState = {
  success: boolean;
  message: string;
  error?: string; // Opcional
};
function getOrgId() {
  const orgId = process.env.NEXT_PUBLIC_ORG_ID;
  if (!orgId) throw new Error("Missing ORG_ID");
  return orgId;
}

// 1. Obtenir Productes (Per a la p√†gina /shop)
export async function getProductsAction() {
  try {
    return await ecommerceService.getStoreProducts(getOrgId());
  } catch (error) {
    console.error("Error fetching products:", error);
    return [];
  }
}

// 2. Processar Pagament (Checkout)
export async function checkoutAction(orderData: CreateOrderDTO) {
  try {
    const orgId = getOrgId();
    // Cridem al servei que ja t√© l'estrat√®gia de pagament
    const result = await ecommerceService.processCheckout(orderData, orgId);

    // Si tot va b√©, retornem la URL on redirigir (Stripe, PayPal, o Success page)
    return { success: true, redirectUrl: result.redirectUrl };

  } catch (error) {
    console.error("Checkout Error:", error);
    return { success: false, error: "Error processant la comanda." };
  }
}
// 2. Corregim la signatura de la funci√≥ createProductAction
export async function createProductAction(
  prevState: ActionState, // Tipus correcte pel 1r argument
  formData: FormData
): Promise<ActionState> { // Retorn expl√≠cit
  // üõ°Ô∏è SECURITY CHECK: Aix√≤ atura l'execuci√≥ si no √©s admin
  await requireAdmin();
  const orgId = getOrgId();

  const name = formData.get('name') as string;
  const description = formData.get('description') as string;
  const price = parseFloat(formData.get('price') as string);
  const stock = parseInt(formData.get('stock') as string);
  const imagesStr = formData.get('images') as string;

  const images = imagesStr ? imagesStr.split(',').map(s => s.trim()).filter(Boolean) : [];

  try {
    await ecommerceService.createNewProduct({
      name,
      description,
      price,
      stock,
      images,
      active: true
    }, orgId);

    revalidatePath('/shop');
    revalidatePath('/admin/products');

    // Retornem l'objecte que compleix amb ActionState
    return { success: true, message: 'Producte creat correctament!' };

  } catch (error) {
    console.error(error);
    // Retornem l'objecte amb l'error, complint el tipus
    return {
      success: false,
      message: 'Error al crear',
      error: error instanceof Error ? error.message : "Error desconegut"
    };
  }
}

// üëá NOVA ACTION (Fetching)
export async function getProductBySlugAction(slug: string) {
  try {
    const orgId = getOrgId();
    // Aquesta funci√≥ ja existeix al repository, nom√©s l'exposem
    // Per√≤ atenci√≥: el repository method es diu 'getProductBySlug'
    // Assegura't que l'has afegit a EcommerceService tamb√©
    return await ecommerceService.getProductBySlug(slug, orgId);
  } catch (error) {
    console.error("Error fetching product:", error);
    return null;
  }
}

// üëá NOVA ACCI√ì ADMIN
export async function getAdminOrdersAction() {
  await requireAdmin(); // Seguretat
  try {
    return await ecommerceService.getAdminOrders(getOrgId());
  } catch (error) {
    console.error(error);
    return [];
  }
}



// =================== FILE: src/features/ecommerce/__tests__/actions.test.ts ===================

import { describe, it, expect, vi, beforeEach } from 'vitest';
import { createProductAction, checkoutAction } from '../actions';
import { ecommerceService } from '@/services/container';

import type { CreateOrderDTO } from '@/types/models';

vi.mock('@/services/container', () => ({
  ecommerceService: {
    createNewProduct: vi.fn(),
    processCheckout: vi.fn(),
  },
}));

vi.mock('@/lib/auth/guards', () => ({
  requireAdmin: vi.fn().mockResolvedValue(true),
}));

vi.mock('next/cache', () => ({
  revalidatePath: vi.fn(),
}));

describe('Ecommerce Actions', () => {
  beforeEach(() => {
    process.env.NEXT_PUBLIC_ORG_ID = 'org_123';
    vi.clearAllMocks();
  });

  describe('createProductAction', () => {
    it('hauria de crear producte i retornar success', async () => {
      const formData = new FormData();
      formData.append('name', 'Prod 1');
      formData.append('price', '100');
      formData.append('stock', '10');

      const result = await createProductAction({ success: false, message: '' }, formData);

      expect(ecommerceService.createNewProduct).toHaveBeenCalledWith(
        expect.objectContaining({ name: 'Prod 1', price: 100 }),
        'org_123'
      );
      expect(result.success).toBe(true);
    });
  });

  describe('checkoutAction', () => {
    it('hauria de retornar url de redirecci√≥ si va b√©', async () => {
      vi.mocked(ecommerceService.processCheckout).mockResolvedValue({ redirectUrl: 'https://stripe.com/pay' });
      
      // ‚úÖ CORRECTE: Casting a la interf√≠cie esperada, no 'any'
      const orderData = { items: [] } as unknown as CreateOrderDTO;
      
      const result = await checkoutAction(orderData);

      expect(result).toEqual({ success: true, redirectUrl: 'https://stripe.com/pay' });
    });
  });
});

// =================== FILE: src/i18n/request.ts ===================

import { getRequestConfig } from 'next-intl/server';
import { CONFIG } from '@/config/digitai.config';

export default getRequestConfig(async ({ requestLocale }) => {
    // Aix√≤ assegura que tenim un locale v√†lid
    let locale = await requestLocale;

    if (!locale || !CONFIG.i18n.locales.includes(locale)) {
        locale = CONFIG.i18n.defaultLocale;
    }

    return {
        locale,
        messages: (await import(`../messages/${locale}.json`)).default
    };
});

// =================== FILE: src/lib/auth/guards.ts ===================

import { authService } from '@/services/container';
import { createClient } from '@/lib/supabase/server';

export async function requireAdmin() {
  const supabase = await createClient();
  const { data: { user } } = await supabase.auth.getUser();

  if (!user) throw new Error("No autenticat");

  const orgId = process.env.NEXT_PUBLIC_ORG_ID!;
  const isAdmin = await authService.isAdmin(user.id, orgId);

  if (!isAdmin) {
    throw new Error("ACC√âS DENEGAT: Es requereixen permisos d'administrador.");
  }

  return user;
}

// =================== FILE: src/lib/email/adapters/ResendAdapter.ts ===================

import { Resend } from 'resend';
import { EmailAdapter, SendEmailDTO } from '../EmailAdapter';

export class ResendAdapter implements EmailAdapter {
  private client: Resend | null = null;

  private getClient(): Resend | null {
    // üõ°Ô∏è LAZY LOADING: Nom√©s instanciem si tenim la clau i quan es demana
    if (!this.client) {
      const apiKey = process.env.RESEND_API_KEY;
      
      if (!apiKey) {
        console.warn("‚ö†Ô∏è RESEND_API_KEY no trobada. Els emails no sortiran.");
        return null;
      }
      
      this.client = new Resend(apiKey);
    }
    return this.client;
  }

  private getFromEmail(): string {
    const email = process.env.EMAIL_FROM_ADDRESS || 'onboarding@resend.dev';
    const name = process.env.EMAIL_FROM_NAME || 'DigitAI Bot';
    return `${name} <${email}>`;
  }

  async send({ to, subject, html }: SendEmailDTO): Promise<void> {
    const resend = this.getClient();
    
    // Si no tenim client (falta API Key), fallem silenciosament o fem log,
    // per√≤ NO trenquem l'app.
    if (!resend) return;

    try {
      await resend.emails.send({
        from: this.getFromEmail(),
        to,
        subject,
        html,
      });
      console.log(`üìß Email enviat a ${to}`);
    } catch (error) {
      console.error("‚ùå Error enviant email via Resend:", error);
      // Opcional: Llan√ßar error si vols que el proc√©s falli
    }
  }
}

// =================== FILE: src/lib/email/email-service.ts ===================

import { EmailAdapter } from './EmailAdapter';
import { ResendAdapter } from './adapters/ResendAdapter';

// Models
export interface EmailItem {
  quantity: number;
  name: string;
  price: number;
}

// Inicialitzem l'adapter (podriem injectar-lo, per√≤ per ara ho fem directe)
const emailAdapter: EmailAdapter = new ResendAdapter();

export const EmailService = {
  
  // 1. Confirmaci√≥ de Comanda
  async sendOrderConfirmation(toEmail: string, orderId: string, total: number, items: EmailItem[]) {
    // L√≤gica de presentaci√≥ (HTML)
    const itemsList = items.map(i =>
      `<li><strong>${i.quantity}x</strong> ${i.name} - ${i.price.toFixed(2)}‚Ç¨</li>`
    ).join('');

    const htmlContent = `
      <div style="font-family: sans-serif; max-width: 600px; margin: 0 auto; color: #333;">
        <h1 style="color: #000;">Gr√†cies per la teva compra! üéâ</h1>
        <p>Hem rebut el teu pagament correctament. Aqu√≠ tens el resum:</p>
        
        <div style="background: #f9f9f9; padding: 20px; border-radius: 10px; border: 1px solid #eee;">
          <h3 style="margin-top: 0;">Comanda #${orderId.slice(0, 8)}</h3>
          <ul style="padding-left: 20px;">${itemsList}</ul>
          <hr style="border: 0; border-top: 1px solid #ccc; margin: 20px 0;" />
          <p style="font-size: 18px; text-align: right;"><strong>Total: ${total.toFixed(2)} ‚Ç¨</strong></p>
        </div>

        <p style="margin-top: 30px; font-size: 12px; color: #888;">
          Enviarem els teus productes el m√©s aviat possible.
        </p>
      </div>
    `;

    // Deleguem l'enviament a l'adapter
    await emailAdapter.send({
      to: toEmail,
      subject: `Comanda Confirmada #${orderId.slice(0, 8)}`,
      html: htmlContent
    });
  },

  // 2. Benvinguda al Registre
  async sendWelcomeEmail(toEmail: string, name: string) {
    const appName = process.env.EMAIL_FROM_NAME || 'la nostra plataforma';
    
    const htmlContent = `
      <div style="font-family: sans-serif; max-width: 600px; margin: 0 auto;">
        <h1>Hola ${name}! üëã</h1>
        <p>Gr√†cies per crear el teu compte.</p>
        <p>Ara pots accedir a la teva √†rea privada.</p>
        
        <a href="${process.env.NEXT_PUBLIC_APP_URL}/auth/login" style="background: #000; color: #fff; padding: 10px 20px; text-decoration: none; border-radius: 5px;">Accedir al meu compte</a>
      </div>
    `;

    await emailAdapter.send({
      to: toEmail,
      subject: `Benvingut/da a ${appName}!`,
      html: htmlContent
    });
  }
};

// =================== FILE: src/lib/email/EmailAdapter.ts ===================

export interface SendEmailDTO {
  to: string;
  subject: string;
  html: string;
}

export interface EmailAdapter {
  send(data: SendEmailDTO): Promise<void>;
}

// =================== FILE: src/lib/payment/stripe-gateway.ts ===================

import Stripe from 'stripe';
import { IPaymentGateway, PaymentResult } from '@/repositories/interfaces/IPaymentGateway';
import { Order, CartItem } from '@/types/models';

export class StripeGateway implements IPaymentGateway {
    // 1. Declarem stripe com a opcional i no el creem al constructor
    private stripe: Stripe | null = null;

    constructor() {
        // El constructor ara √©s segur i buit. No explota al build.
    }

    // 2. M√®tode privat per obtenir el client nom√©s quan es necessita
    private getStripeClient(): Stripe {
        if (!this.stripe) {
            const secretKey = process.env.STRIPE_SECRET_KEY;
            
            if (!secretKey) {
                // Nom√©s llencem l'error si REALMENT estem intentant usar Stripe
                throw new Error("‚ùå STRIPE_SECRET_KEY no configurada. No es pot processar el pagament.");
            }

            this.stripe = new Stripe(secretKey, {
                apiVersion: undefined,
                typescript: true,
            });
        }
        return this.stripe;
    }

    async createCheckoutSession(order: Order, items: CartItem[]): Promise<PaymentResult> {
        const domain = process.env.NEXT_PUBLIC_APP_URL || 'http://localhost:3000';
        const stripe = this.getStripeClient(); // üëà Obtenim el client aqu√≠

        const lineItems: Stripe.Checkout.SessionCreateParams.LineItem[] = items.map((item) => ({
            price_data: {
                currency: 'eur',
                product_data: {
                    name: item.name,
                    images: item.image ? [item.image] : [],
                },
                unit_amount: Math.round(item.price * 100), 
            },
            quantity: item.quantity,
        }));

        const session = await stripe.checkout.sessions.create({
            payment_method_types: ['card'],
            line_items: lineItems,
            mode: 'payment',
            success_url: `${domain}/checkout/success?session_id={CHECKOUT_SESSION_ID}&orderId=${order.id}`,
            cancel_url: `${domain}/shop`,
            customer_email: order.customer_email,
            client_reference_id: order.id,
            metadata: {
                orderId: order.id,
                orgId: order.organization_id
            }
        });

        if (!session.url) throw new Error("No s'ha pogut generar la URL de Stripe");

        return {
            success: true,
            redirectUrl: session.url,
            transactionId: session.id
        };
    }

    async verifyWebhook(signature: string, body: string | Buffer): Promise<Stripe.Event> {
        const stripe = this.getStripeClient(); // üëà Obtenim el client aqu√≠
        const secret = process.env.STRIPE_WEBHOOK_SECRET;

        if (!secret) throw new Error("STRIPE_WEBHOOK_SECRET missing");

        return stripe.webhooks.constructEvent(body, signature, secret);
    }
}

// =================== FILE: src/lib/store/cart-store.ts ===================

'use client';

import { create } from 'zustand';
import { persist, createJSONStorage } from 'zustand/middleware';
import { CartItem, Product } from '@/types/models';
import { toast } from 'sonner';

interface CartState {
  items: CartItem[];
  isOpen: boolean;
  addItem: (product: Product) => void;
  removeItem: (productId: string) => void;
  updateQuantity: (productId: string, quantity: number) => void;
  clearCart: () => void;
  toggleCart: () => void;
  
  // Getters computats
  totalItems: () => number;
  totalPrice: () => number;
}

export const useCartStore = create<CartState>()(
  persist(
    (set, get) => ({
      items: [],
      isOpen: false,

      addItem: (product: Product) => {
        const currentItems = get().items;
        const existingItem = currentItems.find((item) => item.id === product.id);

        if (existingItem) {
          // Si ja existeix, sumem 1, per√≤ no passem de l'estoc
          if (existingItem.quantity < existingItem.stock) {
            set({
              items: currentItems.map((item) =>
                item.id === product.id
                  ? { ...item, quantity: item.quantity + 1 }
                  : item
              ),
              isOpen: true,
            });
            toast.success("Quantitat actualitzada al carret");
          } else {
            toast.error("No hi ha m√©s estoc disponible");
          }
        } else {
          // ‚úÖ FIX: MAPEIG CORRECTE (Aqu√≠ era l'error)
          // Transformem Product -> CartItem netejant dades innecess√†ries
          const newItem: CartItem = {
            id: product.id,
            organization_id: product.organization_id, // üëà AFEGIT
            name: product.name,
            price: product.price,
            stock: product.stock,
            slug: product.slug,
            image: product.images?.[0], // üëà Agafem nom√©s la 1a imatge
            quantity: 1,
          };

          set({ items: [...currentItems, newItem], isOpen: true });
          // toast.success("Producte afegit al carret"); (Opcional, ja ho fas al component)
        }
      },

      removeItem: (productId) => {
        set((state) => ({
          items: state.items.filter((item) => item.id !== productId),
        }));
        toast.info("Producte eliminat");
      },

      updateQuantity: (productId, quantity) => {
        set((state) => ({
          items: state.items.map((item) => {
            if (item.id === productId) {
              // Validaci√≥ d'estoc en temps real
              const newQuantity = Math.max(1, Math.min(quantity, item.stock));
              return { ...item, quantity: newQuantity };
            }
            return item;
          }),
        }));
      },

      clearCart: () => set({ items: [] }),
      
      toggleCart: () => set((state) => ({ isOpen: !state.isOpen })),

      totalItems: () => get().items.reduce((acc, item) => acc + item.quantity, 0),
      
      totalPrice: () => get().items.reduce((acc, item) => acc + item.price * item.quantity, 0),
    }),
    {
      name: 'digitai-cart-storage',
      storage: createJSONStorage(() => localStorage),
      // Opcional: nom√©s persistim 'items', no l'estat d'obertura
      partialize: (state) => ({ items: state.items }),
    }
  )
);

// =================== FILE: src/lib/supabase/client.ts ===================

import { createBrowserClient } from '@supabase/ssr';

export function createClient() {
  return createBrowserClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
  );
}

// =================== FILE: src/lib/supabase/server.ts ===================

import { createServerClient } from '@supabase/ssr';
import { createClient as createSupabaseClient } from '@supabase/supabase-js';
import { cookies } from 'next/headers';
import { Database } from '@/types/database.types';

// Validaci√≥ de variables d'entorn (Fail Fast)
const SUPABASE_URL = process.env.NEXT_PUBLIC_SUPABASE_URL!;
const SUPABASE_ANON_KEY = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!;
const SUPABASE_SERVICE_ROLE_KEY = process.env.SUPABASE_SERVICE_ROLE_KEY!;

if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
  throw new Error("‚ùå Error Cr√≠tic: Falten les variables d'entorn de Supabase p√∫bliques.");
}

/**
 * 1. CLIENT EST√ÄNDARD (User Context)
 * Utilitza aquest client el 99% de les vegades.
 * - Llegeix les cookies de l'usuari.
 * - Respecta les pol√≠tiques de seguretat (RLS).
 * - Sap qui √©s l'usuari actual.
 */
export async function createClient() {
  const cookieStore = await cookies();

  return createServerClient<Database>(
    SUPABASE_URL,
    SUPABASE_ANON_KEY,
    {
      cookies: {
        getAll() {
          return cookieStore.getAll();
        },
        setAll(cookiesToSet) {
          try {
            cookiesToSet.forEach(({ name, value, options }) =>
              cookieStore.set(name, value, options)
            )
          } catch {
            // Ignorem errors de cookie en Server Components purs
            // (Aix√≤ es gestiona autom√†ticament pel Middleware)
          }
        },
      },
    }
  );
}

/**
 * 2. CLIENT ADMINISTRADOR (Service Role)
 * ‚ö†Ô∏è PERILL: Aquest client t√© permisos de "D√âU".
 * - Ignora totes les pol√≠tiques RLS.
 * - Pot llegir/escriure/esborrar qualsevol dada de qualsevol organitzaci√≥.
 * - Utilitza-ho NOM√âS per:
 * - Crear l'usuari inicial (Sign Up).
 * - Webhooks (Stripe).
 * - Tasques de manteniment (Cron Jobs).
 */
export function createAdminClient() {
  if (!SUPABASE_SERVICE_ROLE_KEY) {
    throw new Error("‚ùå Error Cr√≠tic: Falta SUPABASE_SERVICE_ROLE_KEY. No es pot crear el client Admin.");
  }

  return createSupabaseClient<Database>(
    SUPABASE_URL,
    SUPABASE_SERVICE_ROLE_KEY,
    {
      auth: {
        autoRefreshToken: false,
        persistSession: false, // No guardem sessi√≥, √©s una petici√≥ d'API pura
      }
    }
  );
}

// =================== FILE: src/lib/theme-utils.ts ===================

// src/lib/theme-utils.ts

export function hexToHsl(hex: string): { h: number; s: number; l: number } {
  const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
  if (!result) return { h: 0, s: 0, l: 0 }; 

  const r = parseInt(result[1], 16) / 255;
  const g = parseInt(result[2], 16) / 255;
  const b = parseInt(result[3], 16) / 255;

  const max = Math.max(r, g, b), min = Math.min(r, g, b);
  let h = 0, s; const l = (max + min) / 2;

  if (max === min) {
    h = s = 0;
  } else {
    const d = max - min;
    s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
    switch (max) {
      case r: h = (g - b) / d + (g < b ? 6 : 0); break;
      case g: h = (b - r) / d + 2; break;
      case b: h = (r - g) / d + 4; break;
    }
    h /= 6;
  }

  return { h: Math.round(h * 360), s: Math.round(s * 100), l: Math.round(l * 100) };
}

const toHslString = (h: number, s: number, l: number) => `${h} ${s}% ${l}%`;

export function generateThemeVariables(primaryHex: string) {
  const { h, s, l } = hexToHsl(primaryHex);

  // Generem una paleta tintada
  const sTint = Math.max(5, Math.floor(s * 0.2)); 

  const palette = {
    50:  toHslString(h, sTint, 98),
    100: toHslString(h, sTint, 94),
    500: toHslString(h, s, l),       
    900: toHslString(h, sTint, 15),
  };

  // üåû LIGHT MODE (Blanc Net)
  const lightVars = {
    '--background': '0 0% 100%',
    '--foreground': '222 47% 11%',     // Slate-900
    '--card': '0 0% 100%',
    '--card-foreground': '222 47% 11%',
    '--popover': '0 0% 100%',
    '--popover-foreground': '222 47% 11%',
    '--primary': palette[500],
    '--primary-foreground': l > 60 ? '222 47% 11%' : '0 0% 98%',
    '--secondary': '210 40% 96.1%',    // Slate-100
    '--secondary-foreground': '222 47% 11%',
    '--muted': '210 40% 96.1%',
    '--muted-foreground': '215.4 16.3% 46.9%', // Slate-500
    '--accent': '210 40% 96.1%',
    '--accent-foreground': '222 47% 11%',
    '--destructive': '0 84.2% 60.2%',
    '--destructive-foreground': '0 0% 98%',
    '--border': '214.3 31.8% 91.4%',   // Slate-200
    '--input': '214.3 31.8% 91.4%',
    '--ring': palette[500],
  };

  // üåô DARK MODE (Grisos Elegants - No Negre)
  // Utilitzem la gamma "Slate" de Tailwind com a base per al Dark Mode
  const darkVars = {
    '--background': '222 47% 11%',     // Slate-950 (Fons Base)
    '--foreground': '210 40% 98%',     // Slate-50
    '--card': '217 33% 17%',           // Slate-900 (Targetes lleugerament m√©s clares)
    '--card-foreground': '210 40% 98%',
    '--popover': '217 33% 17%',
    '--popover-foreground': '210 40% 98%',
    '--primary': palette[500],         // Mantenim el color de marca
    '--primary-foreground': l > 60 ? '222 47% 11%' : '0 0% 98%',
    '--secondary': '217 33% 17%',      // Slate-800/900
    '--secondary-foreground': '210 40% 98%',
    '--muted': '217 33% 17%',
    '--muted-foreground': '215 20.2% 65.1%', // Slate-400
    '--accent': '217 33% 17%',
    '--accent-foreground': '210 40% 98%',
    '--destructive': '0 62.8% 30.6%',
    '--destructive-foreground': '0 0% 98%',
    '--border': '217 33% 17%',         // Vores suaus
    '--input': '217 33% 17%',
    '--ring': '212.7 26.8% 83.9%',     // Slate-300
  };

  return { lightVars, darkVars, paletteVars: {} };
}

// =================== FILE: src/lib/utils.ts ===================

import { type ClassValue, clsx } from "clsx";
import { twMerge } from "tailwind-merge";

export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs));
}

// =================== FILE: src/messages/ca.json ===================

{
  "Navbar": {
    "links": {
      "home": "Inici",
      "services": "Serveis",
      "blog": "Blog",
      "contact": "Contacte",
      "about": "Nosaltres"
    },
    "cta": "Acc√©s Clients",
    "actions": {
      "login": "Acc√©s Client",
      "cart": "Cistella",
      "menu": "Men√∫"
    }
  },
  "Hero": {
    "title": "Impulsa el teu negoci al seg√ºent nivell",
    "subtitle": "Solucions digitals a mida, dissenyades per convertir visitants en clients fidels. Tecnologia d'avantguarda al teu abast.",
    "cta": "Comen√ßar ara",
    "demoVideo": "Veure demo"
  },
  "Services": {
    "badge": "Els nostres Serveis",
    "subtitle": "Solucions estrat√®giques dissenyades per escalar el teu negoci.",
    "headlinePrefix": "Escull la teva",
    "headlineHighlight": "Experi√®ncia",
    "emptyState": {
      "title": "No hi ha serveis disponibles",
      "text": "Sembla que encara no hem configurat els serveis. Torna m√©s tard!"
    }
  },
  "Testimonials": {
    "title": "Confian√ßa total",
    "subtitle": "M√©s de 500 empreses ja han transformat el seu negoci amb nosaltres.",
    "reviews": [
      {
        "author": "Anna Vila",
        "role": "CEO, TechStart",
        "text": "Incre√Øble equip. Han captat la nostra visi√≥ des del primer minut.",
        "rating": 5
      },
      {
        "author": "Marc Soler",
        "role": "Director, Soler & Co",
        "text": "La millor inversi√≥ que hem fet aquest any. Resultats immediats.",
        "rating": 5
      },
      {
        "author": "Laura Puig",
        "role": "Marketing, EcoShop",
        "text": "Professionalitat i disseny d'alt nivell. Recomanad√≠ssim.",
        "rating": 4
      }
    ]
  },
  "Stats": {
    "items": [
      {
        "value": "10k+",
        "label": "Usuaris Actius"
      },
      {
        "value": "24h",
        "label": "Temps de Resposta"
      },
      {
        "value": "99%",
        "label": "Satisfacci√≥"
      },
      {
        "value": "50+",
        "label": "Premis Guanyats"
      }
    ]
  },
  "FAQ": {
    "title": "Preguntes Freq√ºents",
    "items": []
  },
  "Contact": {
    "title": "Parlem?",
    "button": "Enviar"
  },
  "CTA": {
    "heading": "Est√†s llest?",
    "subheading": "Uneix-te avui mateix.",
    "button": "Registra't"
  },
  "Map": {
    "title": "Visita'ns"
  },
  "Shop": {
    "featuredTitle": "Novetats Destacades",
    "featuredSubtitle": "Els productes m√©s venuts i les millors ofertes de la temporada."
  },
  "Booking": {
    "title": "Reserva la teva cita",
    "subtitle": "Selecciona el servei, tria el dia que millor et vagi i confirma la teva assist√®ncia en menys d'un minut.",
    "steps": {
      "services": {
        "title": "Quin servei necessites?",
        "duration": "{minutes} min",
        "select": "Seleccionar"
      },
      "datetime": {
        "back": "Tornar als serveis",
        "select_day_title": "Tria un dia",
        "select_time_title": "Hores lliures",
        "empty_state_day": "Selecciona un dia del calendari.",
        "empty_state_slots": "No hi ha hores disponibles.",
        "loading": "Buscant hores..."
      },
      "form": {
        "back": "Canviar hora",
        "title": "Les teves dades",
        "subtitle": "Completa el formulari per confirmar.",
        "personal_info": "Informaci√≥ Personal",
        "additional_info": "Informaci√≥ Addicional",
        "labels": {
          "name": "Nom",
          "email": "Email"
        },
        "submit": "Confirmar Reserva",
        "submitting": "Processant..."
      },
      "success": {
        "title": "Reserva Confirmada!",
        "message": "T'hem enviat un correu electr√≤nic amb els detalls.",
        "home_button": "Tornar a l'inici"
      }
    },
    "errors": {
      "load_slots": "Error carregant horaris.",
      "required_field": "Aquest camp √©s obligatori."
    }
  },
  "About": {
    "badge": "Sobre Nosaltres",
    "title": "La nostra ess√®ncia",
    "description": "Som un equip apassionat per la tecnologia, dedicat a transformar idees en solucions digitals robustes i escalables.",
    "features": [
      "Comprom√≠s innegociable amb la qualitat",
      "Atenci√≥ 100% personalitzada",
      "Innovaci√≥ tecnol√≤gica constant"
    ],
    "stats": [
      {
        "value": "+5",
        "label": "Anys d'experi√®ncia"
      },
      {
        "value": "100%",
        "label": "Clients Satisfets"
      },
      {
        "value": "24/7",
        "label": "Disponibilitat"
      }
    ],
    "card": {
      "title": "Creixement",
      "subtitle": "Resultats provats"
    }
  }
}

// =================== FILE: src/messages/en.json ===================

{
  "Navbar": {
    "links": {
      "home": "Home",
      "services": "Services",
      "blog": "Blog",
      "contact": "Contact",
      "about": "About Us"
    },
    "cta": "Client Access",
    "actions": {
      "login": "Client Login",
      "cart": "Cart",
      "menu": "Menu"
    }
  },
  "Hero": {
    "title": "Take your business to the next level",
    "subtitle": "Custom digital solutions designed to turn visitors into loyal customers. Cutting-edge technology at your fingertips.",
    "cta": "Get started",
    "demoVideo": "View demo"
  },
  "Services": {
    "badge": "Our Services",
    "subtitle": "Strategic solutions designed to scale your business.",
    "headlinePrefix": "Choose your",
    "headlineHighlight": "Experience",
    "emptyState": {
      "title": "No services available",
      "text": "It seems we haven't configured the services yet. Check back later!"
    }
  },
  "Testimonials": {
    "title": "Trusted by many",
    "subtitle": "Over 500 companies have already transformed their business with us.",
    "reviews": [
      {
        "author": "Anna Vila",
        "role": "CEO, TechStart",
        "text": "An incredible team. They understood our vision from day one.",
        "rating": 5
      },
      {
        "author": "Marc Soler",
        "role": "Director, Soler & Co",
        "text": "The best investment we‚Äôve made this year. Immediate results.",
        "rating": 5
      },
      {
        "author": "Laura Puig",
        "role": "Marketing, EcoShop",
        "text": "High-level professionalism and design. Highly recommended.",
        "rating": 4
      }
    ]
  },
  "Stats": {
    "items": [
      {
        "value": "10k+",
        "label": "Active Users"
      },
      {
        "value": "24h",
        "label": "Response Time"
      },
      {
        "value": "99%",
        "label": "Satisfaction"
      },
      {
        "value": "50+",
        "label": "Awards Won"
      }
    ]
  },
  "FAQ": {
    "title": "Frequently Asked Questions",
    "items": []
  },
  "Contact": {
    "title": "Shall we talk?",
    "button": "Send"
  },
  "CTA": {
    "heading": "Ready to get started?",
    "subheading": "Join us today.",
    "button": "Sign up"
  },
  "Map": {
    "title": "Visit us"
  },
  "Shop": {
    "featuredTitle": "Featured New Arrivals",
    "featuredSubtitle": "Top-selling products and the best deals of the season."
  },
  "About": {
    "badge": "About Us",
    "title": "Our Essence",
    "description": "We are a team passionate about technology, dedicated to transforming ideas into robust and scalable digital solutions.",
    "features": [
      "Uncompromised commitment to quality",
      "100% personalized attention",
      "Constant technological innovation"
    ],
    "stats": [
      {
        "value": "+5",
        "label": "Years of experience"
      },
      {
        "value": "100%",
        "label": "Satisfied Clients"
      },
      {
        "value": "24/7",
        "label": "Availability"
      }
    ],
    "card": {
      "title": "Growth",
      "subtitle": "Proven results"
    }
  }
}

// =================== FILE: src/messages/es.json ===================

{
  "Navbar": {
    "links": {
      "home": "Inicio",
      "services": "Servicios",
      "blog": "Blog",
      "contact": "Contacto",
      "about": "Nosotros"
    },
    "cta": "Acceso Clientes",
    "actions": {
      "login": "Acceso Cliente",
      "cart": "Carrito",
      "menu": "Men√∫"
    }
  },
  "Hero": {
    "title": "Impulsa tu negocio al siguiente nivel",
    "subtitle": "Soluciones digitales a medida, dise√±adas para convertir visitantes en clientes fieles. Tecnolog√≠a de vanguardia a tu alcance.",
    "cta": "Empezar ahora",
    "demoVideo": "Ver demo"
  },
  "Services": {
    "badge": "Nuestros Servicios",
    "subtitle": "Soluciones estrat√©gicas dise√±adas para escalar tu negocio.",
    "headlinePrefix": "Elige tu",
    "headlineHighlight": "Experiencia",
    "emptyState": {
      "title": "No hay servicios disponibles",
      "text": "Parece que a√∫n no hemos configurado los servicios. ¬°Vuelve m√°s tarde!"
    }
  },
  "Testimonials": {
    "title": "Confianza total",
    "subtitle": "M√°s de 500 empresas ya han transformado su negocio con nosotros.",
    "reviews": [
      {
        "author": "Anna Vila",
        "role": "CEO, TechStart",
        "text": "Equipo incre√≠ble. Captaron nuestra visi√≥n desde el primer minuto.",
        "rating": 5
      },
      {
        "author": "Marc Soler",
        "role": "Director, Soler & Co",
        "text": "La mejor inversi√≥n que hemos hecho este a√±o. Resultados inmediatos.",
        "rating": 5
      },
      {
        "author": "Laura Puig",
        "role": "Marketing, EcoShop",
        "text": "Profesionalidad y dise√±o de alto nivel. Muy recomendable.",
        "rating": 4
      }
    ]
  },
  "Stats": {
    "items": [
      {
        "value": "10k+",
        "label": "Usuarios Activos"
      },
      {
        "value": "24h",
        "label": "Tiempo de Respuesta"
      },
      {
        "value": "99%",
        "label": "Satisfacci√≥n"
      },
      {
        "value": "50+",
        "label": "Premios Ganados"
      }
    ]
  },
  "FAQ": {
    "title": "Preguntas Frecuentes",
    "items": []
  },
  "Contact": {
    "title": "¬øHablamos?",
    "button": "Enviar"
  },
  "CTA": {
    "heading": "¬øEst√°s listo?",
    "subheading": "√önete hoy mismo.",
    "button": "Reg√≠strate"
  },
  "Map": {
    "title": "Vis√≠tanos"
  },
  "Shop": {
    "featuredTitle": "Novedades Destacadas",
    "featuredSubtitle": "Los productos m√°s vendidos y las mejores ofertas de la temporada."
  },
  "About": {
    "badge": "Sobre Nosotros",
    "title": "Nuestra esencia",
    "description": "Somos un equipo apasionado por la tecnolog√≠a, dedicado a transformar ideas en soluciones digitales robustas y escalables.",
    "features": [
      "Compromiso innegociable con la calidad",
      "Atenci√≥n 100% personalizada",
      "Innovaci√≥n tecnol√≥gica constante"
    ],
    "stats": [
      {
        "value": "+5",
        "label": "A√±os de experiencia"
      },
      {
        "value": "100%",
        "label": "Clientes Satisfechos"
      },
      {
        "value": "24/7",
        "label": "Disponibilidad"
      }
    ],
    "card": {
      "title": "Crecimiento",
      "subtitle": "Resultados probados"
    }
  }
}

// =================== FILE: src/proxy.ts ===================

import { type NextRequest, NextResponse } from 'next/server';
import createMiddleware from 'next-intl/middleware';
import { createServerClient } from '@supabase/ssr';
import { CONFIG } from '@/config/digitai.config';

// 1. Configurem el middleware d'idiomes
const intlMiddleware = createMiddleware({
  locales: CONFIG.i18n.locales,
  defaultLocale: CONFIG.i18n.defaultLocale,
  localePrefix: 'always'
});

export async function proxy(request: NextRequest) {
  if (
    request.nextUrl.pathname.startsWith('/_next') ||
    request.nextUrl.pathname.includes('/api/') ||
    /\.(.*)$/.test(request.nextUrl.pathname) // Detecta qualsevol extensi√≥ (.js, .png, .json, .webmanifest)
  ) {
    return NextResponse.next();
  }
  // 2. Primer, executem la l√≤gica d'idiomes per tenir la resposta base
  // Aix√≤ ens assegura que la URL ja t√© /ca o /es si cal.
  const response = intlMiddleware(request);

  // 3. Inicialitzem client Supabase per gestionar cookies
  const supabase = createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        getAll() {
          return request.cookies.getAll();
        },
        setAll(cookiesToSet) {
          // Aquesta part √©s crucial: passem les cookies de Supabase a la resposta de next-intl
          cookiesToSet.forEach(({ name, value, options }) => {
            request.cookies.set(name, value);
            response.cookies.set(name, value, options);
          });
        },
      },
    }
  );

  // 4. Refresquem sessi√≥ (Important per RLS)
  // No ens importa el user aqu√≠, nom√©s que la cookie es mantingui viva.
  const { data: { user } } = await supabase.auth.getUser();

  // 5. PROTECCI√ì DE RUTES (Firewall)
  // Si intenta entrar a una ruta privada (dashboard) sense usuari -> Login
  // Usem una RegExp per detectar /ca/dashboard, /es/dashboard, etc.
  const isPrivateRoute = /^\/(ca|es|en)\/\(app\)/.test(request.nextUrl.pathname) ||
    request.nextUrl.pathname.includes('/dashboard');

  if (isPrivateRoute && !user) {
    // Redirigim al login mantenint l'idioma
    const locale = request.nextUrl.pathname.split('/')[1] || CONFIG.i18n.defaultLocale;
    const url = request.nextUrl.clone();
    url.pathname = `/${locale}/auth/login`;
    return NextResponse.redirect(url);
  }

  // 6. Si ja est√† loguejat i va al login -> Cap al dashboard
  if (request.nextUrl.pathname.includes('/auth/login') && user) {
    const locale = request.nextUrl.pathname.split('/')[1] || CONFIG.i18n.defaultLocale;
    const url = request.nextUrl.clone();
    url.pathname = `/${locale}/dashboard`;
    return NextResponse.redirect(url);
  }

  return response;
}


export const config = {
  // Ignorem fitxers est√†tics i API
  matcher: [
    // Match all pathnames except for
    // - ‚Ä¶ if they start with `/api`, `/_next` or `/_vercel`
    // - ‚Ä¶ the ones containing a dot (e.g. `favicon.ico`)
    '/((?!api|_next|_vercel|.*\\..*).*)',
  ]
};

// =================== FILE: src/repositories/interfaces/IAuthRepository.ts ===================

import { UserProfile, CreateProfileDTO } from '@/types/models';

// Resultat gen√®ric d'Auth (pot ser de Supabase o qualsevol altre)
export type AuthResult = {
  user: { id: string; email?: string } | null;
  error?: { message: string; status?: number } | null;
};

export interface IAuthRepository {
  // Accions d'Identitat (Auth)
  signUp(email: string, password: string, meta: { full_name: string; org_id: string }): Promise<AuthResult>;
  signIn(email: string, password: string): Promise<AuthResult>;
  signOut(): Promise<void>;

  // Accions de Dades (Profile)
  getProfile(userId: string, orgId: string): Promise<UserProfile | null>;
  
  // Acci√≥ Privilegiada (requereix Admin Client internament)
  createProfileForce(data: CreateProfileDTO): Promise<void>;
}

// =================== FILE: src/repositories/interfaces/IBookingRepository.ts ===================

import { ServiceDTO, Booking, BookingWithService, Schedule } from '@/types/models';

export interface IBookingRepository {
  getServices(orgId: string): Promise<ServiceDTO[]>;
  getServiceById(id: string): Promise<ServiceDTO | null>;
  
  // ‚úÖ Aqu√≠ est√† la clau: Al fer Omit de 'id' i 'created_at', 
  // TypeScript veu que 'organization_id' (que hem afegit al pas 1) √âS OBLIGATORI.
  createService(service: Omit<ServiceDTO, 'id' | 'created_at'>): Promise<ServiceDTO>;
  
  // ... altres m√®todes
  deleteService(id: string): Promise<void>;
  getBookingsByDateRange(orgId: string, start: Date, end: Date): Promise<Booking[]>;
  createBooking(booking: Omit<Booking, 'id' | 'created_at'>): Promise<Booking>;
  getBookings(orgId: string): Promise<Booking[]>;
  getBookingsByUser(userId: string): Promise<BookingWithService[]>;
  getScheduleForDay(orgId: string, dayOfWeek: number): Promise<Schedule | null>;
  isDateBlocked(orgId: string, date: Date): Promise<boolean>;
}

// =================== FILE: src/repositories/interfaces/IContentRepository.ts ===================

import { LandingSectionData } from '@/types/models';

export interface IContentRepository {
  getLandingSections(locale: string): Promise<LandingSectionData[]>;
}

// =================== FILE: src/repositories/interfaces/IPaymentGateway.ts ===================

import { Order } from '@/types/models';

export interface PaymentResult {
  success: boolean;
  redirectUrl?: string;
  transactionId?: string;
  error?: string;
}

export interface IPaymentGateway {
  // `items` hauria de tenir un tipus propi, per√≤ `CartItem[]` √©s acceptable aqu√≠
  createCheckoutSession(order: Order, items: unknown[]): Promise<PaymentResult>;
  
  // üõ†Ô∏è FIX: 'body' √©s string o Buffer. Retornem 'unknown' per no acoblar-nos a Stripe a la interf√≠cie gen√®rica.
  verifyWebhook(signature: string, body: string | Buffer): Promise<unknown>;
}

// =================== FILE: src/repositories/interfaces/IPostRepository.ts ===================

import { BlogPost, CreatePostDTO} from '@/types/models';

export interface IPostRepository {
  // P√∫blic (Web)
  getPublishedPosts(orgId: string): Promise<BlogPost[]>;
  getPostBySlug(slug: string, orgId: string): Promise<BlogPost | null>;

  // Privat (Dashboard)
  getAllPosts(orgId: string): Promise<BlogPost[]>;
  createPost(data: CreatePostDTO & { organization_id: string; slug: string }): Promise<BlogPost>;
  updatePost(id: string, data: Partial<CreatePostDTO>): Promise<void>;
  deletePost(id: string): Promise<void>;
}

// =================== FILE: src/repositories/interfaces/IProductRepository.ts ===================

import { Product, Order, CreateOrderDTO, CreateProductDTO } from '@/types/models';

export interface IEcommerceRepository {
  getProducts(orgId: string): Promise<Product[]>;
  getProductBySlug(slug: string, orgId: string): Promise<Product | null>;
  createOrder(data: CreateOrderDTO, orgId: string): Promise<Order>;
  updateStock(productId: string, quantitySold: number): Promise<void>;
  
  // üëá AFEGIT: M√®tode per crear producte
  createProduct(data: CreateProductDTO & { slug: string }, orgId: string): Promise<Product>;
  getOrders(orgId: string): Promise<Order[]>; // üëà AFEGIT
  getOrdersByUser(userId: string): Promise<Order[]>; // üëà AFEGIT
}

// =================== FILE: src/repositories/static/StaticContentRepository.ts ===================

import { IContentRepository } from '../interfaces/IContentRepository';
import { LandingSectionData, SectionType } from '@/types/models';
import { CONFIG } from '@/config/digitai.config';

// 1. Definim l'estructura esperada del fitxer JSON de traduccions
interface TranslationStructure {
  Hero?: { title?: string; subtitle?: string; cta?: string };
  Services?: {
    title?: string;
    badge?: string;
    subtitle?: string;
    headlinePrefix?: string;
    headlineHighlight?: string;
    emptyState?: { title: string; text: string };
  };
  Contact?: { title?: string; button?: string };
  Stats?: { items: Array<{ value: string; label: string }> };
  Testimonials?: {
    title?: string;
    subtitle?: string;
    reviews: Array<{ author: string; role: string; text: string; rating: number }>;
  };
  Map?: { title?: string; embedUrl?: string };
  FAQ?: {
    title?: string;
    subtitle?: string;
    items: Array<{ question: string; answer: string }>
  };
  CTA?: {
    heading?: string;
    subheading?: string;
    button?: string
  };
  Shop?: {
    featuredTitle?: string;
    featuredSubtitle?: string;
  };
  About?: {
    badge?: string;
    title?: string;
    description?: string;
    features?: string[];
    stats?: Array<{ label: string; value: string }>;
    card?: { title: string; subtitle: string };
  }
}

export class StaticContentRepository implements IContentRepository {

  async getLandingSections(locale: string): Promise<LandingSectionData[]> {
    if (!CONFIG.modules.landing.active) return [];

    // 2. Inicialitzem traduccions
    let messages: Partial<TranslationStructure> = {};

    try {
      // Intentem carregar l'idioma demanat
      messages = (await import(`@/messages/${locale}.json`)).default;
    } catch (error) {
      console.warn(`‚ö†Ô∏è No s'ha trobat traducci√≥ per a '${locale} error:${error}', provant default.`);
      try {
        // Intentem carregar l'idioma per defecte
        messages = (await import(`@/messages/${CONFIG.i18n.defaultLocale}.json`)).default;
      } catch (fatalError) {
        console.error(`‚ùå Error Cr√≠tic: No s'han trobat fitxers de traducci√≥. '${fatalError}'`);
      }
    }

    // 3. Mapegem les seccions amb PRIORITAT CONFIG (IA)
    const sections = CONFIG.modules.landing.sections.map((sectionType, index) => {
      let content = {};

      // Preparem accessos directes a la config de la IA
      const aiHero = CONFIG.content?.hero;
      const aiAbout = CONFIG.content?.about;
      const aiServices = CONFIG.content?.services_intro;
      const aiTestimonials = CONFIG.content?.testimonials; // Recuperem testimonis IA
      switch (sectionType) {
        case 'hero':
          content = {
            // ‚úÖ CORREGIT: Prioritat Config IA -> Traducci√≥ -> Default
            title: aiHero?.title || messages.Hero?.title || `Benvingut a ${CONFIG.identity.name}`,
            subtitle: aiHero?.subtitle || messages.Hero?.subtitle || CONFIG.identity.description,
            ctaText: aiHero?.cta || messages.Hero?.cta || "Saber-ne m√©s",
            companyName: CONFIG.identity.name
          };
          break;

        case 'services':
          content = {
            // 1. Textos: Prioritat IA -> Traducci√≥ -> Defecte
            title: aiServices?.title || messages.Services?.badge || messages.Services?.title || "Serveis",
            subtitle: aiServices?.subtitle || messages.Services?.subtitle || "El que oferim",

            // 2. Configuraci√≥ extra (Prefixos de t√≠tol)
            headlinePrefix: messages.Services?.headlinePrefix || "Solucions",
            headlineHighlight: messages.Services?.headlineHighlight || "A mida",

            // 3. Text per si tot falla (Empty State)
            emptyState: {
              title: messages.Services?.emptyState?.title || "No hi ha serveis disponibles",
              text: messages.Services?.emptyState?.text || "Sembla que encara no hem configurat els serveis."
            },

            // ‚úÖ 4. LA CLAU: Passem els items de la IA al frontend
            items: aiServices?.items || []
          };
          break;

        case 'about':
          content = {
            badge: messages.About?.badge || "Sobre Nosaltres",
            // ‚úÖ Aquest ja el tenies b√©, per√≤ repassa'l
            title: aiAbout?.title || messages.About?.title || "La nostra ess√®ncia",
            description: aiAbout?.description || messages.About?.description || "Som una empresa compromesa...",
            image_url: aiAbout?.image_url,
            features: messages.About?.features || [],
            stats: aiAbout?.stats || messages.About?.stats || [], // Prioritzem IA stats
            card: messages.About?.card || { title: "Creixement", subtitle: "Resultats" }
          };
          break;

        // ... La resta de casos (Contact, Stats, etc.) es mantenen igual perqu√® no els toca la IA encara
        case 'contact':
          content = {
            title: messages.Contact?.title || "Contacte",
            buttonText: messages.Contact?.button || "Enviar Missatge",
            // Podr√≠em afegir email/tel√®fon del CONFIG.identity aqu√≠ si el component ho suporta
          };
          break;
        case 'stats':
          // ‚úÖ FIX: Recuperem els stats de la IA (que estan dins de content.about)
          // Si no n'hi ha, mirem si n'hi ha al JSON de traducci√≥.
          const statsItems = CONFIG.content?.about?.stats || messages.Stats?.items || [];

          content = {
            items: statsItems
          };
          break;

        case 'testimonials':
          content = {
            title: aiTestimonials?.title || messages.Testimonials?.title || "Opinions",
            subtitle: aiTestimonials?.subtitle || messages.Testimonials?.subtitle || "Clients feli√ßos",
            // ‚úÖ CLAU: Si la IA ha generat testimonis, els fem servir
            reviews: aiTestimonials?.items || messages.Testimonials?.reviews || []
          };
          break;

        case 'map':
          content = {
            title: messages.Map?.title || "Troba'ns",
            address: CONFIG.identity.address || "Barcelona, Spain",
            embedUrl: messages.Map?.embedUrl || ""
          };
          break;

        case 'faq':
          content = {
            title: messages.FAQ?.title || "Preguntes Freq√ºents",
            subtitle: messages.FAQ?.subtitle || "Resolem els teus dubtes.",
            items: messages.FAQ?.items || []
          };
          break;

        case 'cta_banner':
          content = {
            heading: messages.CTA?.heading || "A punt per comen√ßar?",
            subheading: messages.CTA?.subheading || "Uneix-te a nosaltres avui mateix.",
            buttonText: messages.CTA?.button || "Comen√ßar",
            buttonLink: '/booking'
          };
          break;

        case 'featured_products':
          content = {
            title: messages.Shop?.featuredTitle || "Productes Destacats",
            subtitle: messages.Shop?.featuredSubtitle || "Els m√©s venuts.",
            limit: 4
          };
          break;

        default:
          return null;
      }

      return {
        id: `${sectionType}-${index}`,
        type: sectionType as SectionType,
        content
      };
    });

    return sections.filter((s): s is LandingSectionData => s !== null);
  }
}

// =================== FILE: src/repositories/supabase/SupabaseAuthRepository.ts ===================

import { IAuthRepository, AuthResult } from '../interfaces/IAuthRepository';
import { createClient, createAdminClient } from '@/lib/supabase/server';
import { UserProfile, CreateProfileDTO } from '@/types/models';

export class SupabaseAuthRepository implements IAuthRepository {
  
  async signUp(email: string, password: string, meta: { full_name: string; org_id: string }): Promise<AuthResult> {
    const supabase = await createClient();
    const { data, error } = await supabase.auth.signUp({
      email,
      password,
      options: {
        data: { full_name: meta.full_name, org_id: meta.org_id }
      }
    });
    
    return { user: data.user, error };
  }

  async signIn(email: string, password: string): Promise<AuthResult> {
    const supabase = await createClient();
    const { data, error } = await supabase.auth.signInWithPassword({ email, password });
    return { user: data.user, error };
  }

  async signOut(): Promise<void> {
    const supabase = await createClient();
    await supabase.auth.signOut();
  }

  async getProfile(userId: string, orgId: string): Promise<UserProfile | null> {
    const supabase = await createClient();
    // Use maybeSingle per no llan√ßar error 406 si no existeix
    const { data } = await supabase
      .from('profiles')
      .select('*')
      .eq('id', userId)
      .eq('organization_id', orgId)
      .maybeSingle(); 

    if (!data) return null;
    
    // Mapeig segur
    return {
        ...data,
        created_at: new Date(data.created_at || Date.now())
    } as UserProfile;
  }

  async createProfileForce(data: CreateProfileDTO): Promise<void> {
    // ‚ö†Ô∏è AQUI EST√Ä LA CLAU: Usem ADMIN client per saltar RLS
    const supabaseAdmin = createAdminClient();
    
    const { error } = await supabaseAdmin.from('profiles').insert({
        id: data.id,
        email: data.email,
        full_name: data.full_name,
        organization_id: data.organization_id,
        role: data.role || 'client'
    });

    if (error) throw new Error(`Error creant perfil: ${error.message}`);
  }
}

// =================== FILE: src/repositories/supabase/SupabaseBookingRepository.ts ===================

// FITXER: src/features/booking/repositories/SupabaseBookingRepository.ts

import { IBookingRepository } from '../interfaces/IBookingRepository';
import { createClient, createAdminClient } from '@/lib/supabase/server';
import {
  ServiceDTO,
  Booking,
  BookingWithService,
  Schedule, 
  FormField 
} from '@/types/models';
import { format } from 'date-fns';
import { Database, Json } from '@/types/database.types';

type ServiceRow = Database['public']['Tables']['services']['Row'];
type ServiceInsert = Database['public']['Tables']['services']['Insert'];
type BookingRow = Database['public']['Tables']['bookings']['Row'];

type BookingJoinRow = BookingRow & {
  services: {
    title: string;
    duration_minutes?: number; 
  } | null
};

export class SupabaseBookingRepository implements IBookingRepository {

  // Mapper: SQL -> ServiceDTO
  private mapService(row: ServiceRow): ServiceDTO {
    return {
      id: row.id,
      
      // ‚úÖ FIX CR√çTIC 1: Ara organization_id √©s obligatori al Model, l'hem de retornar.
      organization_id: row.organization_id, 
      
      title: row.title,
      description: row.description ?? "",
      duration_minutes: row.duration_minutes ?? 60,
      price: row.price ?? 0,
      
      // ‚úÖ FIX CR√çTIC 2: Mapegem active (si √©s null a DB, assumim true)
      active: row.active ?? true,

      // Valors per defecte (no existeixen a DB encara)
      currency: "EUR", 
      image_url: undefined, 
      
      form_schema: row.form_schema ? (row.form_schema as unknown as FormField[]) : []
    };
  }

  // Mapper: SQL -> Booking
  private mapBooking(row: BookingRow & { services?: { title: string } | null }): Booking {
    return {
      id: row.id,
      organization_id: row.organization_id,
      service_id: row.service_id,
      user_id: row.user_id,
      customer_name: row.customer_name,
      customer_email: row.customer_email,
      start_time: new Date(row.start_time),
      end_time: new Date(row.end_time),
      status: (row.status as Booking['status']) ?? 'pending',
      created_at: new Date(row.created_at ?? Date.now()),
      form_data: (row.form_data as Record<string, unknown>) || {},
      services: row.services
        ? { title: row.services.title, duration_minutes: 0 }
        : undefined
    };
  }

  async getServices(orgId: string): Promise<ServiceDTO[]> {
    const supabase = await createClient();
    const { data, error } = await supabase
      .from('services')
      .select('*')
      .eq('organization_id', orgId)
      .eq('active', true)
      .order('price', { ascending: true });

    if (error) throw new Error(error.message);
    return data.map((row) => this.mapService(row));
  }

  async getServiceById(id: string): Promise<ServiceDTO | null> {
    const supabaseAdmin = createAdminClient();
    const { data } = await supabaseAdmin.from('services').select('*').eq('id', id).single();
    if (!data) return null;
    return this.mapService(data);
  }

  // ‚úÖ M√®tode corregit per complir el contracte estricte
  async createService(serviceData: Omit<ServiceDTO, 'id' | 'created_at'>): Promise<ServiceDTO> {
    const supabase = await createClient();

    // Payload que coincideix amb la teva taula SQL
    const payload: ServiceInsert = {
      organization_id: serviceData.organization_id,
      title: serviceData.title,
      description: serviceData.description,
      price: serviceData.price,
      duration_minutes: serviceData.duration_minutes,
      active: serviceData.active, // ‚úÖ Ara active existeix al DTO d'entrada
      form_schema: serviceData.form_schema as unknown as Json
    };

    const { data, error } = await supabase.from('services').insert(payload).select().single();
    if (error) throw new Error(error.message);
    return this.mapService(data);
  }

  // ... (La resta de m√®todes es queden igual que els tenies abans)
  async deleteService(id: string): Promise<void> {
    const supabase = await createClient();
    await supabase.from('services').delete().eq('id', id);
  }

  async getBookingsByDateRange(orgId: string, start: Date, end: Date): Promise<Booking[]> {
    const supabaseAdmin = createAdminClient();
    const { data, error } = await supabaseAdmin
      .from('bookings')
      .select('*')
      .eq('organization_id', orgId)
      .gte('start_time', start.toISOString())
      .lte('start_time', end.toISOString());

    if (error) throw new Error(error.message);
    return data.map((row) => this.mapBooking(row));
  }

  async createBooking(bookingData: Omit<Booking, 'id' | 'created_at'>): Promise<Booking> {
    const supabase = await createClient();
    const payload = {
      organization_id: bookingData.organization_id,
      service_id: bookingData.service_id,
      customer_name: bookingData.customer_name,
      customer_email: bookingData.customer_email,
      start_time: bookingData.start_time.toISOString(),
      end_time: bookingData.end_time.toISOString(),
      status: bookingData.status,
      user_id: bookingData.user_id,
      form_data: bookingData.form_data as unknown as Json
    };
    const { data, error } = await supabase.from('bookings').insert(payload).select().single();
    if (error) throw new Error(error.message);
    return this.mapBooking(data);
  }

  async getBookings(orgId: string): Promise<Booking[]> {
    const supabase = await createClient();
    const { data, error } = await supabase
      .from('bookings')
      .select('*, services(title, duration_minutes)')
      .eq('organization_id', orgId)
      .order('start_time', { ascending: false });

    if (error) throw new Error(error.message);
    const rows = data as unknown as BookingJoinRow[];
    return rows.map((row) => this.mapBooking(row));
  }

  async getBookingsByUser(userId: string): Promise<BookingWithService[]> {
    const supabase = await createClient();
    const { data } = await supabase
      .from('bookings')
      .select('*, services(title, duration_minutes)')
      .eq('user_id', userId)
      .order('start_time', { ascending: true });
    return (data as unknown as BookingWithService[]) || [];
  }

  async getScheduleForDay(orgId: string, dayOfWeek: number): Promise<Schedule | null> {
    const supabase = await createClient();
    const { data } = await supabase
      .from('schedules')
      .select('*')
      .eq('organization_id', orgId)
      .eq('day_of_week', dayOfWeek)
      .maybeSingle();
    return data as Schedule | null;
  }

  async isDateBlocked(orgId: string, date: Date): Promise<boolean> {
    const supabase = await createClient();
    const dateStr = format(date, 'yyyy-MM-dd');
    const { count } = await supabase
      .from('blocked_dates')
      .select('*', { count: 'exact', head: true })
      .eq('organization_id', orgId)
      .eq('date', dateStr);
    return (count || 0) > 0;
  }
}

// =================== FILE: src/repositories/supabase/SupabaseEcommerceRepository.ts ===================

import { IEcommerceRepository } from '../interfaces/IProductRepository';
import { createClient, createAdminClient } from '@/lib/supabase/server';
import { Product, Order, CreateOrderDTO } from '@/types/models';
import { Database, Json } from '@/types/database.types'; // Importem Json de Supabase
import { CreateProductDTO } from '@/types/models';

type OrderRow = Database['public']['Tables']['orders']['Row'];
type ProductRow = Database['public']['Tables']['products']['Row'];

export class SupabaseEcommerceRepository implements IEcommerceRepository {

  // --- Mappers Privats (La clau per evitar errors de tipus) ---

  private mapProduct(row: ProductRow): Product {
    return {
      id: row.id,
      organization_id: row.organization_id,
      slug: row.slug,
      name: row.name,
      description: row.description,
      price: row.price,
      stock: row.stock ?? 0,
      images: row.images ? (row.images as string[]) : [],
      active: row.active ?? false
    };
  }

  private mapOrder(row: OrderRow): Order {
    return {
      id: row.id,
      organization_id: row.organization_id,
      customer_email: row.customer_email,
      // Convertim la string de la DB a Date de JS
      created_at: new Date(row.created_at || Date.now()),
      total_amount: row.total_amount,
      status: (row.status as Order['status']) || 'pending',
      payment_method: row.payment_method || 'unknown'
    };
  }

  // --- Implementaci√≥ P√∫blica ---

  async getProducts(orgId: string): Promise<Product[]> {
    const supabase = await createClient();
    const { data } = await supabase
      .from('products')
      .select('*')
      .eq('organization_id', orgId)
      .eq('active', true);

    if (!data) return [];
    return data.map(this.mapProduct);
  }

  async getProductBySlug(slug: string, orgId: string): Promise<Product | null> {
    const supabase = await createClient();
    const { data } = await supabase
      .from('products')
      .select('*')
      .eq('organization_id', orgId)
      .eq('slug', slug)
      .single();

    if (!data) return null;
    return this.mapProduct(data);
  }

  async createOrder(data: CreateOrderDTO, orgId: string): Promise<Order> {
    // 1. Obtenim l'usuari actual (si n'hi ha) per vincular-lo
    const supabaseUserClient = await createClient();
    const { data: { user } } = await supabaseUserClient.auth.getUser();

    // 2. Usem el CLIENT ADMIN per escriure a la DB saltant-nos les restriccions RLS
    // Aix√≤ soluciona l'error "violates row-level security" definitivament.
    const supabaseAdmin = createAdminClient();

    const total = data.items.reduce((acc, item) => acc + (item.price * item.quantity), 0);

    const orderPayload = {
      organization_id: orgId,
      user_id: user ? user.id : null, // Si √©s convidat, null. Si est√† loguejat, la seva ID.
      customer_email: data.customer_email,
      customer_details: data.customer_details as unknown as Json,
      total_amount: total,
      payment_method: data.payment_method,
      status: 'pending'
    };

    // 3. Insertar Order (amb permisos de D√©u)
    const { data: orderData, error: orderError } = await supabaseAdmin
      .from('orders')
      .insert(orderPayload)
      .select()
      .single();

    if (orderError) {
      console.error("Error inserint comanda:", orderError);
      throw new Error(orderError.message);
    }

    // 4. Insertar Items
    const itemsPayload = data.items.map(item => ({
      order_id: orderData.id,
      product_id: item.id,
      product_name: item.name,
      quantity: item.quantity,
      unit_price: item.price
    }));

    const { error: itemsError } = await supabaseAdmin
      .from('order_items')
      .insert(itemsPayload);

    if (itemsError) {
      console.error("Error creant items:", itemsError);
      // Opcional: Esborrar la comanda si fallen els items
      await supabaseAdmin.from('orders').delete().eq('id', orderData.id);
      throw new Error("Error guardant els detalls de la comanda");
    }

    return this.mapOrder(orderData);
  }

  async updateStock(productId: string, quantitySold: number): Promise<void> {
    // Ara s√≠ que usem l'admin, perqu√® aix√≤ √©s una operaci√≥ de sistema

    // Exemple de crida RPC (Stored Procedure) que haur√≠em de crear a Supabase
    /*
    const { error } = await admin.rpc('decrement_stock', { 
      p_product_id: productId, 
      p_quantity: quantitySold 
    });
    if (error) console.error(error);
    */
    console.log(`Stock updated for ${productId}: -${quantitySold}`);
  }
  // üëá NOU M√àTODE: Crear Producte
  async createProduct(data: CreateProductDTO & { slug: string }, orgId: string): Promise<Product> {
    const supabase = await createClient();

    const { data: newProduct, error } = await supabase
      .from('products')
      .insert({
        organization_id: orgId,
        name: data.name,
        slug: data.slug, // El slug ve calculat del servei
        description: data.description,
        price: data.price,
        stock: data.stock,
        images: data.images,
        active: data.active
      })
      .select()
      .single();

    if (error) {
      // Gestionem duplicats de slug (molt com√∫)
      if (error.code === '23505') throw new Error("Ja existeix un producte amb aquest nom (slug duplicat).");
      throw new Error(error.message);
    }

    return this.mapProduct(newProduct);
  }
  // üëá IMPLEMENTACI√ì
  async getOrders(orgId: string): Promise<Order[]> {
    const supabase = await createClient();

    // Fem un join per saber quins items hi ha a cada comanda (opcional, aqu√≠ fem fetch b√†sic)
    const { data, error } = await supabase
      .from('orders')
      .select('*') // Podries fer '*, order_items(*)' si volguessis detalls
      .eq('organization_id', orgId)
      .order('created_at', { ascending: false });

    if (error) throw new Error(error.message);

    return data.map(this.mapOrder);
  }

  // Afegeix aquest m√®tode a la classe
  async getOrdersByUser(userId: string): Promise<Order[]> {
    const supabase = await createClient();
    const { data } = await supabase
      .from('orders')
      .select('*, order_items(*)') // Portem els items tamb√©
      .eq('user_id', userId)
      .order('created_at', { ascending: false });

    if (!data) return [];

    // Mapegem (Important per TypeScript)
    return data.map(this.mapOrder); // Assegura't que mapOrder inclou els items si cal
  }
}

// =================== FILE: src/repositories/supabase/SupabasePostRepository.ts ===================

import { IPostRepository } from '../interfaces/IPostRepository';
import { createClient } from '@/lib/supabase/server';
import { BlogPost, CreatePostDTO } from '@/types/models';
import { Database } from '@/types/database.types';

type PostRow = Database['public']['Tables']['posts']['Row'];

export class SupabasePostRepository implements IPostRepository {
  
  private mapPost(row: PostRow): BlogPost {
    return {
      id: row.id,
      organization_id: row.organization_id,
      slug: row.slug,
      title: row.title,
      description: row.description,
      content_mdx: row.content_mdx,
      cover_image: row.cover_image,
      tags: row.tags ? (row.tags as string[]) : [],
      status: (row.status as unknown as import('@/types/models').PostStatus) ?? 'draft',
      published_at: row.published_at ? new Date(row.published_at) : null,
      created_at: new Date(row.created_at ?? Date.now())
    };
  }

  async getPublishedPosts(orgId: string): Promise<BlogPost[]> {
    const supabase = await createClient();
    const { data, error } = await supabase
      .from('posts')
      .select('*')
      .eq('organization_id', orgId)
      .eq('status', 'published')
      .order('published_at', { ascending: false });

    if (error) throw new Error(error.message);
    return data.map(this.mapPost);
  }

  async getPostBySlug(slug: string, orgId: string): Promise<BlogPost | null> {
    const supabase = await createClient();
    const { data } = await supabase
      .from('posts')
      .select('*')
      .eq('organization_id', orgId)
      .eq('slug', slug)
      .eq('status', 'published') // Seguretat: no mostrar esborranys per URL
      .single();

    if (!data) return null;
    return this.mapPost(data);
  }

  async getAllPosts(orgId: string): Promise<BlogPost[]> {
    const supabase = await createClient();
    const { data, error } = await supabase
      .from('posts')
      .select('*')
      .eq('organization_id', orgId)
      .order('created_at', { ascending: false });

    if (error) throw new Error(error.message);
    return data.map(this.mapPost);
  }

  async createPost(data: CreatePostDTO & { organization_id: string; slug: string }): Promise<BlogPost> {
    const supabase = await createClient();
    
    const { data: newPost, error } = await supabase.from('posts').insert({
        organization_id: data.organization_id,
        title: data.title,
        slug: data.slug,
        description: data.description,
        content_mdx: data.content,
        status: data.status || 'draft',
        tags: data.tags || [],
        published_at: data.status === 'published' ? new Date().toISOString() : null
    }).select().single();

    if (error) throw new Error(error.message);
    return this.mapPost(newPost);
  }

  async updatePost(id: string, data: Partial<CreatePostDTO>): Promise<void> {
      const supabase = await createClient();
      
      const payload: Partial<PostRow> = { ...data };
      if (data.content) payload.content_mdx = data.content; // Mapeig de nom
      
      const { error } = await supabase.from('posts').update(payload).eq('id', id);
      if (error) throw new Error(error.message);
  }

  async deletePost(id: string): Promise<void> {
      const supabase = await createClient();
      await supabase.from('posts').delete().eq('id', id);
  }
}

// =================== FILE: src/services/AIService.ts ===================

import { GoogleGenerativeAI, Content } from "@google/generative-ai";
import { CONFIG } from "@/config/digitai.config";

export class AIService {
  // 1. Canviem la propietat per permetre null inicialment
  private genAI: GoogleGenerativeAI | null = null;
  private modelId: string = "gemini-2.0-flash"; 

  constructor() {
    // ‚úÖ CONSTRUCTOR BUIT I SEGUR
    // No fem res aqu√≠ per no trencar el 'npm run build'
  }

  // 2. M√®tode privat per obtenir el client (Lazy)
  private getClient(): GoogleGenerativeAI {
    // Si ja el tenim, el retornem (Singleton pattern)
    if (this.genAI) return this.genAI;

    // Si no, l'inicialitzem ara (Runtime)
    const apiKey = process.env.GEMINI_API_KEY;
    if (!apiKey) {
        // Aquest error nom√©s saltar√† quan l'usuari intenti xatejar, no al build
        throw new Error("‚ùå Manca GEMINI_API_KEY a les variables d'entorn");
    }

    this.genAI = new GoogleGenerativeAI(apiKey);
    return this.genAI;
  }

  async generateChatResponse(history: { role: 'user' | 'assistant', content: string }[], lastMessage: string) {
    try {
      // 3. Obtenim el client de forma segura
      const client = this.getClient();
        
      const model = client.getGenerativeModel({ 
        model: this.modelId,
        systemInstruction: this.buildSystemPrompt() 
      });

      // Convertim l'historial
      const formattedHistory: Content[] = history.map(msg => ({
        role: msg.role === 'assistant' ? 'model' : 'user',
        parts: [{ text: msg.content }]
      }));

      // Sanetjament (Gemini vol que comenci per user)
      if (formattedHistory.length > 0 && formattedHistory[0].role === 'model') {
          formattedHistory.shift();
      }

      const chat = model.startChat({
        history: formattedHistory
      });

      const result = await chat.sendMessage(lastMessage);
      const response = result.response.text();
      
      return response;

    } catch (error) {
      console.error("‚ùå AI Service Error:", error);
      return "Disculpa, estic tenint problemes de connexi√≥. Si us plau, prova-ho m√©s tard.";
    }
  }

  private buildSystemPrompt(): string {
    return `
      Ets l'assistent virtual oficial de ${CONFIG.identity.name}.
      
      CONTEXT DEL NEGOCI:
      - Descripci√≥: ${CONFIG.identity.description}
      - Email de contacte: ${CONFIG.identity.contactEmail}
      - Adre√ßa: ${CONFIG.identity.address || "No especificada"}
      
      FLAGS DE SERVEIS ACTIUS:
      - Botiga Online: ${CONFIG.modules.ecommerce ? 'S√ç' : 'NO'}
      - Reserves/Cites: ${CONFIG.modules.booking ? 'S√ç' : 'NO'}
      
      INSTRUCCIONS:
      1. Sigues amable i professional.
      2. Respon en l'idioma de l'usuari.
      3. Si no ho saps, dirigeix a l'email de contacte.
    `;
  }
}

// =================== FILE: src/services/AuthService.ts ===================

import { IAuthRepository } from '@/repositories/interfaces/IAuthRepository';

type RegisterInput = {
    email: string;
    password: string;
    fullName: string;
    orgId: string;
};

export class AuthService {
    constructor(private repo: IAuthRepository) { }

    async login(email: string, password: string, orgId: string) {
        // 1. Intentem Auth
        const { user, error } = await this.repo.signIn(email, password);
        if (error || !user) {
            throw new Error("Credencials inv√†lides");
        }

        // 2. Verifiquem si t√© "Visat" (Perfil en aquesta org)
        const profile = await this.repo.getProfile(user.id, orgId);

        if (!profile) {
            // No √©s client d'aquesta web. Fora.
            await this.repo.signOut();
            throw new Error("NO_PROFILE"); // Error conegut per nosaltres
        }

        return user;
    }
    // üëá AFEGEIX AQUEST M√àTODE P√öBLIC
    async getProfile(userId: string, orgId: string) {
        return this.repo.getProfile(userId, orgId);
    }
    async register(input: RegisterInput) {
        const { email, password, fullName, orgId } = input;

        // 1. Intentem Registre
        const { user: newUser, error } = await this.repo.signUp(email, password, {
            full_name: fullName,
            org_id: orgId
        });

        // 2. Gesti√≥ d'Errors (L√≤gica Multi-Tenant)
        if (error) {
            // Cas: Usuari ja existeix a la plataforma
            if (error.message.includes("already registered") || error.status === 422) {

                // Intentem login autom√†tic per verificar propietat
                const { user: existingUser, error: loginError } = await this.repo.signIn(email, password);

                if (loginError || !existingUser) {
                    throw new Error("ACCOUNT_EXISTS_WRONG_PASS");
                }

                // √âXIT: L'usuari √©s propietari. Li creem el perfil aqu√≠.
                await this.ensureProfileExists(existingUser.id, email, fullName, orgId);
                return existingUser;
            }

            throw new Error("GENERIC_ERROR");
        }

        // 3. Cas Feli√ß (Usuari nou) -> Assegurar perfil
        if (newUser) {
            // Donem un marge al trigger, o ho fem manualment per seguretat
            await this.ensureProfileExists(newUser.id, email, fullName, orgId);
            return newUser;
        }
    }

    async logout() {
        return this.repo.signOut();
    }

    // Helper privat per garantir que el perfil es crea
    private async ensureProfileExists(userId: string, email: string, name: string, orgId: string) {
        const profile = await this.repo.getProfile(userId, orgId);
        if (!profile) {
            console.log(`Creating profile manually for user ${userId} in org ${orgId}`);
            await this.repo.createProfileForce({
                id: userId,
                email,
                full_name: name,
                organization_id: orgId
            });
        }
    }

    // üëá NOU M√àTODE: Obtenir rol actual
    async getUserRole(userId: string, orgId: string): Promise<'admin' | 'client' | 'lead' | 'staff'> {
        const profile = await this.repo.getProfile(userId, orgId);
        return profile?.role || 'lead'; // Per defecte 'lead' per seguretat
    }

    // üëá NOU M√àTODE: Verificar si √©s admin (Boolean)
    async isAdmin(userId: string, orgId: string): Promise<boolean> {
        const role = await this.getUserRole(userId, orgId);
        return role === 'admin';
    }

    // üëá NOU: Helper per decidir on redirigir segons el rol
    async getRedirectPath(userId: string, orgId: string): Promise<string> {
        const role = await this.getUserRole(userId, orgId);

        switch (role) {
            case 'admin':
            case 'staff': // Els treballadors tamb√© van al dashboard
                return '/dashboard';
            case 'client':
            default:
                return '/my-account'; // Els clients van a la seva √†rea privada
        }
    }
}

// =================== FILE: src/services/BookingService.ts ===================

import { IBookingRepository } from '@/repositories/interfaces/IBookingRepository'; 
import { ServiceDTO as Service, Booking, FormField } from '@/types/models'; 
import { addMinutes, format, set } from 'date-fns';

// DTOs d'entrada (Input Models) espec√≠fics per al cas d'√∫s
type NewServiceInput = {
  title: string;
  description: string | null;
  price: number;
  duration: number;
  form_schema?: FormField[];
};

type NewBookingInput = {
  serviceId: string;
  name: string;
  email: string;
  date: string; 
  time: string; 
  userId?: string;
  formData?: Record<string, unknown>;
};

export class BookingService {
  constructor(private repo: IBookingRepository) { }

  async getAllServices(orgId: string): Promise<Service[]> {
    return this.repo.getServices(orgId);
  }

  async createNewService(data: NewServiceInput, orgId: string): Promise<Service> {
    // Validacions de Negoci (Domain Logic)
    if (data.price < 0) throw new Error("El preu no pot ser negatiu");
    if (data.duration < 5) throw new Error("La durada m√≠nima s√≥n 5 minuts");

    // Ara TypeScript est√† feli√ß perqu√® 'organization_id' √©s part esperada de ServiceDTO
    return this.repo.createService({
      organization_id: orgId,
      title: data.title,
      // Gesti√≥ de nuls a nivell de servei per assegurar consist√®ncia
      description: data.description ?? "", 
      price: data.price,
      duration_minutes: data.duration,
      // Valors per defecte de domini
      active: true, 
      form_schema: data.form_schema || [],
      // Camps opcionals que el repo gestionar√† (per√≤ que el tipus permet)
      currency: "EUR",
      image_url: undefined
    });
  }

  async processBooking(data: NewBookingInput, orgId: string): Promise<Booking> {
    // Validaci√≥
    if (!data.email.includes('@')) throw new Error("Email inv√†lid");

    const startTime = new Date(`${data.date}T${data.time}:00`);
    
    // Recuperem el servei per saber la durada real
    const service = await this.repo.getServiceById(data.serviceId);
    if (!service) throw new Error("Servei no v√†lid");

    // C√†lcul de domini: EndTime
    const duration = service.duration_minutes ?? 60;
    const endTime = addMinutes(startTime, duration);

    return this.repo.createBooking({
      organization_id: orgId,
      service_id: data.serviceId,
      customer_name: data.name,
      customer_email: data.email,
      start_time: startTime,
      end_time: endTime,
      status: 'confirmed', // O 'pending' si hi ha pagament
      user_id: data.userId || null,
      form_data: data.formData || {}
    });
  }

  async getDashboardBookings(orgId: string): Promise<Booking[]> {
    return this.repo.getBookings(orgId);
  }

  async getBookingsByUser(userId: string) {
    return this.repo.getBookingsByUser(userId);
  }

  async getAvailableSlots(dateStr: string, serviceId: string, orgId: string): Promise<string[]> {
    const targetDate = new Date(dateStr);
    const dayOfWeek = targetDate.getDay(); 

    // 1. Comprovar Bloquejos globals
    const isBlocked = await this.repo.isDateBlocked(orgId, targetDate);
    if (isBlocked) return [];

    // 2. Comprovar Horari base
    const schedule = await this.repo.getScheduleForDay(orgId, dayOfWeek);
    if (!schedule || !schedule.is_active) return []; 

    // 3. Recuperar dades per calcular col¬∑lisions
    const bookings = await this.repo.getBookingsByDateRange(orgId, targetDate, targetDate);
    const service = await this.repo.getServiceById(serviceId);
    if (!service) throw new Error("Servei no trobat");

    const slots: string[] = [];
    const openTime = this.parseTime(targetDate, schedule.start_time);
    const closeTime = this.parseTime(targetDate, schedule.end_time);
    
    const serviceDuration = service.duration_minutes ?? 60;
    let currentTime = openTime;

    // Algoritme de Slots
    while (addMinutes(currentTime, serviceDuration) <= closeTime) {
      const slotEnd = addMinutes(currentTime, serviceDuration);
      
      const isBusy = bookings.some(b => {
        const bStart = new Date(b.start_time);
        const bEnd = new Date(b.end_time);
        // Intersecci√≥ d'intervals
        return (currentTime < bEnd && slotEnd > bStart);
      });

      if (!isBusy) {
        slots.push(format(currentTime, 'HH:mm'));
      }

      currentTime = addMinutes(currentTime, 30); // Pas de 30 minuts
    }

    return slots;
  }

  private parseTime(date: Date, timeStr: string): Date {
    const [hours, minutes] = timeStr.split(':').map(Number);
    return set(date, { hours, minutes, seconds: 0, milliseconds: 0 });
  }
}

// =================== FILE: src/services/container.ts ===================

import 'server-only';

// --- 1. Imports de Repositoris i Serveis ---
import { SupabaseBookingRepository } from '@/repositories/supabase/SupabaseBookingRepository';
import { SupabaseAuthRepository } from '@/repositories/supabase/SupabaseAuthRepository';
import { StaticContentRepository } from '@/repositories/static/StaticContentRepository';
import { SupabasePostRepository } from '@/repositories/supabase/SupabasePostRepository';
import { SupabaseEcommerceRepository } from '@/repositories/supabase/SupabaseEcommerceRepository';

import { EcommerceService } from '@/services/EcommerceService';
import { AIService } from '@/services/AIService';
import { BookingService } from '@/services/BookingService';
import { AuthService } from '@/services/AuthService';
import { MarketingService } from '@/services/MarketingService';
import { PostService } from '@/services/PostService';

// --- 2. Container Class (Singleton & Lazy Internal) ---
class ServiceContainer {
  private static instance: ServiceContainer;

  private _bookingService: BookingService | null = null;
  private _authService: AuthService | null = null;
  private _marketingService: MarketingService | null = null;
  private _postService: PostService | null = null;
  private _ecommerceService: EcommerceService | null = null;
  private _aiService: AIService | null = null;

  private constructor() {}

  public static getInstance(): ServiceContainer {
    if (!ServiceContainer.instance) {
      ServiceContainer.instance = new ServiceContainer();
    }
    return ServiceContainer.instance;
  }

  // --- Getters amb Lazy Loading ---

  public get bookingService(): BookingService {
    if (!this._bookingService) {
      this._bookingService = new BookingService(new SupabaseBookingRepository());
    }
    return this._bookingService;
  }

  public get authService(): AuthService {
    if (!this._authService) {
      this._authService = new AuthService(new SupabaseAuthRepository());
    }
    return this._authService;
  }

  public get marketingService(): MarketingService {
    if (!this._marketingService) {
      this._marketingService = new MarketingService(new StaticContentRepository());
    }
    return this._marketingService;
  }

  public get postService(): PostService {
    if (!this._postService) {
      this._postService = new PostService(new SupabasePostRepository());
    }
    return this._postService;
  }

  public get ecommerceService(): EcommerceService {
    if (!this._ecommerceService) {
      this._ecommerceService = new EcommerceService(new SupabaseEcommerceRepository());
    }
    return this._ecommerceService;
  }

  public get aiService(): AIService {
    if (!this._aiService) {
      this._aiService = new AIService();
    }
    return this._aiService;
  }
}

const container = ServiceContainer.getInstance();

// --- 3. EXPORTS "M√ÄGICS" (Proxies) ---
// Aixo permet mantenir els imports antics sense trencar el build

function createLazyProxy<T extends object>(getter: () => T): T {
  return new Proxy({} as T, {
    get: (_target, prop) => {
      // Quan alg√∫ fa 'service.metode()', obtenim la inst√†ncia real del container
      const instance = getter();
      const value = instance[prop as keyof T];
      
      // Si √©s una funci√≥, la lliguem a la inst√†ncia original per no perdre el 'this'
      return typeof value === 'function' ? value.bind(instance) : value;
    }
  });
}

// Ara exportem les constants que la resta de l'app espera, per√≤ s√≥n Proxies mandrosos
export const bookingService = createLazyProxy(() => container.bookingService);
export const authService = createLazyProxy(() => container.authService);
export const marketingService = createLazyProxy(() => container.marketingService);
export const postService = createLazyProxy(() => container.postService);
export const ecommerceService = createLazyProxy(() => container.ecommerceService);
export const aiService = createLazyProxy(() => container.aiService);

// Tamb√© exportem el container per si alg√∫ el vol fer servir directament
export { container };

// =================== FILE: src/services/EcommerceService.ts ===================

import { IEcommerceRepository } from '@/repositories/interfaces/IProductRepository';
import { CreateOrderDTO, Order, CreateProductDTO } from '@/types/models'; // üëà Importem Order
import { StripeGateway } from '@/lib/payment/stripe-gateway'; // üëà Importem


export class EcommerceService {
  private stripeGateway: StripeGateway;
  constructor(private repo: IEcommerceRepository) {
    // En una V2, aix√≤ s'injectaria, per√≤ per ara ho instanciem aqu√≠ (Lazy loading)
    this.stripeGateway = new StripeGateway();
  }

  async getStoreProducts(orgId: string) {
    return this.repo.getProducts(orgId);
  }

  async processCheckout(data: CreateOrderDTO, orgId: string) {
    // üõ°Ô∏è VALIDACI√ì ESTOC SERVER-SIDE
    // Abans de crear la comanda, comprovem que hi hagi estoc real a la DB
    for (const item of data.items) {
      const productInDb = await this.repo.getProductBySlug(item.slug, orgId); // O getById millor
      if (!productInDb) throw new Error(`El producte ${item.name} ja no existeix.`);

      if (productInDb.stock < item.quantity) {
        throw new Error(`Estoc insuficient per a ${item.name}. Nom√©s queden ${productInDb.stock} unitats.`);
      }
    }

    // 1. Crear comanda "Pending"
    const order = await this.repo.createOrder(data, orgId);

    // 2. Estrat√®gia de Pagament
    switch (data.payment_method) {
      case 'stripe':
        // üëá CRIDA REAL A STRIPE
        const result = await this.stripeGateway.createCheckoutSession(order, data.items);
        return { redirectUrl: result.redirectUrl };

      case 'paypal':
        return this.handlePaypalPayment(order);

      case 'bank':
        return { redirectUrl: `/checkout/success?orderId=${order.id}&method=bank` };

      default:
        throw new Error("M√®tode de pagament no suportat");
    }
  }
  // üëá NOU: L√≤gica de creaci√≥
  async createNewProduct(data: CreateProductDTO, orgId: string) {
    // 1. Generar Slug (SEO Friendly)
    const slug = data.name
      .toLowerCase()
      .trim()
      .replace(/[^\w\s-]/g, '') // Treure car√†cters especials
      .replace(/[\s_-]+/g, '-') // Espais a guions
      .replace(/^-+|-+$/g, ''); // Treure guions sobrants

    // 2. Validacions de negoci
    if (data.price < 0) throw new Error("El preu no pot ser negatiu.");
    if (data.stock < 0) throw new Error("L'estoc no pot ser negatiu.");

    // 3. Persist√®ncia
    return this.repo.createProduct({ ...data, slug }, orgId);
  }

  // üëá AFEGIT: M√®tode que faltava
  async getProductBySlug(slug: string, orgId: string) {
    return this.repo.getProductBySlug(slug, orgId);
  }

  // üëá Substitu√Øm 'any' per 'Order'
  private async handleStripePayment(order: Order) {
    console.log("Iniciant sessi√≥ Stripe per comanda:", order.id);

    // Aqu√≠ aniria la l√≤gica real de Stripe
    // const session = await stripe.checkout.sessions.create({
    //    customer_email: order.customer_email,
    //    ...
    // })

    // Mock per MVP:
    return { redirectUrl: `/checkout/success?orderId=${order.id}&method=stripe_mock` };
  }

  // üëá Substitu√Øm 'any' per 'Order'
  private async handlePaypalPayment(order: Order) {
    console.log("Iniciant sessi√≥ PayPal per comanda:", order.id);
    return { redirectUrl: `/checkout/success?orderId=${order.id}&method=paypal_mock` };
  }

  async getAdminOrders(orgId: string) {
    return this.repo.getOrders(orgId);
  }

  async getOrdersByUser(userId: string) {
    // Aqu√≠ podries afegir l√≤gica extra (ex: amagar comandes cancel¬∑lades)
    return this.repo.getOrdersByUser(userId);
  }

}

// =================== FILE: src/services/MarketingService.ts ===================

import { IContentRepository } from '@/repositories/interfaces/IContentRepository';

export class MarketingService {
  constructor(private repo: IContentRepository) {}

  async getLandingPageData(locale: string) {
    return this.repo.getLandingSections(locale);
  }
}

// =================== FILE: src/services/PostService.ts ===================

import { IPostRepository } from '@/repositories/interfaces/IPostRepository';
import { CreatePostDTO } from '@/types/models';

export class PostService {
  constructor(private repo: IPostRepository) {}

  // 1. Llegir (P√∫blic)
  async getPublicPosts(orgId: string) {
    return this.repo.getPublishedPosts(orgId);
  }

  async getPostBySlug(slug: string, orgId: string) {
    return this.repo.getPostBySlug(slug, orgId);
  }

  // 2. Llegir (Privat)
  async getDashboardPosts(orgId: string) {
    return this.repo.getAllPosts(orgId);
  }

  // 3. Escriptura amb L√≤gica
  async createNewPost(data: CreatePostDTO, orgId: string) {
    // Generar Slug autom√†tic (Ex: "El meu t√≠tol" -> "el-meu-titol")
    const slug = data.title
        .toLowerCase()
        .normalize("NFD").replace(/[\u0300-\u036f]/g, "") // Treure accents
        .replace(/[^a-z0-9]+/g, '-') // Car√†cters rars a guions
        .replace(/^-+|-+$/g, ''); // Treure guions extres

    // Afegir sufix aleatori si vols evitar col¬∑lisions (opcional per MVP)
    // const uniqueSlug = `${slug}-${Math.floor(Math.random() * 1000)}`;

    return this.repo.createPost({
        ...data,
        organization_id: orgId,
        slug: slug
    });
  }

  async deletePost(id: string) {
      return this.repo.deletePost(id);
  }
}

// =================== FILE: src/services/__tests__/ai.service.test.ts ===================

import { describe, it, expect, vi, beforeEach } from 'vitest';
import { AIService } from '../AIService';

// Spies globals
const mockResponseText = vi.fn();
const mockSendMessage = vi.fn();
const mockStartChat = vi.fn();
const mockGetModel = vi.fn();

// ‚úÖ FIX: Utilitzem 'vi.fn(function() { ... })' en lloc de '() => {}'
// Aix√≤ permet que 'new GoogleGenerativeAI()' funcioni.
vi.mock('@google/generative-ai', () => {
  return {
    GoogleGenerativeAI: vi.fn(function() {
      return {
        getGenerativeModel: mockGetModel
      };
    })
  };
});

describe('AIService Logic', () => {
  let service: AIService;

  beforeEach(() => {
    vi.clearAllMocks();
    
    // Configurar retorns
    mockResponseText.mockReturnValue('Resposta de la IA');
    
    mockSendMessage.mockResolvedValue({
      response: { text: mockResponseText }
    });
    
    mockStartChat.mockReturnValue({
      sendMessage: mockSendMessage
    });
    
    mockGetModel.mockReturnValue({
      startChat: mockStartChat
    });

    service = new AIService();
  });

  it('hauria de inicialitzar-se correctament', () => {
    expect(service).toBeDefined();
  });

  it('hauria de sanejar l\'historial (eliminar primer missatge si √©s assistant)', async () => {
    const history = [
      { role: 'assistant' as const, content: 'Hola!' },
      { role: 'user' as const, content: 'Pregunta 1' }
    ];
    await service.generateChatResponse(history, 'Pregunta 2');

    expect(mockStartChat).toHaveBeenCalledWith(expect.objectContaining({
      history: [{ role: 'user', parts: [{ text: 'Pregunta 1' }] }]
    }));
  });

  it('hauria de retornar la resposta del model', async () => {
    const response = await service.generateChatResponse([], 'Hola');
    expect(response).toBe('Resposta de la IA');
  });

  it('hauria de gestionar errors', async () => {
    mockSendMessage.mockRejectedValue(new Error('Fail'));
    const response = await service.generateChatResponse([], 'Hola');
    expect(response).toContain('problemes de connexi√≥');
  });
});

// =================== FILE: src/services/__tests__/booking.service.test.ts ===================

import { describe, it, expect, vi, beforeEach } from 'vitest';
import { BookingService } from '../BookingService'; 
import { IBookingRepository } from '@/repositories/interfaces/IBookingRepository';
import { Service, Schedule, Booking } from '@/types/models';

// Definim un tipus Mocked segur
type MockBookingRepository = {
  [K in keyof IBookingRepository]: ReturnType<typeof vi.fn>;
};

// 1. Creem el Mock del Repositori sense 'any'
const mockRepo = {
  getServices: vi.fn(),
  getServiceById: vi.fn(),
  createService: vi.fn(),
  createBooking: vi.fn(),
  getBookings: vi.fn(),
  getBookingsByUser: vi.fn(),
  isDateBlocked: vi.fn(),
  getScheduleForDay: vi.fn(),
  getBookingsByDateRange: vi.fn(),
} as unknown as MockBookingRepository;

describe('BookingService Logic', () => {
  let service: BookingService;
  const orgId = 'test-org';

  beforeEach(() => {
    vi.clearAllMocks();
    // Injectem el mock tipat com si fos el real
    service = new BookingService(mockRepo as unknown as IBookingRepository);
  });

  // --- BLOC 1: Validacions de Creaci√≥ ---
  describe('createNewService', () => {
    it('hauria de llan√ßar error amb preus negatius', async () => {
      // utilitzem 'expect.assertions' per assegurar que el test no passa si no falla
      expect.assertions(1);
      
      await expect(service.createNewService({
        title: 'Test', description: '', price: -10, duration: 30
      }, orgId)).rejects.toThrow("El preu no pot ser negatiu");
    });

    it('hauria de crear el servei si tot √©s correcte', async () => {
      const input = { title: 'Tallada', description: 'Simple', price: 15, duration: 30 };
      
      // Constru√Øm la resposta esperada sense 'any'
      const mockResponse: Service = {
        id: '1',
        organization_id: orgId,
        title: input.title,
        description: input.description,
        price: input.price,
        duration_minutes: input.duration,
        active: true,
        form_schema: [],
        created_at: new Date(),
        // üö´ FIX: Eliminat updated_at perqu√® no existeix a la interf√≠cie Service
      };

      vi.mocked(mockRepo.createService).mockResolvedValue(mockResponse);

      const result = await service.createNewService(input, orgId);

      expect(mockRepo.createService).toHaveBeenCalledWith(expect.objectContaining({
        title: 'Tallada',
        price: 15
      }));
      expect(result.id).toBe('1');
    });
  });

  // --- BLOC 2: Proc√©s de Reserva ---
  describe('processBooking', () => {
    it('hauria de calcular correctament la data final (endTime)', async () => {
      const input = {
        serviceId: 's1', name: 'Pep', email: 'pep@test.com',
        date: '2023-10-10', time: '10:00'
      };

      // Mock del servei
      const mockService: Service = {
        id: 's1', 
        duration_minutes: 60, 
        title: 'Massatge',
        organization_id: orgId,
        description: '',
        price: 50,
        active: true,
        form_schema: [],
        created_at: new Date(),
        // üö´ FIX: Eliminat updated_at
      };
      
      vi.mocked(mockRepo.getServiceById).mockResolvedValue(mockService);

      // Mock de creaci√≥ de booking
      vi.mocked(mockRepo.createBooking).mockImplementation(async (data) => ({
        ...data,
        id: 'b1',
        created_at: new Date(),
        services: null 
      } as Booking));

      const result = await service.processBooking(input, orgId);

      // Verifiquem matem√†tiques de dates
      const expectedStart = new Date('2023-10-10T10:00:00');
      const expectedEnd = new Date('2023-10-10T11:00:00'); // 10:00 + 60min

      expect(result.start_time).toEqual(expectedStart);
      expect(result.end_time).toEqual(expectedEnd);
    });
  });

  // --- BLOC 3: Algoritme d'Slots ---
  describe('getAvailableSlots', () => {
    const dateStr = '2023-10-10'; 

    it('hauria de retornar buit si el dia est√† bloquejat', async () => {
      vi.mocked(mockRepo.isDateBlocked).mockResolvedValue(true);
      const slots = await service.getAvailableSlots(dateStr, 's1', orgId);
      expect(slots).toEqual([]);
    });

    it('hauria de calcular slots lliures sense solapaments', async () => {
      // 1. Setup
      vi.mocked(mockRepo.isDateBlocked).mockResolvedValue(false);
      
      const mockSchedule: Schedule = {
        id: 'sch1',
        day_of_week: 2,
        start_time: '09:00:00',
        end_time: '11:00:00',
        is_active: true
      };
      vi.mocked(mockRepo.getScheduleForDay).mockResolvedValue(mockSchedule);

      const mockService: Service = {
        id: 's1', 
        duration_minutes: 60,
        organization_id: orgId,
        title: 'Test',
        description: null,
        price: 10,
        active: true,
        form_schema: [],
        created_at: new Date(),
        // üö´ FIX: Eliminat updated_at
      };
      vi.mocked(mockRepo.getServiceById).mockResolvedValue(mockService);

      // RESERVA EXISTENT: 09:00 - 10:00
      const existingBooking: Booking = {
        id: 'b_old',
        organization_id: orgId,
        service_id: 's1',
        customer_name: 'Existing',
        customer_email: 'ex@test.com',
        start_time: new Date('2023-10-10T09:00:00'),
        end_time: new Date('2023-10-10T10:00:00'),
        status: 'confirmed',
        user_id: null,
        created_at: new Date(),
        form_data: {}
      };
      vi.mocked(mockRepo.getBookingsByDateRange).mockResolvedValue([existingBooking]);

      // 2. Execuci√≥
      const slots = await service.getAvailableSlots(dateStr, 's1', orgId);

      // 3. Verificaci√≥
      expect(slots).toContain('10:00');
      expect(slots).not.toContain('09:00');
    });
  });
});

// =================== FILE: src/services/__tests__/cart.service.test.ts ===================

import { describe, it, expect } from 'vitest';

// Simulem una interf√≠cie de l√≤gica de negoci (pots adaptar-la al teu CartService real)
interface CartItem {
  id: string;
  price: number;
  quantity: number;
}

// Funci√≥ pura (L√≤gica de negoci) que volem testejar
const calculateTotal = (items: CartItem[], taxRate: number): number => {
  const subtotal = items.reduce((acc, item) => acc + item.price * item.quantity, 0);
  return subtotal + (subtotal * taxRate);
};

describe('CartService Business Logic', () => {
  it('hauria de calcular correctament el total amb impostos', () => {
    // 1. Arrange (Preparar dades)
    const mockItems: CartItem[] = [
      { id: '1', price: 100, quantity: 2 }, // 200
      { id: '2', price: 50, quantity: 1 },  // 50
    ];
    const taxRate = 0.21; // 21% IVA

    // 2. Act (Executar)
    const total = calculateTotal(mockItems, taxRate);

    // 3. Assert (Verificar)
    // 250 + (250 * 0.21) = 250 + 52.5 = 302.5
    expect(total).toBe(302.5);
  });

  it('hauria de retornar 0 si la cistella √©s buida', () => {
    const total = calculateTotal([], 0.21);
    expect(total).toBe(0);
  });
});

// =================== FILE: src/test/mocks/supabase.ts ===================

import { vi } from 'vitest';
import { PostgrestError } from '@supabase/supabase-js';

// Mock base de Supabase
export const mockSupabase = {
  from: vi.fn().mockReturnThis(),
  select: vi.fn().mockReturnThis(),
  insert: vi.fn().mockReturnThis(),
  update: vi.fn().mockReturnThis(),
  delete: vi.fn().mockReturnThis(),
  eq: vi.fn().mockReturnThis(),
  single: vi.fn(),
  order: vi.fn().mockReturnThis(),
  limit: vi.fn().mockReturnThis(),
};

// Interface per a la resposta de Supabase
interface SupabaseResponse<T> {
  data: T | null;
  error: PostgrestError | null;
}

// Helper tipat amb Generics <T>
export const mockSupabaseResponse = <T>(data: T): SupabaseResponse<T> => ({
  data,
  error: null,
});

// Helper d'error tipat corregit
export const mockSupabaseError = (message: string, code = '400'): SupabaseResponse<null> => ({
  data: null,
  error: {
    message,
    code,
    details: '',
    hint: '',
    name: 'PostgrestError', // üëà AFEGEIX AQUESTA L√çNIA
  },
});

// =================== FILE: src/test/setup.ts ===================

import '@testing-library/jest-dom';
import { vi } from 'vitest';

// ---------------------------------------------------------------------------
// üåç 1. SETUP D'ENTORN (MOCKS DE VARIABLES)
// ---------------------------------------------------------------------------

// SUPABASE MOCKS
process.env.NEXT_PUBLIC_SUPABASE_URL = 'https://test-project.supabase.co';
process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY = 'test-anon-key-123456789';
process.env.NEXT_PUBLIC_ORG_ID = 'test-org-uuid-v4';
process.env.SUPABASE_SERVICE_ROLE_KEY = 'test-service-role-key';

// STRIPE MOCKS
process.env.STRIPE_SECRET_KEY = 'sk_test_mock_key_12345'; 
process.env.STRIPE_WEBHOOK_SECRET = 'whsec_mock_secret_12345';

// GEMINI / GOOGLE AI MOCKS (üëá AFEGIT)
process.env.GEMINI_API_KEY = 'fake-gemini-key-for-testing';

// ---------------------------------------------------------------------------
// üõ†Ô∏è 2. MOCKS GLOBALS DEL NAVEGADOR
// ---------------------------------------------------------------------------

global.ResizeObserver = class ResizeObserver {
  observe() {}
  unobserve() {}
  disconnect() {}
};

Object.defineProperty(window, 'matchMedia', {
  writable: true,
  value: vi.fn().mockImplementation(query => ({
    matches: false,
    media: query,
    onchange: null,
    addListener: vi.fn(), 
    removeListener: vi.fn(), 
    addEventListener: vi.fn(),
    removeEventListener: vi.fn(),
    dispatchEvent: vi.fn(),
  })),
});

// =================== FILE: src/types/ActionResult.ts ===================

export type ActionResult = {
  success?: boolean;
  error?: string;
  repoUrl?: string;
};

// =================== FILE: src/types/config.ts ===================

// PROJECTE: Master Template
// FITXER: src/types/config.ts

// ==========================================
// 1. Definicions de Seccions Permeses
// ==========================================

// üëá AQUEST √âS EL TIPUS CLAU QUE NECESSITES EXPORTAR
export type ConfigLandingSection = 
  | 'hero' 
  | 'features' 
  | 'services' 
  | 'contact' 
  | 'testimonials' 
  | 'map' 
  | 'stats' 
  | 'faq' 
  | 'cta_banner' 
  | 'featured_products' 
  | 'about';

// ==========================================
// 2. Configuraci√≥ de Contingut Est√†tic (Inputs del Config)
// ==========================================

export interface AboutConfigInput {
  title?: string;
  description?: string;
  image_url?: string;
  stats?: Array<{ label: string; value: string }>;
}

export interface HeroConfigInput {
  title?: string;
  subtitle?: string;
  cta?: string;
}
// üëá AFEGIM AIX√í: Estructura per guardar items generats per IA
export interface AIItem {
  title: string;
  description: string;
  icon?: string; // Opcional, per si la IA suggereix icona
}
// üëá AFEGEIX AIX√í (Recuperem l'estructura perduda)
export interface ServicesIntroConfigInput {
  title: string;
  subtitle: string;
  items?: AIItem[]; // üëà Llista de serveis generats
}

// üëá MODIFICA AIX√í
export interface StaticContentConfig {
  hero?: HeroConfigInput;
  about?: AboutConfigInput;
  services_intro?: ServicesIntroConfigInput;
  // ‚úÖ NOU CAMP
  testimonials?: {
    title: string;
    subtitle: string;
    items: TestimonialItem[];
  };
}
// ==========================================
// 3. Estructures Auxiliars
// ==========================================
export type ModuleStatus = boolean;

export interface FooterLink {
  label: string;
  href: string;
}

export interface FooterColumn {
  title: string;
  links: FooterLink[];
}

export interface SiteFooterConfig {
  columns: FooterColumn[];
  socials?: Record<string, string>;
  bottomText: string;
}

export interface SiteIdentity {
  name: string;
  description: string;
  logoUrl: string;
  faviconUrl: string;
  contactEmail: string;
  address?: string;
}

export interface SiteBranding {
  colors: {
    primary: string;
    secondary: string;
    background: string;
    foreground: string;
  };
  radius: number;
}

// ==========================================
// 4. Configuraci√≥ de M√≤duls
// ==========================================
export interface SiteModules {
  layout: {
    variant: 'modern' | 'shop';
    stickyHeader: boolean;
  };

  landing: {
    active: boolean;
    // üëá AQUI UTILITZEM EL TIPUS STRICTE
    sections: ConfigLandingSection[];
  };

  auth: {
    active: boolean;
    allowPublicRegistration: boolean;
    redirects: {
      admin: string;
      client: string;
    };
  };

  dashboard: ModuleStatus;
  booking: ModuleStatus;
  ecommerce: ModuleStatus;
  blog: ModuleStatus;
  inventory: ModuleStatus;
  accessControl: ModuleStatus;
  chatbot: ModuleStatus;
}

export interface I18nConfig {
  locales: string[];
  defaultLocale: string;
}
// üëá AFEGEIX AIX√í
export interface TestimonialItem {
  text: string;
  author: string;
  role: string; // Ex: "Client habitual" o "Cr√≠tic gastron√≤mic"
  rating: number;
}
// ==========================================
// üß† CONFIGURACI√ì MESTRA (MASTER CONFIG)
// ==========================================
export interface MasterConfig {
  organizationId?: string;
  identity: SiteIdentity;
  branding: SiteBranding;
  modules: SiteModules;
  i18n: I18nConfig;
  footer: SiteFooterConfig;
  
  // Contingut opcional definit al config
  content?: StaticContentConfig;
}

// =================== FILE: src/types/database.types.ts ===================

export type Json =
  | string
  | number
  | boolean
  | null
  | { [key: string]: Json | undefined }
  | Json[]

export type Database = {
  // Allows to automatically instantiate createClient with right options
  // instead of createClient<Database, { PostgrestVersion: 'XX' }>(URL, KEY)
  __InternalSupabase: {
    PostgrestVersion: "13.0.5"
  }
  public: {
    Tables: {
      analytics_events: {
        Row: {
          browser: string | null
          city: string | null
          country: string | null
          created_at: string | null
          device_type: string | null
          duration_seconds: number | null
          event_name: string
          id: number
          meta: Json | null
          os: string | null
          path: string | null
          referrer: string | null
          session_id: string
        }
        Insert: {
          browser?: string | null
          city?: string | null
          country?: string | null
          created_at?: string | null
          device_type?: string | null
          duration_seconds?: number | null
          event_name: string
          id?: never
          meta?: Json | null
          os?: string | null
          path?: string | null
          referrer?: string | null
          session_id: string
        }
        Update: {
          browser?: string | null
          city?: string | null
          country?: string | null
          created_at?: string | null
          device_type?: string | null
          duration_seconds?: number | null
          event_name?: string
          id?: never
          meta?: Json | null
          os?: string | null
          path?: string | null
          referrer?: string | null
          session_id?: string
        }
        Relationships: []
      }
      analytics_visitors: {
        Row: {
          country: string | null
          device_type: string | null
          first_seen_at: string | null
          last_seen_at: string | null
          referrer: string | null
          visitor_id: string
        }
        Insert: {
          country?: string | null
          device_type?: string | null
          first_seen_at?: string | null
          last_seen_at?: string | null
          referrer?: string | null
          visitor_id: string
        }
        Update: {
          country?: string | null
          device_type?: string | null
          first_seen_at?: string | null
          last_seen_at?: string | null
          referrer?: string | null
          visitor_id?: string
        }
        Relationships: []
      }
      blocked_dates: {
        Row: {
          created_at: string | null
          date: string
          id: string
          organization_id: string
          reason: string | null
        }
        Insert: {
          created_at?: string | null
          date: string
          id?: string
          organization_id: string
          reason?: string | null
        }
        Update: {
          created_at?: string | null
          date?: string
          id?: string
          organization_id?: string
          reason?: string | null
        }
        Relationships: [
          {
            foreignKeyName: "blocked_dates_organization_id_fkey"
            columns: ["organization_id"]
            isOneToOne: false
            referencedRelation: "organizations"
            referencedColumns: ["id"]
          },
        ]
      }
      bookings: {
        Row: {
          created_at: string | null
          customer_email: string
          customer_name: string
          end_time: string
          form_data: Json | null
          id: string
          organization_id: string
          service_id: string
          start_time: string
          status: string | null
          user_id: string | null
        }
        Insert: {
          created_at?: string | null
          customer_email: string
          customer_name: string
          end_time: string
          form_data?: Json | null
          id?: string
          organization_id: string
          service_id: string
          start_time: string
          status?: string | null
          user_id?: string | null
        }
        Update: {
          created_at?: string | null
          customer_email?: string
          customer_name?: string
          end_time?: string
          form_data?: Json | null
          id?: string
          organization_id?: string
          service_id?: string
          start_time?: string
          status?: string | null
          user_id?: string | null
        }
        Relationships: [
          {
            foreignKeyName: "bookings_organization_id_fkey"
            columns: ["organization_id"]
            isOneToOne: false
            referencedRelation: "organizations"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "bookings_service_id_fkey"
            columns: ["service_id"]
            isOneToOne: false
            referencedRelation: "services"
            referencedColumns: ["id"]
          },
        ]
      }
      contact_leads: {
        Row: {
          created_at: string
          email: string
          full_name: string
          id: string
          message: string
          service: string
          source: string | null
        }
        Insert: {
          created_at?: string
          email: string
          full_name: string
          id?: string
          message: string
          service: string
          source?: string | null
        }
        Update: {
          created_at?: string
          email?: string
          full_name?: string
          id?: string
          message?: string
          service?: string
          source?: string | null
        }
        Relationships: []
      }
      content_queue: {
        Row: {
          created_at: string | null
          generated_mdx: string | null
          id: string
          image_prompt: string | null
          organization_id: string
          prompt_context: string | null
          status: Database["public"]["Enums"]["content_status"] | null
          target_keywords: string[] | null
          topic: string
        }
        Insert: {
          created_at?: string | null
          generated_mdx?: string | null
          id?: string
          image_prompt?: string | null
          organization_id: string
          prompt_context?: string | null
          status?: Database["public"]["Enums"]["content_status"] | null
          target_keywords?: string[] | null
          topic: string
        }
        Update: {
          created_at?: string | null
          generated_mdx?: string | null
          id?: string
          image_prompt?: string | null
          organization_id?: string
          prompt_context?: string | null
          status?: Database["public"]["Enums"]["content_status"] | null
          target_keywords?: string[] | null
          topic?: string
        }
        Relationships: [
          {
            foreignKeyName: "content_queue_organization_id_fkey"
            columns: ["organization_id"]
            isOneToOne: false
            referencedRelation: "organizations"
            referencedColumns: ["id"]
          },
        ]
      }
      order_items: {
        Row: {
          id: string
          order_id: string
          product_id: string | null
          product_name: string
          quantity: number
          unit_price: number
        }
        Insert: {
          id?: string
          order_id: string
          product_id?: string | null
          product_name: string
          quantity: number
          unit_price: number
        }
        Update: {
          id?: string
          order_id?: string
          product_id?: string | null
          product_name?: string
          quantity?: number
          unit_price?: number
        }
        Relationships: [
          {
            foreignKeyName: "order_items_order_id_fkey"
            columns: ["order_id"]
            isOneToOne: false
            referencedRelation: "orders"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "order_items_product_id_fkey"
            columns: ["product_id"]
            isOneToOne: false
            referencedRelation: "products"
            referencedColumns: ["id"]
          },
        ]
      }
      orders: {
        Row: {
          created_at: string | null
          customer_details: Json | null
          customer_email: string
          id: string
          organization_id: string
          payment_id: string | null
          payment_method: string | null
          status: string | null
          total_amount: number
          user_id: string | null
        }
        Insert: {
          created_at?: string | null
          customer_details?: Json | null
          customer_email: string
          id?: string
          organization_id: string
          payment_id?: string | null
          payment_method?: string | null
          status?: string | null
          total_amount: number
          user_id?: string | null
        }
        Update: {
          created_at?: string | null
          customer_details?: Json | null
          customer_email?: string
          id?: string
          organization_id?: string
          payment_id?: string | null
          payment_method?: string | null
          status?: string | null
          total_amount?: number
          user_id?: string | null
        }
        Relationships: [
          {
            foreignKeyName: "orders_organization_id_fkey"
            columns: ["organization_id"]
            isOneToOne: false
            referencedRelation: "organizations"
            referencedColumns: ["id"]
          },
        ]
      }
      organizations: {
        Row: {
          branding_config: Json | null
          created_at: string | null
          domain: string | null
          id: string
          name: string
          plan: string | null
          slug: string
        }
        Insert: {
          branding_config?: Json | null
          created_at?: string | null
          domain?: string | null
          id?: string
          name: string
          plan?: string | null
          slug: string
        }
        Update: {
          branding_config?: Json | null
          created_at?: string | null
          domain?: string | null
          id?: string
          name?: string
          plan?: string | null
          slug?: string
        }
        Relationships: []
      }
      posts: {
        Row: {
          content_mdx: string | null
          cover_image: string | null
          created_at: string | null
          description: string | null
          id: string
          organization_id: string
          published: boolean | null
          published_at: string | null
          slug: string
          status: Database["public"]["Enums"]["post_status"] | null
          tags: string[] | null
          title: string
          updated_at: string | null
        }
        Insert: {
          content_mdx?: string | null
          cover_image?: string | null
          created_at?: string | null
          description?: string | null
          id?: string
          organization_id: string
          published?: boolean | null
          published_at?: string | null
          slug: string
          status?: Database["public"]["Enums"]["post_status"] | null
          tags?: string[] | null
          title: string
          updated_at?: string | null
        }
        Update: {
          content_mdx?: string | null
          cover_image?: string | null
          created_at?: string | null
          description?: string | null
          id?: string
          organization_id?: string
          published?: boolean | null
          published_at?: string | null
          slug?: string
          status?: Database["public"]["Enums"]["post_status"] | null
          tags?: string[] | null
          title?: string
          updated_at?: string | null
        }
        Relationships: [
          {
            foreignKeyName: "posts_organization_id_fkey"
            columns: ["organization_id"]
            isOneToOne: false
            referencedRelation: "organizations"
            referencedColumns: ["id"]
          },
        ]
      }
      products: {
        Row: {
          active: boolean | null
          created_at: string | null
          currency: string | null
          description: string | null
          id: string
          images: string[] | null
          metadata: Json | null
          name: string
          organization_id: string
          price: number
          slug: string
          stock: number | null
        }
        Insert: {
          active?: boolean | null
          created_at?: string | null
          currency?: string | null
          description?: string | null
          id?: string
          images?: string[] | null
          metadata?: Json | null
          name: string
          organization_id: string
          price?: number
          slug: string
          stock?: number | null
        }
        Update: {
          active?: boolean | null
          created_at?: string | null
          currency?: string | null
          description?: string | null
          id?: string
          images?: string[] | null
          metadata?: Json | null
          name?: string
          organization_id?: string
          price?: number
          slug?: string
          stock?: number | null
        }
        Relationships: [
          {
            foreignKeyName: "products_organization_id_fkey"
            columns: ["organization_id"]
            isOneToOne: false
            referencedRelation: "organizations"
            referencedColumns: ["id"]
          },
        ]
      }
      profiles: {
        Row: {
          avatar_url: string | null
          created_at: string | null
          email: string
          full_name: string | null
          id: string
          organization_id: string
          role: Database["public"]["Enums"]["user_role"] | null
          stripe_customer_id: string | null
          updated_at: string | null
        }
        Insert: {
          avatar_url?: string | null
          created_at?: string | null
          email: string
          full_name?: string | null
          id: string
          organization_id: string
          role?: Database["public"]["Enums"]["user_role"] | null
          stripe_customer_id?: string | null
          updated_at?: string | null
        }
        Update: {
          avatar_url?: string | null
          created_at?: string | null
          email?: string
          full_name?: string | null
          id?: string
          organization_id?: string
          role?: Database["public"]["Enums"]["user_role"] | null
          stripe_customer_id?: string | null
          updated_at?: string | null
        }
        Relationships: [
          {
            foreignKeyName: "profiles_organization_id_fkey"
            columns: ["organization_id"]
            isOneToOne: false
            referencedRelation: "organizations"
            referencedColumns: ["id"]
          },
        ]
      }
      projects: {
        Row: {
          branding_config: Json | null
          client_id: string
          created_at: string | null
          domain: string | null
          features_config: Json | null
          features_enabled: Json | null
          github_repo_url: string | null
          hosting_url: string | null
          id: string
          name: string
          organization_id: string | null
          repository_url: string | null
          status: Database["public"]["Enums"]["project_status"] | null
        }
        Insert: {
          branding_config?: Json | null
          client_id: string
          created_at?: string | null
          domain?: string | null
          features_config?: Json | null
          features_enabled?: Json | null
          github_repo_url?: string | null
          hosting_url?: string | null
          id?: string
          name: string
          organization_id?: string | null
          repository_url?: string | null
          status?: Database["public"]["Enums"]["project_status"] | null
        }
        Update: {
          branding_config?: Json | null
          client_id?: string
          created_at?: string | null
          domain?: string | null
          features_config?: Json | null
          features_enabled?: Json | null
          github_repo_url?: string | null
          hosting_url?: string | null
          id?: string
          name?: string
          organization_id?: string | null
          repository_url?: string | null
          status?: Database["public"]["Enums"]["project_status"] | null
        }
        Relationships: [
          {
            foreignKeyName: "projects_organization_id_fkey"
            columns: ["organization_id"]
            isOneToOne: false
            referencedRelation: "organizations"
            referencedColumns: ["id"]
          },
        ]
      }
      schedules: {
        Row: {
          created_at: string | null
          day_of_week: number
          end_time: string
          id: string
          is_active: boolean | null
          organization_id: string
          start_time: string
        }
        Insert: {
          created_at?: string | null
          day_of_week: number
          end_time: string
          id?: string
          is_active?: boolean | null
          organization_id: string
          start_time: string
        }
        Update: {
          created_at?: string | null
          day_of_week?: number
          end_time?: string
          id?: string
          is_active?: boolean | null
          organization_id?: string
          start_time?: string
        }
        Relationships: [
          {
            foreignKeyName: "schedules_organization_id_fkey"
            columns: ["organization_id"]
            isOneToOne: false
            referencedRelation: "organizations"
            referencedColumns: ["id"]
          },
        ]
      }
      services: {
        Row: {
          active: boolean | null
          created_at: string | null
          description: string | null
          duration_minutes: number | null
          form_schema: Json | null
          id: string
          organization_id: string
          price: number | null
          title: string
        }
        Insert: {
          active?: boolean | null
          created_at?: string | null
          description?: string | null
          duration_minutes?: number | null
          form_schema?: Json | null
          id?: string
          organization_id: string
          price?: number | null
          title: string
        }
        Update: {
          active?: boolean | null
          created_at?: string | null
          description?: string | null
          duration_minutes?: number | null
          form_schema?: Json | null
          id?: string
          organization_id?: string
          price?: number | null
          title?: string
        }
        Relationships: [
          {
            foreignKeyName: "services_organization_id_fkey"
            columns: ["organization_id"]
            isOneToOne: false
            referencedRelation: "organizations"
            referencedColumns: ["id"]
          },
        ]
      }
      web_audits: {
        Row: {
          created_at: string | null
          email: string | null
          id: string
          organization_id: string | null
          performance_score: number | null
          report_data: Json | null
          seo_score: number | null
          status: Database["public"]["Enums"]["audit_status"] | null
          url: string
          user_id: string | null
          visitor_id: string | null
        }
        Insert: {
          created_at?: string | null
          email?: string | null
          id?: string
          organization_id?: string | null
          performance_score?: number | null
          report_data?: Json | null
          seo_score?: number | null
          status?: Database["public"]["Enums"]["audit_status"] | null
          url: string
          user_id?: string | null
          visitor_id?: string | null
        }
        Update: {
          created_at?: string | null
          email?: string | null
          id?: string
          organization_id?: string | null
          performance_score?: number | null
          report_data?: Json | null
          seo_score?: number | null
          status?: Database["public"]["Enums"]["audit_status"] | null
          url?: string
          user_id?: string | null
          visitor_id?: string | null
        }
        Relationships: [
          {
            foreignKeyName: "web_audits_organization_id_fkey"
            columns: ["organization_id"]
            isOneToOne: false
            referencedRelation: "organizations"
            referencedColumns: ["id"]
          },
        ]
      }
    }
    Views: {
      [_ in never]: never
    }
    Functions: {
      decrement_stock: {
        Args: { p_product_id: string; p_quantity: number }
        Returns: undefined
      }
      get_my_org_id: { Args: never; Returns: string }
      get_my_org_ids: { Args: never; Returns: string[] }
      is_admin: { Args: never; Returns: boolean }
    }
    Enums: {
      audit_status: "processing" | "completed" | "failed"
      content_status: "queued" | "generating" | "review" | "published"
      post_status: "draft" | "published" | "archived"
      project_status: "pending" | "active" | "maintenance" | "archived"
      user_role: "admin" | "client" | "lead" | "staff"
    }
    CompositeTypes: {
      [_ in never]: never
    }
  }
}

type DatabaseWithoutInternals = Omit<Database, "__InternalSupabase">

type DefaultSchema = DatabaseWithoutInternals[Extract<keyof Database, "public">]

export type Tables<
  DefaultSchemaTableNameOrOptions extends
    | keyof (DefaultSchema["Tables"] & DefaultSchema["Views"])
    | { schema: keyof DatabaseWithoutInternals },
  TableName extends DefaultSchemaTableNameOrOptions extends {
    schema: keyof DatabaseWithoutInternals
  }
    ? keyof (DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Tables"] &
        DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Views"])
    : never = never,
> = DefaultSchemaTableNameOrOptions extends {
  schema: keyof DatabaseWithoutInternals
}
  ? (DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Tables"] &
      DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Views"])[TableName] extends {
      Row: infer R
    }
    ? R
    : never
  : DefaultSchemaTableNameOrOptions extends keyof (DefaultSchema["Tables"] &
        DefaultSchema["Views"])
    ? (DefaultSchema["Tables"] &
        DefaultSchema["Views"])[DefaultSchemaTableNameOrOptions] extends {
        Row: infer R
      }
      ? R
      : never
    : never

export type TablesInsert<
  DefaultSchemaTableNameOrOptions extends
    | keyof DefaultSchema["Tables"]
    | { schema: keyof DatabaseWithoutInternals },
  TableName extends DefaultSchemaTableNameOrOptions extends {
    schema: keyof DatabaseWithoutInternals
  }
    ? keyof DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Tables"]
    : never = never,
> = DefaultSchemaTableNameOrOptions extends {
  schema: keyof DatabaseWithoutInternals
}
  ? DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Tables"][TableName] extends {
      Insert: infer I
    }
    ? I
    : never
  : DefaultSchemaTableNameOrOptions extends keyof DefaultSchema["Tables"]
    ? DefaultSchema["Tables"][DefaultSchemaTableNameOrOptions] extends {
        Insert: infer I
      }
      ? I
      : never
    : never

export type TablesUpdate<
  DefaultSchemaTableNameOrOptions extends
    | keyof DefaultSchema["Tables"]
    | { schema: keyof DatabaseWithoutInternals },
  TableName extends DefaultSchemaTableNameOrOptions extends {
    schema: keyof DatabaseWithoutInternals
  }
    ? keyof DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Tables"]
    : never = never,
> = DefaultSchemaTableNameOrOptions extends {
  schema: keyof DatabaseWithoutInternals
}
  ? DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Tables"][TableName] extends {
      Update: infer U
    }
    ? U
    : never
  : DefaultSchemaTableNameOrOptions extends keyof DefaultSchema["Tables"]
    ? DefaultSchema["Tables"][DefaultSchemaTableNameOrOptions] extends {
        Update: infer U
      }
      ? U
      : never
    : never

export type Enums<
  DefaultSchemaEnumNameOrOptions extends
    | keyof DefaultSchema["Enums"]
    | { schema: keyof DatabaseWithoutInternals },
  EnumName extends DefaultSchemaEnumNameOrOptions extends {
    schema: keyof DatabaseWithoutInternals
  }
    ? keyof DatabaseWithoutInternals[DefaultSchemaEnumNameOrOptions["schema"]]["Enums"]
    : never = never,
> = DefaultSchemaEnumNameOrOptions extends {
  schema: keyof DatabaseWithoutInternals
}
  ? DatabaseWithoutInternals[DefaultSchemaEnumNameOrOptions["schema"]]["Enums"][EnumName]
  : DefaultSchemaEnumNameOrOptions extends keyof DefaultSchema["Enums"]
    ? DefaultSchema["Enums"][DefaultSchemaEnumNameOrOptions]
    : never

export type CompositeTypes<
  PublicCompositeTypeNameOrOptions extends
    | keyof DefaultSchema["CompositeTypes"]
    | { schema: keyof DatabaseWithoutInternals },
  CompositeTypeName extends PublicCompositeTypeNameOrOptions extends {
    schema: keyof DatabaseWithoutInternals
  }
    ? keyof DatabaseWithoutInternals[PublicCompositeTypeNameOrOptions["schema"]]["CompositeTypes"]
    : never = never,
> = PublicCompositeTypeNameOrOptions extends {
  schema: keyof DatabaseWithoutInternals
}
  ? DatabaseWithoutInternals[PublicCompositeTypeNameOrOptions["schema"]]["CompositeTypes"][CompositeTypeName]
  : PublicCompositeTypeNameOrOptions extends keyof DefaultSchema["CompositeTypes"]
    ? DefaultSchema["CompositeTypes"][PublicCompositeTypeNameOrOptions]
    : never

export const Constants = {
  public: {
    Enums: {
      audit_status: ["processing", "completed", "failed"],
      content_status: ["queued", "generating", "review", "published"],
      post_status: ["draft", "published", "archived"],
      project_status: ["pending", "active", "maintenance", "archived"],
      user_role: ["admin", "client", "lead", "staff"],
    },
  },
} as const


// =================== FILE: src/types/models.ts ===================

// PROJECTE: Master Template
// FITXER: src/types/models.ts

// ==========================================
// 1. Tipus de Seccions del Landing (VISUALS)
// ==========================================

export type SectionType =
  | 'hero'
  | 'services'
  | 'contact'
  | 'stats'
  | 'testimonials'
  | 'map'
  | 'faq'
  | 'cta_banner'
  | 'featured_products'
  | 'about';

// --- Base ---
export interface BaseSectionContent {
  title?: string;
  subtitle?: string;
}

// --- Hero ---
export interface HeroContent extends BaseSectionContent {
  ctaText?: string;
  companyName: string;
}

// --- Services (H√≠brid: DB + IA) ---
export interface ServiceContent extends BaseSectionContent {
  headlinePrefix?: string;
  headlineHighlight?: string;
  emptyState?: {
    title: string;
    text: string;
  };
  // ‚úÖ CLAU: Aix√≤ permet que la IA passi serveis de text quan no hi ha DB
  items?: Array<{
    title: string;
    description: string;
  }>;
}

// --- About ---
export interface AboutContent extends BaseSectionContent {
  badge?: string;
  description: string;
  imageUrl?: string;
  features?: string[];
  stats?: Array<{ label: string; value: string }>;
  card?: { title: string; subtitle: string };
}

// --- Contact ---
export interface ContactContent extends BaseSectionContent {
  description?: string;
  buttonText?: string;
  email?: string;
  phone?: string;
  address?: string;
}

// --- Stats ---
export interface StatsContent {
  items: Array<{ value: string; label: string }>;
}

// --- Testimonials ---
export interface TestimonialsContent extends BaseSectionContent {
  reviews: Array<{
    author: string;
    role: string;
    text: string;
    rating: number;
  }>;
}

// --- Map ---
export interface MapContent {
  title: string;
  address: string;
  embedUrl: string;
}

// --- FAQ ---
export interface FAQContent {
  title: string;
  subtitle?: string;
  items: Array<{ question: string; answer: string }>;
}

// --- CTA ---
export interface CTABannerContent {
  heading: string;
  subheading: string;
  buttonText: string;
  buttonLink: string;
  backgroundImage?: string;
}

// --- Featured Products ---
export interface FeaturedProductsContent {
  title: string;
  subtitle: string;
  limit?: number;
}

// üî• UNI√ì DISCRIMINADA
export type LandingSectionData =
  | { id: string; type: 'hero'; content: HeroContent }
  | { id: string; type: 'services'; content: ServiceContent }
  | { id: string; type: 'contact'; content: ContactContent }
  | { id: string; type: 'stats'; content: StatsContent }
  | { id: string; type: 'testimonials'; content: TestimonialsContent }
  | { id: string; type: 'map'; content: MapContent }
  | { id: string; type: 'faq'; content: FAQContent }
  | { id: string; type: 'cta_banner'; content: CTABannerContent }
  | { id: string; type: 'featured_products'; content: FeaturedProductsContent }
  | { id: string; type: 'about'; content: AboutContent };


// ==========================================
// 2. E-COMMERCE
// ==========================================

export interface Product {
  id: string;
  organization_id: string;
  slug: string;
  name: string;
  description: string | null;
  price: number;
  stock: number;
  active: boolean;
  images: string[];
  category_id?: string;
  created_at?: Date;
}

export interface CartItem {
  id: string;
  organization_id: string;
  name: string;
  price: number;
  stock: number;
  slug: string;
  image?: string;
  quantity: number;
}

export interface Order {
  id: string;
  organization_id: string;
  customer_email: string;
  total_amount: number;
  status: 'pending' | 'paid' | 'shipped' | 'cancelled';
  payment_method: string;
  created_at: Date;
}

export interface CreateOrderDTO {
  customer_email: string;
  customer_details: Record<string, unknown>;
  items: CartItem[];
  payment_method: 'stripe' | 'bank' | 'paypal';
}

export type CreateProductDTO = Omit<Product, 'id' | 'organization_id' | 'slug' | 'created_at'>;


// ==========================================
// 3. BOOKING & SERVEIS
// ==========================================

export interface FormField {
  key: string;
  label: string;
  type: 'text' | 'number' | 'email' | 'tel' | 'textarea';
  required: boolean;
  placeholder?: string;
}

// --- MODEL DE PRODUCTE / SERVEI (DB) ---
export interface ServiceDTO {
  id: string;
  
  // ‚úÖ OBLIGATORI: Un servei sempre pertany a una organitzaci√≥
  organization_id: string;

  title: string;
  description: string;
  price?: number;
  currency?: string;
  image_url?: string;
  
  // ‚úÖ CORREGIT: Unifiquem a duration_minutes
  duration_minutes?: number;

  // ‚úÖ AFEGIT QUE FALTAVA: Sense aix√≤, no pots fer 'active: true' al Service
  active: boolean; 
  
  // ‚úÖ Schema din√†mic
  form_schema?: FormField[];
}
// Alias
export type Service = ServiceDTO;

export interface Booking {
  id: string;
  organization_id: string;
  service_id: string;
  user_id: string | null;
  customer_name: string;
  customer_email: string;
  start_time: Date;
  end_time: Date;
  status: 'pending' | 'confirmed' | 'cancelled';
  created_at: Date;
  form_data?: Record<string, unknown>;

  services?: {
    title: string;
    duration_minutes?: number;
  } | null;
}

export interface BookingWithService extends Booking {
  services: {
    title: string;
    duration_minutes: number;
  };
}

export interface Schedule {
  id: string;
  day_of_week: number;
  start_time: string;
  end_time: string;
  is_active: boolean;
}

export type CreateServiceDTO = Omit<ServiceDTO, 'id' | 'created_at' | 'active' | 'organization_id'>;
export type CreateBookingDTO = Omit<Booking, 'id' | 'created_at' | 'services' | 'status'>;


// ==========================================
// 4. BLOG & POSTS
// ==========================================

export type PostStatus = 'draft' | 'published' | 'archived';

// Model DB
export interface BlogPost {
  id: string;
  organization_id: string;
  slug: string;
  title: string;
  description: string | null;
  content_mdx: string | null;
  cover_image: string | null;
  tags: string[];
  status: PostStatus;
  published_at: Date | null;
  created_at: Date;
  author_id?: string;
}

// Model App (DTO)
export interface BlogPostDTO {
  id: string;
  slug: string;
  title: string;
  description: string | null;
  content: string | null;      // UI 'content' -> DB 'content_mdx'
  coverImage: string | null;   // UI 'coverImage' -> DB 'cover_image'
  tags: string[];
  date: string | null;

  // Camps opcionals per Admin
  published: boolean;
  reviewed: boolean;
  status?: PostStatus;

  social_posts?: {
    id: string;
    platform: string;
    status: string;
    scheduledFor: string | null;
  }[];

  totalReactions?: number;
}

export type CreatePostDTO = {
  title: string;
  description: string;
  content: string;
  tags?: string[];
  status?: PostStatus;
  cover_image?: string;
};


// ==========================================
// 5. USUARIS & PERFILS
// ==========================================

export interface UserProfile {
  id: string;
  email: string;
  full_name: string | null;
  role: 'admin' | 'client' | 'lead';
  organization_id: string;
  avatar_url?: string | null;
  created_at: Date;
}

export type CreateProfileDTO = {
  id: string;
  email: string;
  full_name: string;
  organization_id: string;
  role?: 'client';
};


// ==========================================
// 6. EINES INTERNES
// ==========================================

export type AuditDTO = {
  id: string;
  url: string;
  status: 'processing' | 'completed' | 'failed';
  seoScore: number | null;
  performanceScore: number | null;
  createdAt: Date;
  reportData: Record<string, unknown> | null;
};

export type AnalyticsEventDTO = {
  event_name: string;
  path: string;
  session_id: string;
  duration?: number;
  referrer?: string;
  meta?: Record<string, unknown>;
  geo?: { country: string | null; city: string | null };
  device?: { type: string; browser: string; os: string };
};